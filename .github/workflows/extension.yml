name: Build Chrome Extension

on:
  push:
    branches: [main]
    paths:
      - 'extension/**'
  pull_request:
    branches: [main]
    paths:
      - 'extension/**'
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build:
    name: Build Extension
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from manifest
        id: version
        run: |
          version=$(cat extension/manifest.json | jq -r '.version')
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Validate manifest.json
        run: |
          if ! jq empty extension/manifest.json 2>/dev/null; then
            echo "Invalid manifest.json"
            exit 1
          fi
          echo "✅ manifest.json is valid"

      - name: Check required files
        run: |
          required_files=("manifest.json" "popup.html" "popup.js" "background.js")
          for file in "${required_files[@]}"; do
            if [ ! -f "extension/$file" ]; then
              echo "❌ Missing required file: $file"
              exit 1
            fi
          done
          echo "✅ All required files present"

      - name: Create extension package
        run: |
          cd extension
          zip -r ../proofi-extension-v${{ steps.version.outputs.version }}.zip . \
            -x "*.git*" \
            -x "*.DS_Store" \
            -x "*.map"

      - name: Upload extension artifact
        uses: actions/upload-artifact@v4
        with:
          name: proofi-extension-v${{ steps.version.outputs.version }}
          path: proofi-extension-v${{ steps.version.outputs.version }}.zip
          retention-days: 90

      - name: Upload to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: proofi-extension-v${{ steps.version.outputs.version }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  lint-extension:
    name: Lint Extension
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint extension files
        run: npx eslint extension/ --ext .js
        continue-on-error: true
