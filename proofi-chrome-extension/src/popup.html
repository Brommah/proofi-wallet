<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=380, initial-scale=1.0">
  <title>Proofi Wallet</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Space+Mono:wght@400;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="app">
    <!-- Loading state -->
    <div id="screen-loading" class="screen screen-center">
      <div class="loading-mark">
        <div class="loading-p">P</div>
      </div>
      <div class="text-label mt-4" style="color: var(--cyan);">INITIALIZING</div>
    </div>

    <!-- Login Screen -->
    <div id="screen-login" class="screen" style="display:none;">
      <div class="login-hero">
        <div class="text-label" style="color: var(--cyan); margin-bottom: 8px;">Data Ownership Protocol</div>
        <h1 class="text-display text-display-xl">PROOFI</h1>
        <p class="text-body text-muted" style="max-width: 280px; margin-top: 8px;">
          Self-custodial credentials verified on-chain. Your data, your keys, your proof.
        </p>
      </div>
      
      <!-- Email Step -->
      <div id="step-email" class="auth-card fade-in">
        <label class="text-label">Email Address</label>
        <input type="email" id="input-email" placeholder="you@example.com" class="input-brutal" autofocus>
        <div id="error-email" class="error-box" style="display:none;"></div>
        <button id="btn-send-otp" class="btn-primary" disabled>CONTINUE</button>
      </div>
      
      <!-- OTP Step -->
      <div id="step-otp" class="auth-card" style="display:none;">
        <div class="text-label">Verification Code</div>
        <p class="text-body-sm text-muted" style="margin: 4px 0 16px;">
          Sent to <span id="otp-email" class="text-mono text-white"></span>
        </p>
        <div id="otp-inputs" class="otp-container">
          <input type="text" maxlength="1" class="otp-digit" inputmode="numeric" pattern="[0-9]">
          <input type="text" maxlength="1" class="otp-digit" inputmode="numeric" pattern="[0-9]">
          <input type="text" maxlength="1" class="otp-digit" inputmode="numeric" pattern="[0-9]">
          <input type="text" maxlength="1" class="otp-digit" inputmode="numeric" pattern="[0-9]">
          <input type="text" maxlength="1" class="otp-digit" inputmode="numeric" pattern="[0-9]">
          <input type="text" maxlength="1" class="otp-digit" inputmode="numeric" pattern="[0-9]">
        </div>
        <div id="error-otp" class="error-box" style="display:none;"></div>
        <div id="loading-otp" class="loading-indicator" style="display:none;">
          <div class="spinner"></div>
          <span class="text-mono text-sm" style="color: var(--cyan);">VERIFYING</span>
        </div>
        <button id="btn-back-email" class="btn-secondary">‚Üê DIFFERENT EMAIL</button>
      </div>
      
      <!-- PIN Step -->
      <div id="step-pin" class="auth-card" style="display:none;">
        <div class="text-label" id="pin-title">Create Your PIN</div>
        <p class="text-body-sm text-muted" id="pin-subtitle" style="margin: 4px 0 16px;">
          This PIN derives your wallet keys. Remember it ‚Äî it cannot be recovered.
        </p>
        <input type="password" id="input-pin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="8" inputmode="numeric" pattern="[0-9]*" class="input-brutal input-pin" autocomplete="off">
        <div class="pin-dots" id="pin-dots">
          <div class="pin-dot"></div>
          <div class="pin-dot"></div>
          <div class="pin-dot"></div>
          <div class="pin-dot"></div>
          <div class="pin-dot"></div>
          <div class="pin-dot"></div>
        </div>
        <div id="error-pin" class="error-box" style="display:none;"></div>
        <div id="loading-pin" class="loading-indicator" style="display:none;">
          <div class="spinner"></div>
          <span class="text-mono text-sm" style="color: var(--cyan);">DERIVING KEYS</span>
        </div>
        <button id="btn-setup-pin" class="btn-primary" disabled>CREATE WALLET</button>
      </div>
      
      <!-- Feature blocks -->
      <div class="features-grid">
        <div class="feature-block feature-accent">
          <div class="text-label" style="font-size: 0.5rem;">CUSTODY</div>
          <div class="text-display" style="font-size: 1.1rem; color: var(--cyan);">SELF</div>
        </div>
        <div class="feature-block">
          <div class="text-label" style="font-size: 0.5rem;">NETWORK</div>
          <div class="text-display" style="font-size: 1.1rem;">CERE</div>
        </div>
        <div class="feature-block">
          <div class="text-label" style="font-size: 0.5rem;">STORAGE</div>
          <div class="text-display" style="font-size: 1.1rem;">DDC</div>
        </div>
      </div>
      
      <div class="footer-line">
        <p class="text-label" style="color: var(--ash); text-align: center;">Your keys never leave your device</p>
      </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="screen-dashboard" class="screen" style="display:none;">
      <!-- Header -->
      <div class="dash-header">
        <div class="dash-header-top">
          <div>
            <div class="text-label" style="color: var(--cyan); margin-bottom: 4px;">PROOFI WALLET</div>
            <div id="dash-email" class="text-mono text-xs text-muted"></div>
          </div>
          <div class="status-badge" id="status-badge">
            <div class="status-dot online"></div>
            <span class="text-mono text-xs">CONNECTED</span>
          </div>
        </div>
        
        <!-- Address -->
        <div class="address-card" id="address-card">
          <div class="address-card-header">
            <div class="text-label">ADDRESS</div>
            <button id="btn-copy-address" class="btn-ghost text-mono text-xs">COPY</button>
          </div>
          <div id="dash-address" class="text-mono text-xs text-muted" style="word-break: break-all;"></div>
        </div>
      </div>
      
      <!-- Quick Actions -->
      <div class="action-grid">
        <button id="btn-store-memo" class="action-card action-cyan">
          <div class="action-icon">üìù</div>
          <div class="text-display text-xs">STORE MEMO</div>
        </button>
        <button id="btn-store-cred" class="action-card action-green">
          <div class="action-icon">üîê</div>
          <div class="text-display text-xs">CREDENTIAL</div>
        </button>
        <button id="btn-health-data" class="action-card action-purple">
          <div class="action-icon">üè•</div>
          <div class="text-display text-xs">HEALTH DATA</div>
        </button>
        <button id="btn-agents" class="action-card action-orange">
          <div class="action-icon">ü§ñ</div>
          <div class="text-display text-xs">AGENTS</div>
        </button>
      </div>
      
      <!-- Stored Items -->
      <div class="section">
        <div class="section-header">
          <h2 class="text-display" style="font-size: 1rem;">STORED DATA</h2>
          <button id="btn-refresh" class="btn-ghost text-mono text-xs" style="color: var(--ash);">‚Üª REFRESH</button>
        </div>
        <div id="items-list" class="items-list">
          <div class="empty-state">
            <div class="text-display" style="font-size: 2rem; color: var(--steel);">‚àÖ</div>
            <p class="text-body-sm text-muted">No data stored yet</p>
          </div>
        </div>
      </div>
      
      <!-- Wallet Lock / Settings -->
      <div class="dash-footer">
        <div class="dash-status-row">
          <div class="dash-status-item">
            <div class="text-label">STATUS</div>
            <div class="status-value">
              <div id="lock-dot" class="status-square warn"></div>
              <span id="lock-status" class="text-mono text-sm">LOCKED</span>
            </div>
          </div>
          <div class="dash-status-item">
            <div class="text-label">NETWORK</div>
            <div class="text-mono text-sm" style="color: var(--cyan);">MAINNET</div>
          </div>
        </div>
        
        <button id="btn-unlock" class="btn-secondary btn-full" style="display:none;">üîì UNLOCK WITH PIN</button>
        <button id="btn-disconnect" class="btn-danger btn-full">DISCONNECT</button>
      </div>
    </div>

    <!-- Store Memo Screen -->
    <div id="screen-memo" class="screen" style="display:none;">
      <div class="screen-header">
        <button id="btn-memo-back" class="btn-ghost text-mono text-xs text-muted">‚Üê BACK</button>
        <h1 class="text-display text-display-sm">STORE MEMO</h1>
        <p class="text-body-sm text-muted" style="margin-top: 4px;">Encrypted on Cere DDC ‚Äî decentralized & permanent</p>
      </div>
      <div class="form-section">
        <label class="text-label">Your Data</label>
        <textarea id="input-memo" placeholder="Enter text to store on-chain..." rows="6" class="input-brutal input-textarea"></textarea>
        <div id="error-memo" class="error-box" style="display:none;"></div>
        <div id="success-memo" class="success-box" style="display:none;"></div>
        <button id="btn-submit-memo" class="btn-primary btn-full" disabled>STORE ON DDC</button>
      </div>
      
      <!-- PIN unlock for signing -->
      <div id="memo-pin-unlock" class="pin-unlock-section" style="display:none;">
        <div class="text-label" style="margin-bottom: 8px;">Enter PIN to sign</div>
        <input type="password" id="memo-pin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="8" inputmode="numeric" class="input-brutal input-pin" autocomplete="off">
        <button id="btn-memo-unlock" class="btn-primary btn-full">UNLOCK & STORE</button>
      </div>
    </div>

    <!-- Store Credential Screen -->
    <div id="screen-credential" class="screen" style="display:none;">
      <div class="screen-header">
        <button id="btn-cred-back" class="btn-ghost text-mono text-xs text-muted">‚Üê BACK</button>
        <h1 class="text-display text-display-sm">ISSUE CREDENTIAL</h1>
        <p class="text-body-sm text-muted" style="margin-top: 4px;">Self-issued verifiable credential on DDC</p>
      </div>
      <div class="form-section">
        <label class="text-label">Credential Type</label>
        <select id="input-cred-type" class="input-brutal input-select">
          <option value="ProofOfIdentity">Proof of Identity</option>
          <option value="ProofOfOwnership">Proof of Ownership</option>
          <option value="ProofOfMembership">Proof of Membership</option>
          <option value="ProofOfCompletion">Proof of Completion</option>
          <option value="Custom">Custom</option>
        </select>
        
        <label class="text-label" style="margin-top: 16px;">Claim Data</label>
        <textarea id="input-cred-data" placeholder='{"name": "...", "role": "..."}' rows="5" class="input-brutal input-textarea text-mono"></textarea>
        <div id="error-cred" class="error-box" style="display:none;"></div>
        <div id="success-cred" class="success-box" style="display:none;"></div>
        <button id="btn-submit-cred" class="btn-primary btn-full" disabled>ISSUE CREDENTIAL</button>
      </div>
      
      <!-- PIN unlock for signing -->
      <div id="cred-pin-unlock" class="pin-unlock-section" style="display:none;">
        <div class="text-label" style="margin-bottom: 8px;">Enter PIN to sign</div>
        <input type="password" id="cred-pin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="8" inputmode="numeric" class="input-brutal input-pin" autocomplete="off">
        <button id="btn-cred-unlock" class="btn-primary btn-full">UNLOCK & ISSUE</button>
      </div>
    </div>
  </div>

    <!-- Health Data Screen -->
    <div id="screen-health" class="screen" style="display:none;">
      <div class="screen-header">
        <button id="btn-health-back" class="btn-ghost text-mono text-xs text-muted">‚Üê BACK</button>
        <h1 class="text-display text-display-sm">HEALTH DATA</h1>
        <p class="text-body-sm text-muted" style="margin-top: 4px;">Import and manage your health records</p>
      </div>
      
      <!-- Health Data Summary -->
      <div id="health-summary" class="health-summary" style="display:none;">
        <div class="text-label" style="margin-bottom: 12px;">YOUR DATA</div>
        <div class="health-stats-grid" id="health-stats-grid">
          <!-- Populated by JS -->
        </div>
        <div class="health-sync-status" id="health-sync-status">
          <span class="sync-dot offline"></span>
          <span class="text-mono text-xs">NOT SYNCED TO DDC</span>
        </div>
      </div>
      
      <!-- Import Section -->
      <div class="form-section">
        <label class="text-label">IMPORT HEALTH DATA</label>
        <p class="text-body-sm text-muted" style="margin: 4px 0 12px;">
          Upload your Apple Health export (export.xml) or use sample data
        </p>
        
        <div class="import-options">
          <label for="health-file-input" class="btn-secondary btn-full" style="cursor: pointer; text-align: center;">
            üìÇ CHOOSE FILE
          </label>
          <input type="file" id="health-file-input" accept=".xml,.zip" style="display:none;">
          
          <button id="btn-load-sample" class="btn-secondary btn-full" style="margin-top: 8px;">
            üß™ LOAD SAMPLE DATA
          </button>
        </div>
        
        <div id="health-import-progress" class="loading-indicator" style="display:none; margin-top: 12px;">
          <div class="spinner"></div>
          <span class="text-mono text-sm" style="color: var(--cyan);">PARSING...</span>
        </div>
        
        <div id="error-health" class="error-box" style="display:none;"></div>
        <div id="success-health" class="success-box" style="display:none;"></div>
      </div>
      
      <!-- Sync to DDC -->
      <div id="health-sync-section" class="form-section" style="display:none; margin-top: 16px;">
        <label class="text-label">SYNC TO DDC</label>
        <p class="text-body-sm text-muted" style="margin: 4px 0 12px;">
          Encrypt your health data and store on Cere DDC
        </p>
        
        <button id="btn-sync-ddc" class="btn-primary btn-full">
          üîê ENCRYPT & SYNC TO DDC
        </button>
        
        <div id="sync-progress" class="loading-indicator" style="display:none; margin-top: 12px;">
          <div class="spinner"></div>
          <span class="text-mono text-sm" style="color: var(--cyan);">ENCRYPTING & UPLOADING...</span>
        </div>
        
        <div id="sync-result" style="display:none; margin-top: 12px;">
          <div class="kv-grid">
            <div class="kv-item">
              <div class="kv-content">
                <div class="kv-key">CID</div>
                <div class="kv-value text-mono text-xs" id="health-cid"></div>
              </div>
            </div>
            <div class="kv-item">
              <div class="kv-content">
                <div class="kv-key">Bucket</div>
                <div class="kv-value text-mono text-xs" id="health-bucket"></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- PIN unlock for encryption -->
        <div id="health-pin-unlock" class="pin-unlock-section" style="display:none;">
          <div class="text-label" style="margin-bottom: 8px;">Enter PIN to encrypt</div>
          <input type="password" id="health-pin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="8" inputmode="numeric" class="input-brutal input-pin" autocomplete="off">
          <button id="btn-health-unlock" class="btn-primary btn-full">UNLOCK & SYNC</button>
        </div>
      </div>
    </div>

    <!-- Agents Screen -->
    <div id="screen-agents" class="screen" style="display:none;">
      <div class="screen-header">
        <button id="btn-agents-back" class="btn-ghost text-mono text-xs text-muted">‚Üê BACK</button>
        <h1 class="text-display text-display-sm">CONNECTED AGENTS</h1>
        <p class="text-body-sm text-muted" style="margin-top: 4px;">Apps authorized to access your data</p>
      </div>
      
      <!-- Pending Access Request -->
      <div id="pending-request" class="pending-request-card" style="display:none;">
        <div class="text-label" style="color: var(--yellow); margin-bottom: 8px;">‚ö†Ô∏è PENDING REQUEST</div>
        <div class="agent-request-info">
          <div class="agent-name text-display text-sm" id="pending-agent-name"></div>
          <div class="text-body-sm text-muted" id="pending-agent-origin"></div>
        </div>
        <div class="requested-scopes" id="pending-scopes">
          <!-- Populated by JS -->
        </div>
        <div class="request-actions" style="margin-top: 12px; display: flex; gap: 8px;">
          <button id="btn-deny-agent" class="btn-secondary" style="flex: 1;">DENY</button>
          <button id="btn-approve-agent" class="btn-primary" style="flex: 1;">APPROVE</button>
        </div>
      </div>
      
      <!-- Connected Agents List -->
      <div id="agents-list" class="agents-list">
        <div class="empty-state">
          <div class="text-display" style="font-size: 2rem; color: var(--steel);">ü§ñ</div>
          <p class="text-body-sm text-muted">No agents connected</p>
        </div>
      </div>
    </div>

    <!-- Agent Approval Modal -->
    <div id="agent-approval-modal" class="modal-overlay" style="display:none;">
      <div class="modal-card">
        <div class="text-label" style="color: var(--cyan);">DATA ACCESS REQUEST</div>
        <h2 class="text-display" style="margin: 8px 0;" id="modal-agent-name"></h2>
        <p class="text-body-sm text-muted" id="modal-agent-origin"></p>
        
        <div class="modal-section" style="margin-top: 16px;">
          <div class="text-label" style="margin-bottom: 8px;">REQUESTING ACCESS TO:</div>
          <div class="scope-list" id="modal-scopes">
            <!-- Populated by JS -->
          </div>
        </div>
        
        <div class="modal-section" style="margin-top: 16px;">
          <div class="text-label" style="margin-bottom: 8px;">ACCESS DURATION</div>
          <div class="expiry-options">
            <label class="expiry-option">
              <input type="radio" name="modal-expiry" value="3600">
              <span class="expiry-btn">1 HOUR</span>
            </label>
            <label class="expiry-option">
              <input type="radio" name="modal-expiry" value="86400" checked>
              <span class="expiry-btn selected">24 HOURS</span>
            </label>
            <label class="expiry-option">
              <input type="radio" name="modal-expiry" value="604800">
              <span class="expiry-btn">7 DAYS</span>
            </label>
          </div>
        </div>
        
        <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 8px;">
          <button id="modal-btn-deny" class="btn-secondary" style="flex: 1;">DENY</button>
          <button id="modal-btn-approve" class="btn-primary" style="flex: 1;">GRANT ACCESS</button>
        </div>
      </div>
    </div>
  </div>

  <script src="popup.js" type="module"></script>
  <script src="agents-ui.js"></script>
</body>
</html>
