<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' 'wasm-unsafe-eval' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src 'self' https://proofi-api-production.up.railway.app https://*.cere.network wss://*.cere.network https://cdn.ddc-dragon.com https://cdn.cere.network http://localhost:*; img-src 'self' data: blob:;">
  <title>Proofi â€” Health Data Analysis</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='8' fill='%231d1d1f'/%3E%3Ccircle cx='16' cy='16' r='8' fill='none' stroke='%23fff' stroke-width='2'/%3E%3C/svg%3E">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #f5f5f7;
      --bg-alt: #ffffff;
      --surface: #ffffff;
      --text: #1d1d1f;
      --text-secondary: #86868b;
      --text-tertiary: #aeaeb2;
      --border: rgba(0,0,0,0.06);
      --border-subtle: rgba(0,0,0,0.04);
      --accent: #1d1d1f;
      --accent-light: #424245;
      --success: #34c759;
      --warning: #ff9500;
      --error: #ff3b30;
      --blue: #007aff;
      --font: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', sans-serif;
      --mono: 'SF Mono', SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --radius: 16px;
      --radius-sm: 12px;
      --shadow: 0 2px 8px rgba(0,0,0,0.04);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.06);
    }

    :focus-visible {
      outline: 2px solid var(--blue);
      outline-offset: 2px;
    }

    .skip-to-content {
      position: absolute;
      top: -100%;
      left: 16px;
      z-index: 999;
      padding: 12px 24px;
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      text-decoration: none;
      border-radius: 980px;
    }
    .skip-to-content:focus { top: 16px; }
    
    html { scroll-behavior: smooth; }
    
    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font);
      min-height: 100vh;
      line-height: 1.5;
      font-size: 17px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* ===== NAV ===== */
    nav {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(255,255,255,0.72);
      backdrop-filter: saturate(180%) blur(20px);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      border-bottom: 1px solid var(--border);
    }
    .nav-inner {
      max-width: 980px;
      margin: 0 auto;
      padding: 0 22px;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .nav-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .nav-logo {
      font-size: 21px;
      font-weight: 600;
      text-decoration: none;
      color: var(--text);
      letter-spacing: -0.02em;
    }
    .nav-badge {
      font-size: 12px;
      padding: 5px 12px;
      background: var(--bg);
      color: var(--text-secondary);
      border-radius: 980px;
      font-weight: 500;
      letter-spacing: 0.01em;
    }
    .nav-badge.offline {
      background: rgba(255,149,0,0.12);
      color: var(--warning);
    }
    .wallet-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    .wallet-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-tertiary);
    }
    .wallet-dot.connected { background: var(--success); }
    .wallet-addr {
      font-family: var(--mono);
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    /* ===== DDC STATUS BANNER ===== */
    .ddc-banner {
      background: rgba(52,199,89,0.08);
      padding: 12px 22px;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: var(--text-secondary);
    }
    .ddc-banner.offline {
      background: rgba(255,149,0,0.08);
    }
    .ddc-banner.error {
      background: rgba(255,59,48,0.08);
    }
    .ddc-banner .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
    }
    .ddc-banner.offline .status-dot { background: var(--warning); }
    .ddc-banner.error .status-dot { background: var(--error); }
    
    /* ===== MAIN ===== */
    main {
      max-width: 980px;
      margin: 0 auto;
      padding: 60px 22px 120px;
    }
    
    /* ===== HERO ===== */
    .hero {
      text-align: center;
      margin-bottom: 80px;
      padding: 20px 0 0;
    }
    .hero h1 {
      font-size: clamp(40px, 6vw, 56px);
      font-weight: 700;
      letter-spacing: -0.025em;
      margin-bottom: 16px;
      line-height: 1.1;
      color: var(--text);
    }
    .hero p {
      color: var(--text-secondary);
      font-size: 19px;
      max-width: 600px;
      margin: 0 auto;
      line-height: 1.5;
      font-weight: 400;
    }
    
    /* ===== PROGRESS BAR ===== */
    .progress-bar {
      position: sticky;
      top: 52px;
      z-index: 99;
      background: rgba(255,255,255,0.88);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 20px 22px 36px;
    }
    .progress-bar-inner {
      max-width: 700px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
    }
    .progress-bar-inner::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 24px;
      right: 24px;
      height: 1px;
      background: var(--border);
      transform: translateY(-50%);
      z-index: 0;
    }
    .progress-line {
      position: absolute;
      top: 50%;
      left: 24px;
      height: 1px;
      background: var(--accent);
      transform: translateY(-50%);
      z-index: 1;
      transition: width 0.6s ease-out;
      width: 0%;
    }
    .progress-node {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--surface);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
      z-index: 2;
      position: relative;
      transition: all 0.3s ease-out;
      cursor: pointer;
      color: var(--text-secondary);
    }
    .progress-node.active {
      border-color: var(--accent);
      background: var(--surface);
      color: var(--text);
    }
    .progress-node.completed {
      border-color: var(--accent);
      background: var(--accent);
      color: #fff;
    }
    .progress-node-label {
      position: absolute;
      top: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: var(--text-tertiary);
      white-space: nowrap;
      font-weight: 500;
      letter-spacing: 0.02em;
    }
    .progress-node.active .progress-node-label,
    .progress-node.completed .progress-node-label {
      color: var(--text-secondary);
    }

    /* ===== STEPS ===== */
    .steps {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .step {
      background: var(--surface);
      border-radius: var(--radius);
      overflow: hidden;
      transition: box-shadow 0.3s ease-out;
      box-shadow: var(--shadow);
    }
    .step.active {
      box-shadow: var(--shadow-md);
    }
    .step.completed {
      opacity: 0.92;
    }
    
    .step-header {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 24px 28px;
      cursor: pointer;
      transition: background 0.2s ease-out;
    }
    .step-header:hover {
      background: rgba(0,0,0,0.015);
    }
    
    .step-num {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      font-weight: 600;
      flex-shrink: 0;
      color: var(--text-secondary);
      transition: all 0.2s ease-out;
    }
    .step.completed .step-num {
      background: var(--accent);
      color: #fff;
    }
    .step.completed .step-num::after {
      content: 'âœ“';
      font-size: 14px;
    }
    .step.completed .step-num span { display: none; }
    
    .step-info { flex: 1; }
    .step-title {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 3px;
      color: var(--text);
      letter-spacing: -0.01em;
    }
    .step-desc {
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .step-status {
      font-size: 12px;
      padding: 6px 14px;
      border-radius: 980px;
      background: var(--bg);
      color: var(--text-secondary);
      font-weight: 500;
    }
    .step.completed .step-status {
      background: var(--accent);
      color: #fff;
    }
    .step.active .step-status {
      background: var(--blue);
      color: #fff;
    }
    
    .step-body {
      padding: 0 28px 28px;
      display: none;
    }
    .step.active .step-body,
    .step.expanded .step-body { display: block; }
    
    /* ===== FORM ELEMENTS ===== */
    .form-group {
      margin-bottom: 24px;
    }
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--text-secondary);
      letter-spacing: 0.01em;
    }
    .form-input {
      width: 100%;
      padding: 14px 18px;
      background: var(--bg);
      border: none;
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: var(--mono);
      font-size: 14px;
      outline: none;
      transition: box-shadow 0.2s ease-out;
    }
    .form-input:focus {
      box-shadow: 0 0 0 4px rgba(0,122,255,0.15);
    }
    .form-input::placeholder { color: var(--text-tertiary); }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 28px;
      font-family: var(--font);
      font-size: 15px;
      font-weight: 500;
      border: none;
      border-radius: 980px;
      cursor: pointer;
      transition: all 0.2s ease-out;
      text-decoration: none;
    }
    .btn-primary {
      background: var(--accent);
      color: #fff;
    }
    .btn-primary:hover {
      background: var(--accent-light);
    }
    .btn-primary:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: transparent;
      color: var(--blue);
      border: 1px solid rgba(0,0,0,0.12);
    }
    .btn-secondary:hover {
      background: rgba(0,0,0,0.03);
    }
    
    .btn-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    /* ===== DATA DISPLAY ===== */
    .data-box {
      background: var(--bg);
      border-radius: var(--radius-sm);
      padding: 18px;
      margin-bottom: 20px;
      font-family: var(--mono);
      font-size: 12px;
      overflow-x: auto;
      max-height: 280px;
      overflow-y: auto;
      color: var(--text-secondary);
    }
    .data-box pre {
      white-space: pre-wrap;
      word-break: break-all;
    }
    .data-box.scrollable {
      max-height: 360px;
    }
    
    .data-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .data-label span {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
    }
    .data-label .copy-btn {
      font-size: 12px;
      padding: 6px 12px;
      background: var(--bg);
      border: none;
      border-radius: 980px;
      color: var(--text-secondary);
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease-out;
    }
    .data-label .copy-btn:hover {
      background: var(--accent);
      color: #fff;
    }
    
    /* ===== KEY VALUE PAIRS ===== */
    .kv-grid {
      display: grid;
      gap: 1px;
      background: var(--border);
      border-radius: var(--radius-sm);
      overflow: hidden;
    }
    .kv-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 16px 20px;
      background: var(--bg);
    }
    .kv-icon { display: none; }
    .kv-content { flex: 1; min-width: 0; }
    .kv-key {
      font-size: 12px;
      color: var(--text-tertiary);
      margin-bottom: 4px;
      letter-spacing: 0.01em;
    }
    .kv-value {
      font-family: var(--mono);
      font-size: 13px;
      word-break: break-all;
      color: var(--text);
    }
    .kv-value.success { color: var(--success); }
    .kv-value.pending { color: var(--warning); }
    .kv-value.ddc { color: var(--blue); }
    
    /* ===== LOADING ===== */
    .loading {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 20px;
      background: var(--bg);
      border-radius: var(--radius-sm);
      margin-bottom: 20px;
      font-size: 15px;
      color: var(--text-secondary);
    }
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* ===== TOGGLE SWITCH ===== */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 26px;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--border);
      transition: 0.3s;
      border-radius: 26px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }
    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--accent);
    }
    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(22px);
    }
    
    /* ===== SCOPE EDITOR ===== */
    .scope-grid {
      display: grid;
      gap: 10px;
      margin-bottom: 24px;
    }
    .scope-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 18px 20px;
      background: var(--bg);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s ease-out;
    }
    .scope-item:hover {
      background: rgba(0,0,0,0.04);
    }
    .scope-item.selected {
      background: rgba(0,122,255,0.08);
    }
    .scope-check {
      width: 22px;
      height: 22px;
      border: 2px solid var(--border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      flex-shrink: 0;
      transition: all 0.2s ease-out;
      color: transparent;
    }
    .scope-item.selected .scope-check {
      background: var(--blue);
      border-color: var(--blue);
      color: #fff;
    }
    .scope-icon { display: none; }
    .scope-info { flex: 1; }
    .scope-path {
      font-family: var(--mono);
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
    }
    .scope-perms {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 2px;
    }
    
    /* ===== ANALYSIS RESULTS ===== */
    .analysis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 32px;
    }
    .analysis-card {
      background: var(--bg);
      border-radius: var(--radius-sm);
      padding: 24px 20px;
      text-align: center;
    }
    .analysis-value {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 4px;
      letter-spacing: -0.02em;
      color: var(--text);
    }
    .analysis-value.good { color: var(--success); }
    .analysis-value.warning { color: var(--warning); }
    .analysis-value.bad { color: var(--error); }
    .analysis-label {
      font-size: 12px;
      color: var(--text-secondary);
      letter-spacing: 0.01em;
    }
    
    /* ===== AUDIT LOG ===== */
    .audit-log {
      border-radius: var(--radius-sm);
      overflow: hidden;
      background: var(--bg);
    }
    .audit-entry {
      display: flex;
      gap: 16px;
      padding: 16px 20px;
      font-size: 14px;
      border-bottom: 1px solid var(--border-subtle);
    }
    .audit-entry:last-child { border-bottom: none; }
    .audit-time {
      font-family: var(--mono);
      color: var(--text-tertiary);
      flex-shrink: 0;
      width: 80px;
      font-size: 12px;
    }
    .audit-action {
      flex: 1;
      color: var(--text);
    }
    .audit-hash {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-tertiary);
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* ===== VERIFICATION ===== */
    .verify-section {
      margin-top: 32px;
      padding: 28px;
      background: var(--bg);
      border-radius: var(--radius-sm);
    }
    .verify-section h4 {
      font-size: 15px;
      margin-bottom: 20px;
      font-weight: 600;
      color: var(--text);
    }
    .verify-grid {
      display: grid;
      gap: 12px;
    }
    .verify-item {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
    }
    .verify-icon { display: none; }
    .verify-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .verify-dot.pass { background: var(--success); }
    .verify-dot.fail { background: var(--error); }
    .verify-dot.warn { background: var(--warning); }
    .verify-dot.pending { background: var(--text-tertiary); }
    .verify-label { color: var(--text-secondary); }
    .verify-value {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text);
    }
    
    /* ===== TRUST CHAIN ===== */
    .trust-chain {
      background: var(--bg);
      border-radius: var(--radius-sm);
      padding: 28px;
      margin-bottom: 32px;
      overflow-x: auto;
    }
    .trust-chain-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--text-secondary);
      letter-spacing: 0.02em;
    }
    .trust-chain-flow {
      display: flex;
      align-items: center;
      gap: 0;
      font-family: var(--mono);
      font-size: 11px;
      min-width: 680px;
    }
    .trust-chain-node {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 16px 18px;
      background: var(--surface);
      border-radius: var(--radius-sm);
      min-width: 110px;
      text-align: center;
      box-shadow: var(--shadow);
    }
    .trust-chain-node .tc-icon { display: none; }
    .trust-chain-node .tc-label {
      font-weight: 600;
      color: var(--text);
      font-size: 11px;
      letter-spacing: 0.02em;
    }
    .trust-chain-node .tc-detail {
      color: var(--text-secondary);
      font-size: 10px;
      word-break: break-all;
    }
    .trust-chain-arrow {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 0 12px;
      color: var(--text-tertiary);
      flex-shrink: 0;
    }
    .trust-chain-arrow .tc-arrow-line {
      font-size: 16px;
      color: var(--text-tertiary);
    }
    .trust-chain-arrow .tc-arrow-label {
      font-size: 9px;
      color: var(--text-tertiary);
      letter-spacing: 0.02em;
    }

    /* ===== CONSOLE ===== */
    .console-toggle {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 22px;
      background: var(--surface);
      border: none;
      border-radius: 980px;
      color: var(--text);
      cursor: pointer;
      font-family: var(--font);
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 50;
      box-shadow: var(--shadow-md);
      transition: all 0.2s ease-out;
    }
    .console-toggle:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    
    .console-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 320px;
      background: var(--surface);
      border-top: 1px solid var(--border);
      transform: translateY(100%);
      transition: transform 0.3s ease-out;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }
    .console-panel.open { transform: translateY(0); }
    
    .console-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
    }
    .console-header h4 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }
    .console-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 20px;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .console-close:hover { color: var(--text); }
    
    .console-body {
      flex: 1;
      overflow: auto;
      padding: 20px 24px;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.9;
      background: var(--bg);
    }
    .console-line { margin-bottom: 4px; }
    .console-line.info { color: var(--text-secondary); }
    .console-line.success { color: var(--success); }
    .console-line.error { color: var(--error); }
    .console-line.crypto { color: #af52de; }
    .console-line.ddc { color: var(--blue); }
    .console-line.warn { color: var(--warning); }
    .console-time {
      color: var(--text-tertiary);
      margin-right: 10px;
    }
    
    /* ===== REVOCATION ===== */
    .revoke-btn {
      background: transparent;
      color: var(--error);
      border: 1px solid var(--error);
      padding: 10px 20px;
      border-radius: 980px;
      font-family: var(--font);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      margin-top: 16px;
      display: none;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease-out;
    }
    .revoke-btn:hover {
      background: rgba(255,59,48,0.08);
    }
    .revoke-btn.revoked {
      background: rgba(255,59,48,0.08);
      cursor: default;
      opacity: 0.6;
    }
    .revocation-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 12px;
      border-radius: 980px;
      font-size: 12px;
      font-weight: 600;
      font-family: var(--mono);
    }
    .revocation-status.active {
      background: rgba(52,199,89,0.12);
      color: var(--success);
    }
    .revocation-status.revoked {
      background: rgba(255,59,48,0.12);
      color: var(--error);
    }

    /* ===== PUBLIC VERIFIER ===== */
    .verifier-section {
      max-width: 980px;
      margin: 60px auto 80px;
      padding: 0 22px;
    }
    .verifier-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 40px;
      box-shadow: var(--shadow);
    }
    .verifier-card h2 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }
    .verifier-card p {
      color: var(--text-secondary);
      font-size: 15px;
      margin-bottom: 28px;
    }
    .verifier-input-group {
      display: flex;
      gap: 12px;
      margin-bottom: 28px;
    }
    .verifier-input {
      flex: 1;
      padding: 14px 18px;
      background: var(--bg);
      border: none;
      border-radius: var(--radius-sm);
      color: var(--text);
      font-family: var(--mono);
      font-size: 14px;
    }
    .verifier-input:focus {
      outline: none;
      box-shadow: 0 0 0 4px rgba(0,122,255,0.15);
    }
    .verifier-result {
      display: none;
      padding: 24px;
      background: var(--bg);
      border-radius: var(--radius-sm);
    }
    .verifier-result.visible { display: block; }
    .verifier-result .vr-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .verifier-result .vr-status {
      font-size: 16px;
      font-weight: 600;
    }
    .verifier-result .vr-status.verified { color: var(--success); }
    .verifier-result .vr-status.not-found { color: var(--error); }
    .verifier-detail {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-subtle);
      font-size: 14px;
    }
    .verifier-detail:last-child { border: none; }
    .verifier-detail .vd-label { color: var(--text-secondary); }
    .verifier-detail .vd-value { font-family: var(--mono); font-size: 12px; }
    .data-classes {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .data-class-tag {
      padding: 5px 12px;
      border-radius: 980px;
      font-size: 11px;
      font-weight: 600;
      font-family: var(--mono);
      background: rgba(0,122,255,0.1);
      color: var(--blue);
    }

    /* ===== SOVEREIGNTY SEAL ===== */
    .sovereignty-seal {
      margin-top: 40px;
      padding: 40px;
      background: var(--surface);
      border-radius: var(--radius);
      text-align: center;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow);
      opacity: 0;
      transform: translateY(10px);
      animation: sealReveal 0.6s ease-out 0.2s forwards;
    }
    @keyframes sealReveal {
      to { opacity: 1; transform: translateY(0); }
    }
    .seal-content {
      position: relative;
      z-index: 1;
    }
    .seal-shield {
      width: 64px;
      height: 64px;
      margin: 0 auto 20px;
      background: var(--accent);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
    }
    .seal-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 6px;
      letter-spacing: -0.02em;
      color: var(--text);
    }
    .seal-subtitle {
      font-size: 15px;
      color: var(--text-secondary);
      margin-bottom: 28px;
    }
    .seal-facts {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      max-width: 500px;
      margin: 0 auto 24px;
    }
    .seal-fact .sf-value {
      font-family: var(--mono);
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
    }
    .seal-fact .sf-label {
      font-size: 11px;
      color: var(--text-tertiary);
      margin-top: 4px;
      letter-spacing: 0.02em;
    }
    .seal-hash {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text-tertiary);
      word-break: break-all;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    /* ===== GRANULAR PERMISSIONS UI ===== */
    .phase-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .phase-desc {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 20px;
      line-height: 1.5;
    }
    
    /* Agent Cards Grid */
    .agent-cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .agent-card {
      background: var(--bg);
      border: 2px solid transparent;
      border-radius: var(--radius);
      padding: 24px;
      cursor: pointer;
      transition: all 0.2s ease-out;
      position: relative;
    }
    .agent-card:hover {
      background: rgba(0,0,0,0.02);
      transform: translateY(-2px);
    }
    .agent-card.selected {
      border-color: var(--blue);
      background: rgba(0,122,255,0.04);
    }
    .agent-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .agent-icon {
      font-size: 32px;
      line-height: 1;
    }
    .agent-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 980px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .agent-badge.recommended {
      background: rgba(52,199,89,0.12);
      color: var(--success);
    }
    .agent-name {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }
    .agent-tagline {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }
    .agent-needs, .agent-provides {
      margin-bottom: 12px;
    }
    .needs-label, .provides-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      display: block;
      margin-bottom: 6px;
    }
    .needs-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .need-tag {
      font-size: 11px;
      font-weight: 500;
      padding: 4px 10px;
      border-radius: 980px;
      background: rgba(0,122,255,0.1);
      color: var(--blue);
    }
    .need-tag.high {
      background: rgba(255,149,0,0.12);
      color: var(--warning);
    }
    .provides-list {
      list-style: none;
      font-size: 13px;
      color: var(--text-secondary);
    }
    .provides-list li {
      padding: 2px 0;
      padding-left: 16px;
      position: relative;
    }
    .provides-list li::before {
      content: 'â†’';
      position: absolute;
      left: 0;
      color: var(--text-tertiary);
    }
    .agent-select-btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: var(--radius-sm);
      font-family: var(--font);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease-out;
      margin-top: 12px;
      background: var(--surface);
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }
    .agent-card.selected .agent-select-btn {
      background: var(--blue);
      color: #fff;
      border-color: var(--blue);
    }
    .agent-select-btn .check-icon {
      display: none;
    }
    .agent-card.selected .agent-select-btn .check-icon {
      display: inline;
    }
    .selected-agent-info {
      margin-top: 20px;
    }
    
    /* Enhanced Scope Grid */
    .scope-grid-enhanced {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }
    .scope-item-enhanced {
      display: flex;
      align-items: flex-start;
      gap: 16px;
      padding: 18px 20px;
      background: var(--bg);
      border: 2px solid transparent;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s ease-out;
      -webkit-tap-highlight-color: transparent;
    }
    .scope-item-enhanced:hover {
      background: rgba(0,0,0,0.03);
    }
    .scope-item-enhanced.selected {
      border-color: var(--blue);
      background: rgba(0,122,255,0.04);
    }
    .scope-item-enhanced[data-sensitivity="high"]:not(.selected) {
      background: rgba(255,149,0,0.04);
    }
    .scope-checkbox {
      flex-shrink: 0;
      position: relative;
    }
    .scope-checkbox input[type="checkbox"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }
    .scope-checkbox label {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease-out;
      background: var(--surface);
    }
    .scope-checkbox label::after {
      content: 'âœ“';
      font-size: 14px;
      color: transparent;
      transition: color 0.2s ease-out;
    }
    .scope-item-enhanced.selected .scope-checkbox label {
      background: var(--blue);
      border-color: var(--blue);
    }
    .scope-item-enhanced.selected .scope-checkbox label::after {
      color: #fff;
    }
    .scope-content {
      flex: 1;
      min-width: 0;
    }
    .scope-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
      flex-wrap: wrap;
      gap: 8px;
    }
    .scope-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
    }
    .scope-sensitivity {
      font-size: 10px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 980px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .scope-sensitivity.low {
      background: rgba(52,199,89,0.12);
      color: var(--success);
    }
    .scope-sensitivity.medium {
      background: rgba(0,122,255,0.12);
      color: var(--blue);
    }
    .scope-sensitivity.high {
      background: rgba(255,149,0,0.12);
      color: var(--warning);
    }
    .scope-records {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      font-family: var(--mono);
      margin-bottom: 4px;
    }
    .scope-detail {
      font-size: 13px;
      color: var(--text-tertiary);
    }
    
    /* Scope Summary */
    .scope-summary {
      background: var(--bg);
      border-radius: var(--radius-sm);
      padding: 16px 20px;
      margin-bottom: 20px;
    }
    .summary-stats {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
    }
    .summary-stat {
      display: flex;
      flex-direction: column;
    }
    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      font-family: var(--mono);
    }
    .stat-label {
      font-size: 11px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    
    /* Expiry Options */
    .expiry-options {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .expiry-option {
      cursor: pointer;
    }
    .expiry-option input[type="radio"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }
    .expiry-btn {
      display: inline-block;
      padding: 12px 24px;
      background: var(--bg);
      border: 2px solid transparent;
      border-radius: 980px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.2s ease-out;
      cursor: pointer;
    }
    .expiry-option input[type="radio"]:checked + .expiry-btn {
      border-color: var(--blue);
      background: rgba(0,122,255,0.08);
      color: var(--blue);
    }
    .expiry-btn:hover {
      background: rgba(0,0,0,0.04);
    }
    
    /* Permission Review Box */
    .permission-review-box {
      background: rgba(255,149,0,0.06);
      border: 1px solid rgba(255,149,0,0.2);
      border-radius: var(--radius);
      padding: 24px;
      margin-top: 20px;
    }
    .review-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }
    .review-icon {
      font-size: 20px;
    }
    .review-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
    }
    .review-scopes {
      background: var(--surface);
      border-radius: var(--radius-sm);
      padding: 16px;
      margin-bottom: 16px;
    }
    .review-scope-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 14px;
    }
    .review-scope-item .scope-bullet {
      color: var(--blue);
      font-weight: bold;
    }
    .review-scope-item .scope-name {
      font-weight: 600;
      color: var(--text);
      font-family: var(--mono);
      font-size: 13px;
    }
    .review-scope-item .scope-count {
      color: var(--text-secondary);
      font-size: 13px;
    }
    .review-meta {
      margin-bottom: 20px;
    }
    .review-meta-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
      padding: 4px 0;
    }
    .review-meta-item strong {
      color: var(--text);
    }
    .review-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .btn-grant {
      flex: 1;
      min-width: 140px;
    }
    .btn-deny {
      min-width: 100px;
    }
    
    /* Token Granted State */
    .token-granted-banner {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px 24px;
      background: rgba(52,199,89,0.08);
      border: 1px solid rgba(52,199,89,0.2);
      border-radius: var(--radius);
      margin-bottom: 24px;
    }
    .granted-icon {
      font-size: 28px;
    }
    .granted-info {
      display: flex;
      flex-direction: column;
    }
    .granted-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--success);
    }
    .granted-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .token-details-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .token-detail-card {
      background: var(--bg);
      border-radius: var(--radius-sm);
      padding: 16px;
    }
    .detail-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: 6px;
    }
    .detail-value {
      font-size: 14px;
      color: var(--text);
      word-break: break-all;
    }
    .detail-value.mono {
      font-family: var(--mono);
      font-size: 12px;
    }
    .token-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .token-actions .btn {
      padding: 10px 18px;
      font-size: 13px;
    }
    .token-actions .revoke-btn {
      display: inline-flex;
      margin-top: 0;
    }
    .token-full-details {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
      main { padding: 40px 16px 80px; }
      .hero { margin-bottom: 60px; }
      .hero h1 { font-size: 36px; }
      .hero p { font-size: 17px; }
      .step-header { padding: 20px; }
      .step-body { padding: 0 20px 20px; }
      .btn-group { flex-direction: column; }
      .btn { width: 100%; }
      .analysis-grid { grid-template-columns: repeat(2, 1fr); }
      .progress-node-label { display: none; }
      .progress-node { width: 28px; height: 28px; font-size: 12px; }
      .progress-bar { padding: 16px 16px 24px; }
      .seal-facts { grid-template-columns: repeat(2, 1fr); }
      .verifier-input-group { flex-direction: column; }
      .verifier-card { padding: 28px; }
      
      /* Granular Permissions Mobile */
      .agent-cards-grid { grid-template-columns: 1fr; }
      .agent-card { padding: 20px; }
      .scope-item-enhanced { padding: 16px; }
      .scope-checkbox label { width: 32px; height: 32px; }
      .summary-stats { gap: 16px; }
      .expiry-options { flex-direction: column; }
      .expiry-btn { width: 100%; text-align: center; }
      .review-actions { flex-direction: column; }
      .btn-grant, .btn-deny { width: 100%; }
      .token-details-grid { grid-template-columns: 1fr; }
      .token-actions { flex-direction: column; }
      .token-actions .btn,
      .token-actions .revoke-btn { width: 100%; justify-content: center; }
    }
    @media (max-width: 480px) {
      .hero h1 { font-size: 32px; }
      .btn { min-height: 50px; }
      .scope-header-row { flex-direction: column; align-items: flex-start; gap: 6px; }
      .agent-card { padding: 16px; }
      .agent-name { font-size: 16px; }
    }
    html, body { overflow-x: hidden; }
  </style>
</head>
<body>
<a class="skip-to-content" href="#main-content">Skip to content</a>

  <!-- DDC Status Banner -->
  <div class="ddc-banner" id="ddcBanner">
    <span class="status-dot"></span>
    <span id="ddcStatus">Connecting to Cere DDC Mainnet...</span>
  </div>

  <!-- Nav -->
  <nav role="navigation" aria-label="Main navigation">
    <div class="nav-inner">
      <div class="nav-left">
        <a href="/" class="nav-logo">Proofi</a>
        <span class="nav-badge" id="modeBadge">DDC Mainnet</span>
      </div>
      <div class="wallet-status" id="walletStatus">
        <span class="wallet-dot" id="walletDot"></span>
        <span class="wallet-addr" id="walletAddr">Not connected</span>
      </div>
      <div class="ollama-status" id="ollamaStatus" style="margin-left: 16px; display: flex; align-items: center; gap: 6px;">
        <span class="wallet-dot" id="ollamaDot" style="background: var(--text-tertiary);"></span>
        <span style="font-size: 12px; color: var(--text-secondary);" id="ollamaStatusText">Ollama: checking...</span>
      </div>
    </div>
  </nav>

  <!-- Progress Bar -->
  <div class="progress-bar">
    <div class="progress-bar-inner" id="progressBar">
      <div class="progress-line" id="progressLine"></div>
      <div class="progress-node active" data-step="1" onclick="scrollToStep(1)">
        1
        <span class="progress-node-label">Identity</span>
      </div>
      <div class="progress-node" data-step="2" onclick="scrollToStep(2)">
        2
        <span class="progress-node-label">Encrypt</span>
      </div>
      <div class="progress-node" data-step="3" onclick="scrollToStep(3)">
        3
        <span class="progress-node-label">Permission</span>
      </div>
      <div class="progress-node" data-step="4" onclick="scrollToStep(4)">
        4
        <span class="progress-node-label">Analysis</span>
      </div>
      <div class="progress-node" data-step="5" onclick="scrollToStep(5)">
        5
        <span class="progress-node-label">Results</span>
      </div>
    </div>
  </div>

  <!-- Main -->
  <main id="main-content">
    <section class="hero">
      <h1>Analyze your health data privately.</h1>
      <p>See how an AI agent can read your data without anyone else seeing it. Everything is encrypted, stored decentrally, and verifiable.</p>
    </section>

    <div class="steps">
      <!-- Step 1: Wallet Connection -->
      <div class="step active" id="step1">
        <div class="step-header" onclick="toggleStep(1)">
          <div class="step-num"><span>1</span></div>
          <div class="step-info">
            <div class="step-title">Create Your Identity</div>
            <div class="step-desc">Generate a cryptographic wallet â€” this is your digital signature</div>
          </div>
          <span class="step-status">Pending</span>
        </div>
        <div class="step-body">
          <div class="form-group">
            <label class="form-label">Seed phrase (leave empty to create a new wallet)</label>
            <input aria-label="word1 word2 word3 ... word12" type="text" class="form-input" id="seedInput" placeholder="word1 word2 word3 ... word12">
          </div>
          <div class="btn-group">
            <button aria-label="Generate wallet" class="btn btn-primary" onclick="connectWallet()">Create New Wallet</button>
            <button aria-label="Import wallet" class="btn btn-secondary" onclick="connectWallet(true)">Import Existing</button>
          </div>
          
          <div id="walletResult" style="margin-top: 24px; display: none;">
            <div class="kv-grid">
              <div class="kv-item">
                <div class="kv-content">
                  <div class="kv-key">Public Key (Ed25519)</div>
                  <div class="kv-value" id="userPubKey">â€”</div>
                </div>
              </div>
              <div class="kv-item">
                <div class="kv-content">
                  <div class="kv-key">Decentralized Identifier (DID)</div>
                  <div class="kv-value" id="userDID">â€”</div>
                </div>
              </div>
              <div class="kv-item">
                <div class="kv-content">
                  <div class="kv-key">Encryption Key (X25519)</div>
                  <div class="kv-value" id="userX25519">â€”</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 2: Upload Health Data -->
      <div class="step" id="step2">
        <div class="step-header" onclick="toggleStep(2)">
          <div class="step-num"><span>2</span></div>
          <div class="step-info">
            <div class="step-title">Encrypt and Store Your Data</div>
            <div class="step-desc">Your health data gets encrypted on your device, then stored securely</div>
          </div>
          <span class="step-status">Locked</span>
        </div>
        <div class="step-body">
          <p style="font-size: 15px; color: var(--text-secondary); margin-bottom: 24px; line-height: 1.6;">
            Your health data will be encrypted with AES-256-GCM using a Data Encryption Key (DEK) that only you control.
            The encrypted data is stored on the Cere DDC network.
          </p>
          
          <div class="data-label">
            <span>Sample Health Data (30 days of sleep + 100 heart rate readings)</span>
          </div>
          <div class="data-box" style="max-height: 140px;">
            <pre id="sampleDataPreview">Loading...</pre>
          </div>
          
          <div class="btn-group">
            <button aria-label="Encrypt and upload data" class="btn btn-primary" id="uploadBtn" onclick="uploadHealthData()" disabled>
              Encrypt and Upload to DDC
            </button>
          </div>
          
          <div id="uploadResult" style="margin-top: 24px; display: none;">
            <div class="kv-grid">
              <div class="kv-item">
                <div class="kv-content">
                  <div class="kv-key">Storage Mode</div>
                  <div class="kv-value ddc" id="storageMode">â€”</div>
                </div>
              </div>
              <div class="kv-item">
                <div class="kv-content">
                  <div class="kv-key">DDC Bucket ID</div>
                  <div class="kv-value success" id="bucketId">â€”</div>
                </div>
              </div>
              <div class="kv-item">
                <div class="kv-content">
                  <div class="kv-key">Content ID (CID)</div>
                  <div class="kv-value success" id="dataCid">â€”</div>
                </div>
              </div>
              <div class="kv-item">
                <div class="kv-content">
                  <div class="kv-key">DDC CDN URL</div>
                  <div class="kv-value" id="ddcUrl" style="font-size: 11px;">â€”</div>
                </div>
              </div>
              <div class="kv-item">
                <div class="kv-content">
                  <div class="kv-key">Data Encryption Key (DEK)</div>
                  <div class="kv-value" id="dekDisplay">â€”</div>
                </div>
              </div>
              <div class="kv-item">
                <div class="kv-content">
                  <div class="kv-key">Encryption Details</div>
                  <div class="kv-value" id="encDetails">â€”</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3: Grant Agent Permission -->
      <div class="step" id="step3">
        <div class="step-header" onclick="toggleStep(3)">
          <div class="step-num"><span>3</span></div>
          <div class="step-info">
            <div class="step-title">Choose What to Share</div>
            <div class="step-desc">Grant an AI agent read-only access to specific data â€” revoke anytime</div>
          </div>
          <span class="step-status">Locked</span>
        </div>
        <div class="step-body">
          
          <!-- Phase 1: Choose an Agent -->
          <div id="agentSelectionPhase">
            <h4 class="phase-title">1. Choose an Agent</h4>
            <p class="phase-desc">Select which AI agent should analyze your health data. Each agent has different capabilities.</p>
            
            <div class="agent-cards-grid">
              <!-- Health Analyzer Agent -->
              <div class="agent-card selected" data-agent="health-analyzer">
                <div class="agent-card-header">
                  <div class="agent-icon">ðŸ“Š</div>
                  <div class="agent-badge recommended">Recommended</div>
                </div>
                <h5 class="agent-name">Health Analyzer</h5>
                <p class="agent-tagline">General health insights & trends</p>
                <div class="agent-needs">
                  <span class="needs-label">Needs access to:</span>
                  <div class="needs-tags">
                    <span class="need-tag">Steps</span>
                    <span class="need-tag">Sleep</span>
                    <span class="need-tag">Heart Rate</span>
                  </div>
                </div>
                <div class="agent-provides">
                  <span class="provides-label">Provides:</span>
                  <ul class="provides-list">
                    <li>Overall health score</li>
                    <li>Weekly trend analysis</li>
                    <li>Personalized recommendations</li>
                  </ul>
                </div>
                <button class="agent-select-btn" onclick="selectAgent('health-analyzer')">
                  <span class="check-icon">âœ“</span> Selected
                </button>
              </div>
              
              <!-- Fitness Coach Agent -->
              <div class="agent-card" data-agent="fitness-coach">
                <div class="agent-card-header">
                  <div class="agent-icon">ðŸƒ</div>
                </div>
                <h5 class="agent-name">Fitness Coach</h5>
                <p class="agent-tagline">Workout optimization & goals</p>
                <div class="agent-needs">
                  <span class="needs-label">Needs access to:</span>
                  <div class="needs-tags">
                    <span class="need-tag">Steps</span>
                    <span class="need-tag">Heart Rate</span>
                    <span class="need-tag high">HRV</span>
                  </div>
                </div>
                <div class="agent-provides">
                  <span class="provides-label">Provides:</span>
                  <ul class="provides-list">
                    <li>Training load analysis</li>
                    <li>Recovery recommendations</li>
                    <li>Activity goals</li>
                  </ul>
                </div>
                <button class="agent-select-btn" onclick="selectAgent('fitness-coach')">
                  Select Agent
                </button>
              </div>
              
              <!-- Sleep Optimizer Agent -->
              <div class="agent-card" data-agent="sleep-optimizer">
                <div class="agent-card-header">
                  <div class="agent-icon">ðŸŒ™</div>
                </div>
                <h5 class="agent-name">Sleep Optimizer</h5>
                <p class="agent-tagline">Sleep quality & bedtime tips</p>
                <div class="agent-needs">
                  <span class="needs-label">Needs access to:</span>
                  <div class="needs-tags">
                    <span class="need-tag">Sleep</span>
                    <span class="need-tag">Heart Rate</span>
                    <span class="need-tag high">Blood Oxygen</span>
                  </div>
                </div>
                <div class="agent-provides">
                  <span class="provides-label">Provides:</span>
                  <ul class="provides-list">
                    <li>Sleep stage analysis</li>
                    <li>Optimal bedtime</li>
                    <li>Environment tips</li>
                  </ul>
                </div>
                <button class="agent-select-btn" onclick="selectAgent('sleep-optimizer')">
                  Select Agent
                </button>
              </div>
              
              <!-- External Device Agent -->
              <div class="agent-card" data-agent="external-device">
                <div class="agent-card-header">
                  <div class="agent-icon">ðŸ–¥ï¸</div>
                  <div class="agent-badge" style="background: rgba(175,82,222,0.12); color: #af52de;">Desktop</div>
                </div>
                <h5 class="agent-name">External Device</h5>
                <p class="agent-tagline">Run analysis on your Mac/PC with Ollama</p>
                <div class="agent-needs">
                  <span class="needs-label">Needs access to:</span>
                  <div class="needs-tags">
                    <span class="need-tag">Your choice</span>
                  </div>
                </div>
                <div class="agent-provides">
                  <span class="provides-label">You provide:</span>
                  <ul class="provides-list">
                    <li>QR code to scan on device</li>
                    <li>Local Ollama analysis</li>
                    <li>Full privacy â€” never leaves your network</li>
                  </ul>
                </div>
                <button class="agent-select-btn" onclick="selectAgent('external-device')">
                  Select Agent
                </button>
              </div>
            </div>
            
            <!-- Selected Agent Info -->
            <div class="selected-agent-info" id="selectedAgentInfo">
              <div class="kv-grid">
                <div class="kv-item">
                  <div class="kv-content">
                    <div class="kv-key">Selected Agent</div>
                    <div class="kv-value" id="selectedAgentName">Health Analyzer Agent v1.0</div>
                  </div>
                </div>
                <div class="kv-item">
                  <div class="kv-content">
                    <div class="kv-key">Agent Encryption Key (X25519)</div>
                    <div class="kv-value" id="agentPubKey">â€”</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Phase 2: Choose Your Data Scopes -->
          <div id="scopeSelectionPhase" style="margin-top: 32px;">
            <h4 class="phase-title">2. Choose What Data to Share</h4>
            <p class="phase-desc"><span id="selectedAgentNameInline">Health Analyzer</span> requests access to your health data. Toggle exactly what you're comfortable sharing.</p>
            
            <div class="scope-grid-enhanced" id="scopeGridEnhanced">
              <!-- Steps -->
              <div class="scope-item-enhanced selected" data-scope="steps" data-sensitivity="low">
                <div class="scope-checkbox">
                  <input type="checkbox" id="scope-steps" checked>
                  <label for="scope-steps"></label>
                </div>
                <div class="scope-content">
                  <div class="scope-header-row">
                    <span class="scope-name">Steps</span>
                    <span class="scope-sensitivity low">LOW</span>
                  </div>
                  <div class="scope-records">142,847 records</div>
                  <div class="scope-detail">Daily step counts, walking + running distance</div>
                </div>
              </div>
              
              <!-- Sleep Analysis -->
              <div class="scope-item-enhanced selected" data-scope="sleep" data-sensitivity="medium">
                <div class="scope-checkbox">
                  <input type="checkbox" id="scope-sleep" checked>
                  <label for="scope-sleep"></label>
                </div>
                <div class="scope-content">
                  <div class="scope-header-row">
                    <span class="scope-name">Sleep Analysis</span>
                    <span class="scope-sensitivity medium">MEDIUM</span>
                  </div>
                  <div class="scope-records">1,461 records</div>
                  <div class="scope-detail">Duration, quality, REM cycles, awakenings</div>
                </div>
              </div>
              
              <!-- Heart Rate -->
              <div class="scope-item-enhanced selected" data-scope="heart" data-sensitivity="medium">
                <div class="scope-checkbox">
                  <input type="checkbox" id="scope-heart" checked>
                  <label for="scope-heart"></label>
                </div>
                <div class="scope-content">
                  <div class="scope-header-row">
                    <span class="scope-name">Heart Rate</span>
                    <span class="scope-sensitivity medium">MEDIUM</span>
                  </div>
                  <div class="scope-records">298,421 records</div>
                  <div class="scope-detail">Continuous BPM, resting, active, recovery</div>
                </div>
              </div>
              
              <!-- HRV - High Sensitivity -->
              <div class="scope-item-enhanced" data-scope="hrv" data-sensitivity="high">
                <div class="scope-checkbox">
                  <input type="checkbox" id="scope-hrv">
                  <label for="scope-hrv"></label>
                </div>
                <div class="scope-content">
                  <div class="scope-header-row">
                    <span class="scope-name">HRV (Heart Rate Variability)</span>
                    <span class="scope-sensitivity high">HIGH</span>
                  </div>
                  <div class="scope-records">52,104 records</div>
                  <div class="scope-detail">Autonomic nervous system, stress levels, recovery</div>
                </div>
              </div>
              
              <!-- Blood Oxygen - High Sensitivity -->
              <div class="scope-item-enhanced" data-scope="blood-oxygen" data-sensitivity="high">
                <div class="scope-checkbox">
                  <input type="checkbox" id="scope-blood-oxygen">
                  <label for="scope-blood-oxygen"></label>
                </div>
                <div class="scope-content">
                  <div class="scope-header-row">
                    <span class="scope-name">Blood Oxygen (SpO2)</span>
                    <span class="scope-sensitivity high">HIGH</span>
                  </div>
                  <div class="scope-records">8,293 records</div>
                  <div class="scope-detail">Oxygen saturation, respiratory health indicators</div>
                </div>
              </div>
            </div>
            
            <!-- Scope Summary -->
            <div class="scope-summary" id="scopeSummary">
              <div class="summary-stats">
                <div class="summary-stat">
                  <span class="stat-value" id="selectedScopesCount">3</span>
                  <span class="stat-label">data types</span>
                </div>
                <div class="summary-stat">
                  <span class="stat-value" id="selectedRecordsCount">442,729</span>
                  <span class="stat-label">records</span>
                </div>
                <div class="summary-stat">
                  <span class="stat-value" id="maxSensitivity">MEDIUM</span>
                  <span class="stat-label">max sensitivity</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Phase 3: Review & Grant -->
          <div id="reviewPhase" style="margin-top: 32px;">
            <h4 class="phase-title">3. Review & Grant Access</h4>
            
            <div class="form-group">
              <label class="form-label">Access Duration</label>
              <div class="expiry-options">
                <label class="expiry-option">
                  <input type="radio" name="tokenExpiry" value="3600">
                  <span class="expiry-btn">1 hour</span>
                </label>
                <label class="expiry-option">
                  <input type="radio" name="tokenExpiry" value="86400" checked>
                  <span class="expiry-btn selected">24 hours</span>
                </label>
                <label class="expiry-option">
                  <input type="radio" name="tokenExpiry" value="604800">
                  <span class="expiry-btn">7 days</span>
                </label>
              </div>
            </div>
            
            <!-- Permission Review Box -->
            <div class="permission-review-box" id="permissionReviewBox">
              <div class="review-header">
                <span class="review-icon">âš ï¸</span>
                <span class="review-title">Review: <span id="reviewAgentName">Health Analyzer</span> will access:</span>
              </div>
              <div class="review-scopes" id="reviewScopes">
                <div class="review-scope-item">
                  <span class="scope-bullet">â€¢</span>
                  <span class="scope-name">steps</span>
                  <span class="scope-count">â€” 142,847 records</span>
                </div>
                <div class="review-scope-item">
                  <span class="scope-bullet">â€¢</span>
                  <span class="scope-name">sleep</span>
                  <span class="scope-count">â€” 1,461 records</span>
                </div>
                <div class="review-scope-item">
                  <span class="scope-bullet">â€¢</span>
                  <span class="scope-name">heart</span>
                  <span class="scope-count">â€” 298,421 records</span>
                </div>
              </div>
              <div class="review-meta">
                <div class="review-meta-item">
                  <span class="meta-icon">â±ï¸</span>
                  <span>Access expires: <strong id="reviewExpiry">24 hours</strong></span>
                </div>
                <div class="review-meta-item">
                  <span class="meta-icon">ðŸ“‹</span>
                  <span>All access logged to audit chain</span>
                </div>
              </div>
              <div class="review-actions">
                <button aria-label="Grant access" class="btn btn-primary btn-grant" id="grantBtn" onclick="grantPermission()" disabled>
                  Grant Access
                </button>
                <button aria-label="Cancel" class="btn btn-secondary btn-deny" onclick="resetScopeSelection()">
                  Deny
                </button>
              </div>
            </div>
          </div>
          
          <!-- Token Result (shown after granting) -->
          <div id="tokenResult" style="margin-top: 32px; display: none;">
            <div class="token-granted-banner">
              <span class="granted-icon">âœ…</span>
              <div class="granted-info">
                <span class="granted-title">Access Granted</span>
                <span class="granted-subtitle">Token created and signed with Ed25519</span>
              </div>
            </div>
            
            <!-- External Device QR Code Section (shown when external-device agent selected) -->
            <div id="externalDeviceSection" style="display: none;">
              <div style="background: rgba(175,82,222,0.06); border: 1px solid rgba(175,82,222,0.2); border-radius: var(--radius); padding: 24px; margin-bottom: 24px;">
                <div style="display: flex; align-items: flex-start; gap: 24px; flex-wrap: wrap;">
                  <div style="flex: 1; min-width: 280px;">
                    <h4 style="font-size: 18px; font-weight: 600; color: var(--text); margin-bottom: 8px;">
                      ðŸ–¥ï¸ Run Analysis on External Device
                    </h4>
                    <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">
                      Scan the QR code with your Mac/PC or copy the token to run local Ollama analysis. 
                      Your data never leaves your local network.
                    </p>
                    
                    <div style="background: var(--bg); border-radius: var(--radius-sm); padding: 16px; margin-bottom: 16px;">
                      <div style="font-size: 12px; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: 8px;">
                        On your Mac/PC, run:
                      </div>
                      <code style="display: block; font-family: var(--mono); font-size: 13px; color: var(--blue); word-break: break-all;">
                        node analyze.js --token "$(pbpaste)"
                      </code>
                    </div>
                    
                    <div class="btn-group" style="gap: 8px;">
                      <button class="btn btn-primary" onclick="copyExternalToken()" style="padding: 10px 16px; font-size: 13px;">
                        ðŸ“‹ Copy Token
                      </button>
                      <button class="btn btn-secondary" onclick="downloadExternalToken()" style="padding: 10px 16px; font-size: 13px;">
                        â¬‡ï¸ Download Token
                      </button>
                    </div>
                  </div>
                  
                  <div style="text-align: center;">
                    <div id="qrCodeContainer" style="background: white; padding: 16px; border-radius: var(--radius-sm); display: inline-block;">
                      <canvas id="qrCodeCanvas"></canvas>
                    </div>
                    <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 8px;">
                      Scan with camera app
                    </div>
                  </div>
                </div>
                
                <!-- Waiting for external analysis -->
                <div id="externalWaitingSection" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(175,82,222,0.2);">
                  <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="spinner" style="border-top-color: #af52de;"></div>
                    <div>
                      <div style="font-size: 14px; font-weight: 600; color: var(--text);">Waiting for external analysis...</div>
                      <div style="font-size: 13px; color: var(--text-secondary);">
                        Results will appear here when your device completes the analysis
                      </div>
                    </div>
                  </div>
                  
                  <!-- Callback URL input (optional) -->
                  <div style="margin-top: 16px;">
                    <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 6px;">
                      Callback URL (optional â€” for automatic result delivery)
                    </label>
                    <div style="display: flex; gap: 8px;">
                      <input type="text" id="callbackUrlInput" class="form-input" 
                             placeholder="https://your-server.com/results" 
                             style="flex: 1; font-size: 13px; padding: 10px 14px;">
                      <button class="btn btn-secondary" onclick="updateCallbackUrl()" style="padding: 10px 14px; font-size: 13px;">
                        Update Token
                      </button>
                    </div>
                  </div>
                  
                  <!-- Manual result paste -->
                  <div style="margin-top: 16px;">
                    <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 6px;">
                      Or paste results manually
                    </label>
                    <textarea id="externalResultsInput" class="form-input" 
                              placeholder='{"analysis": {...}, "recommendations": [...]}'
                              style="font-size: 12px; min-height: 80px; resize: vertical;"></textarea>
                    <button class="btn btn-primary" onclick="importExternalResults()" style="margin-top: 8px; padding: 10px 16px; font-size: 13px;">
                      Import Results
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="token-details-grid">
              <div class="token-detail-card">
                <div class="detail-label">Token ID</div>
                <div class="detail-value mono" id="tokenId">â€”</div>
              </div>
              <div class="token-detail-card">
                <div class="detail-label">Scopes Granted</div>
                <div class="detail-value" id="grantedScopes">â€”</div>
              </div>
              <div class="token-detail-card">
                <div class="detail-label">Expires</div>
                <div class="detail-value" id="tokenExpiryDisplay">â€”</div>
              </div>
              <div class="token-detail-card">
                <div class="detail-label">Status</div>
                <div class="detail-value" id="tokenStatusDisplay">
                  <span class="revocation-status active">ACTIVE</span>
                </div>
              </div>
            </div>
            
            <div class="token-actions">
              <button class="btn btn-secondary" onclick="toggleTokenDetails()">
                <span id="tokenDetailsToggleText">Show Full Token</span>
              </button>
              <button class="btn btn-secondary" onclick="copyToken()">Copy Token</button>
              <button class="btn btn-secondary" onclick="exportForCLI()">Export for CLI</button>
              <button class="revoke-btn" id="revokeBtn" onclick="revokeToken()">
                Revoke Access
              </button>
            </div>
            
            <div class="token-full-details" id="tokenFullDetails" style="display: none;">
              <div class="data-label">
                <span>Full Capability Token (JWT-like structure)</span>
              </div>
              <div class="data-box scrollable">
                <pre id="tokenDisplay">â€”</pre>
              </div>
              
              <div class="kv-grid" style="margin-top: 16px;">
                <div class="kv-item">
                  <div class="kv-content">
                    <div class="kv-key">Wrapped DEK (encrypted for agent)</div>
                    <div class="kv-value" id="wrappedDek">â€”</div>
                  </div>
                </div>
              </div>
            </div>
            
            <div id="revocationStatus" style="margin-top: 10px;"></div>
          </div>
        </div>
      </div>

      <!-- Step 4: Agent Execution -->
      <div class="step" id="step4">
        <div class="step-header" onclick="toggleStep(4)">
          <div class="step-num"><span>4</span></div>
          <div class="step-info">
            <div class="step-title">AI Analyzes Privately</div>
            <div class="step-desc">The agent reads your encrypted data, analyzes it, and returns results</div>
          </div>
          <span class="step-status">Locked</span>
        </div>
        <div class="step-body">
          <div id="agentLoading" class="loading">
            <div class="spinner"></div>
            <span>Agent processing...</span>
          </div>
          
          <div id="agentSteps" style="display: none;">
            <div class="kv-grid" style="margin-bottom: 28px;">
              <div class="kv-item" id="agentStep1">
                <div class="kv-content">
                  <div class="kv-key">1. Verify your permission is authentic</div>
                  <div class="kv-value pending">Waiting...</div>
                </div>
              </div>
              <div class="kv-item" id="agentStep2">
                <div class="kv-content">
                  <div class="kv-key">2. Check permission is still valid</div>
                  <div class="kv-value pending">Waiting...</div>
                </div>
              </div>
              <div class="kv-item" id="agentStep3">
                <div class="kv-content">
                  <div class="kv-key">3. Unlock the encryption key</div>
                  <div class="kv-value pending">Waiting...</div>
                </div>
              </div>
              <div class="kv-item" id="agentStep4">
                <div class="kv-content">
                  <div class="kv-key">4. Download and decrypt your data</div>
                  <div class="kv-value pending">Waiting...</div>
                </div>
              </div>
              <div class="kv-item" id="agentStep5">
                <div class="kv-content">
                  <div class="kv-key">5. Analyze and generate insights</div>
                  <div class="kv-value pending">Waiting...</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Ollama Settings -->
          <div id="ollamaSettings" style="background: rgba(0,229,255,0.06); border: 1px solid rgba(0,229,255,0.2); border-radius: var(--radius); padding: 20px; margin-bottom: 20px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 20px;">ðŸ¤–</span>
                <div>
                  <div style="font-weight: 600; color: var(--text);">Local Ollama Analysis</div>
                  <div style="font-size: 12px; color: var(--text-secondary);">Run AI analysis on your own hardware</div>
                </div>
              </div>
              <label class="toggle-switch" style="cursor: pointer;">
                <input type="checkbox" id="useOllamaToggle" onchange="toggleOllamaMode()">
                <span class="toggle-slider"></span>
              </label>
            </div>
            
            <div id="ollamaConfig" style="display: none;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                <div>
                  <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Ollama URL</label>
                  <input type="text" id="ollamaUrl" class="form-input" value="http://localhost:11434" style="font-size: 13px; padding: 8px 12px;">
                </div>
                <div>
                  <label style="font-size: 12px; color: var(--text-secondary); display: block; margin-bottom: 4px;">Model</label>
                  <select id="ollamaModel" class="form-input" style="font-size: 13px; padding: 8px 12px;">
                    <option value="llama3.2">llama3.2 (fast)</option>
                    <option value="llama3.1">llama3.1 (balanced)</option>
                    <option value="mistral">mistral (good)</option>
                    <option value="mixtral">mixtral (best)</option>
                    <option value="qwen2.5">qwen2.5 (multilingual)</option>
                  </select>
                </div>
              </div>
              <button class="btn btn-secondary" onclick="testOllamaConnection()" style="font-size: 12px; padding: 8px 14px;">
                ðŸ”Œ Test Connection
              </button>
              <span id="ollamaStatus" style="margin-left: 12px; font-size: 12px; color: var(--text-tertiary);"></span>
            </div>
          </div>
          
          <button aria-label="Run analysis" class="btn btn-primary" id="runAgentBtn" onclick="runAgent()" disabled>
            Run Analysis
          </button>
        </div>
      </div>

      <!-- Step 5: Results & Verification -->
      <div class="step" id="step5">
        <div class="step-header" onclick="toggleStep(5)">
          <div class="step-num"><span>5</span></div>
          <div class="step-info">
            <div class="step-title">Your Results</div>
            <div class="step-desc">Health insights plus a complete audit trail proving everything was done right</div>
          </div>
          <span class="step-status">Locked</span>
        </div>
        <div class="step-body">
          <h4 style="font-size: 16px; margin-bottom: 20px; font-weight: 600;">Health Analysis Results</h4>
          
          <div class="analysis-grid" id="analysisResults">
            <!-- Filled by JS -->
          </div>
          
          <div class="data-label">
            <span>AI Recommendations</span>
          </div>
          <div class="data-box" id="recommendations">
            <pre>Loading...</pre>
          </div>
          
          <h4 style="font-size: 16px; margin: 32px 0 20px; font-weight: 600;">Audit Trail</h4>
          <div class="audit-log" id="auditLog">
            <!-- Filled by JS -->
          </div>
          
          <div class="verify-section">
            <h4>Verification Details</h4>
            <div class="verify-grid" id="verifyGrid">
              <!-- Filled by JS -->
            </div>
          </div>
          
          <div class="btn-group" style="margin-top: 32px;">
            <button aria-label="Download audit log" class="btn btn-primary" onclick="downloadAuditLog()">Download Audit Log</button>
            <button aria-label="Restart" class="btn btn-secondary" onclick="restartDemo()">Start Over</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Public CID Verifier -->
  <section class="verifier-section" id="publicVerifier">
    <div class="verifier-card">
      <h2>Public CID Verifier</h2>
      <p>Verify any content stored on Cere DDC. Paste a Content ID to check its existence, fetch metadata, and classify data types.</p>
      <div class="verifier-input-group">
        <input type="text" class="verifier-input" id="verifyCidInput" placeholder="Enter CID (e.g., bafk2bzace...)">
        <input type="number" class="verifier-input" id="verifyBucketInput" placeholder="Bucket" value="1229" style="max-width: 120px;">
        <button class="btn btn-primary" onclick="publicVerify()">Verify</button>
      </div>
      <div class="verifier-result" id="verifierResult"></div>
    </div>
  </section>

  <!-- Console Toggle -->
  <button class="console-toggle" onclick="toggleConsole()">
    <span>Execution Log</span>
  </button>

  <!-- Console Panel -->
  <div class="console-panel" id="consolePanel">
    <div class="console-header">
      <h4>Execution Log</h4>
      <button aria-label="Close" class="console-close" onclick="toggleConsole()">Ã—</button>
    </div>
    <div class="console-body" id="consoleBody">
      <div class="console-line info">
        <span class="console-time">[init]</span>
        Proofi Health Demo initializing with DIRECT DDC SDK integration...
      </div>
    </div>
  </div>

  <!-- ProofiSDK for wallet signing via iframe -->
  <script src="/proofi-sdk.js"></script>

  <!-- TweetNaCl for real crypto -->
  <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl-fast.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tweetnacl-util@0.15.1/nacl-util.min.js"></script>
  
  <!-- QR Code generation for external device sharing -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  
  <!-- Cere DDC SDK for direct uploads -->
  <script type="module">
    import { DdcClient, File as DdcFile, UriSigner, MAINNET } from 'https://cdn.jsdelivr.net/npm/@cere-ddc-sdk/ddc-client@2.16.1/dist/browser.js';
    window.DdcClient = DdcClient;
    window.DdcFile = DdcFile;
    window.UriSigner = UriSigner;
    window.MAINNET = MAINNET;
  </script>
  
  <!-- Polkadot.js extension for wallet integration -->
  <script src="https://cdn.jsdelivr.net/npm/@polkadot/extension-dapp@0.46.5/bundle-polkadot-extension-dapp.min.js"></script>
  
  <script>
    // ========================================
    // DIRECT DDC E2E HEALTH DEMO
    // Using Cere DDC SDK - NO API PROXY
    // Uploads directly to DDC Mainnet
    // ========================================
    
    // DDC Configuration - MAINNET (Direct SDK)
    const DDC_CONFIG = {
      // Mainnet CDN endpoint for reading
      cdnUrl: 'https://cdn.cere.network',
      // Alternative CDN
      cdnUrlAlt: 'https://cdn.ddc-dragon.com',
      // Network identifier
      network: 'mainnet',
      // Default bucket (Proofi's public bucket)
      defaultBucket: 1229n
    };

    // Global State
    const state = {
      userKeyPair: null,        // Ed25519 signing keypair
      userX25519: null,         // X25519 encryption keypair
      agentKeyPair: null,       // Agent's X25519 keypair
      agentSigningKeyPair: null, // Agent's Ed25519 keypair
      dek: null,                // Data Encryption Key (AES-256)
      healthData: null,         // Raw health data
      encryptedData: null,      // Encrypted health data
      bucketId: null,           // DDC bucket ID
      dataCid: null,            // Content ID
      capabilityToken: null,    // The actual token
      auditLog: [],             // Audit trail with hashes
      lastHash: null,           // For hash chain
      ddcConnected: false,      // DDC connection status
      ddcClient: null,          // DDC SDK client instance
      tokenRevoked: false,      // Whether current token has been revoked
      revocationCid: null,      // CID of revocation record on DDC
      extensionConnected: false, // Polkadot.js extension status
      walletAddress: null,      // Real Cere SS58 address from extension
      walletSigner: null,       // Signer from extension
      walletMnemonic: null      // Mnemonic for DDC SDK (if using demo mode)
    };
    
    // Generate 30 days of sleep data + 100 heart rate readings
    const SAMPLE_HEALTH_DATA = generateSampleHealthData();
    
    function generateSampleHealthData() {
      const sleep = [];
      const heartRate = [];
      const startDate = new Date('2024-02-01');
      
      // 30 days of sleep
      for (let i = 0; i < 30; i++) {
        const date = new Date(startDate);
        date.setDate(date.getDate() + i);
        sleep.push({
          date: date.toISOString().split('T')[0],
          duration: 6 + Math.random() * 3,
          quality: 60 + Math.floor(Math.random() * 35),
          deep: 0.5 + Math.random() * 2,
          rem: 1 + Math.random() * 1.5,
          light: 3 + Math.random() * 2,
          awakenings: Math.floor(Math.random() * 5)
        });
      }
      
      // 100 heart rate readings
      for (let i = 0; i < 100; i++) {
        const date = new Date(startDate);
        date.setHours(date.getHours() + i * 7);
        const contexts = ['resting', 'walking', 'exercise', 'sleeping', 'stressed'];
        const context = contexts[Math.floor(Math.random() * contexts.length)];
        let bpm;
        switch(context) {
          case 'resting': bpm = 60 + Math.floor(Math.random() * 20); break;
          case 'walking': bpm = 80 + Math.floor(Math.random() * 30); break;
          case 'exercise': bpm = 120 + Math.floor(Math.random() * 60); break;
          case 'sleeping': bpm = 50 + Math.floor(Math.random() * 15); break;
          case 'stressed': bpm = 90 + Math.floor(Math.random() * 25); break;
        }
        heartRate.push({
          timestamp: date.toISOString(),
          bpm,
          context,
          variability: 20 + Math.floor(Math.random() * 40)
        });
      }
      
      return { sleep, heartRate, version: '1.0', exportedAt: new Date().toISOString() };
    }
    
    // ========================================
    // CONSOLE LOGGING
    // ========================================
    
    function log(message, type = 'info') {
      const time = new Date().toLocaleTimeString('en-US', { hour12: false });
      const consoleBody = document.getElementById('consoleBody');
      const line = document.createElement('div');
      line.className = `console-line ${type}`;
      line.innerHTML = `<span class="console-time">[${time}]</span>${escapeHtml(message)}`;
      consoleBody.appendChild(line);
      consoleBody.scrollTop = consoleBody.scrollHeight;
      console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function toggleConsole() {
      document.getElementById('consolePanel').classList.toggle('open');
    }
    
    // ========================================
    // DDC SDK INITIALIZATION
    // ========================================
    
    async function initDDCClient(mnemonic) {
      if (!window.CereDdcSdk) {
        throw new Error('DDC SDK not loaded');
      }
      
      const { DdcClient, UriSigner, MAINNET } = window.CereDdcSdk;
      
      log('Creating DDC client with wallet signer...', 'ddc');
      
      // Create signer from mnemonic
      const signer = new UriSigner(mnemonic);
      
      // Create DDC client connected to mainnet
      const client = await DdcClient.create(signer, MAINNET);
      
      log('DDC client created successfully', 'success');
      return client;
    }
    
    async function checkDDCConnection() {
      const banner = document.getElementById('ddcBanner');
      const statusEl = document.getElementById('ddcStatus');
      const modeBadge = document.getElementById('modeBadge');

      log('Checking DDC SDK availability...', 'ddc');

      try {
        // Check if DDC SDK is loaded
        if (window.CereDdcSdk) {
          state.ddcConnected = true;
          banner.className = 'ddc-banner';
          statusEl.textContent = 'DDC SDK loaded â€” Ready for direct uploads to Mainnet';
          modeBadge.textContent = 'DDC Direct';
          modeBadge.className = 'nav-badge';
          log('DDC SDK loaded: ' + Object.keys(window.CereDdcSdk).join(', '), 'success');
          return;
        }

        // SDK not loaded yet, wait a bit
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        if (window.CereDdcSdk) {
          state.ddcConnected = true;
          banner.className = 'ddc-banner';
          statusEl.textContent = 'DDC SDK loaded â€” Ready for direct uploads to Mainnet';
          modeBadge.textContent = 'DDC Direct';
          modeBadge.className = 'nav-badge';
          log('DDC SDK loaded after wait', 'success');
          return;
        }

        throw new Error('DDC SDK not available');

      } catch (err) {
        log('DDC SDK check failed: ' + err.message, 'warn');
        
        // Try CDN connectivity as fallback indicator
        try {
          const cdnResponse = await fetch(`${DDC_CONFIG.cdnUrlAlt}/1229/`, { method: 'HEAD' });
          if (cdnResponse.ok || cdnResponse.status === 404) {
            state.ddcConnected = true;
            banner.className = 'ddc-banner offline';
            statusEl.textContent = 'DDC CDN reachable â€” SDK loading...';
            modeBadge.textContent = 'DDC Connecting';
            modeBadge.className = 'nav-badge offline';
            log('DDC CDN reachable, SDK may still load', 'warn');
            return;
          }
        } catch (cdnErr) {
          log('DDC CDN unreachable: ' + cdnErr.message, 'error');
        }
      }

      // DDC not available
      state.ddcConnected = false;
      banner.className = 'ddc-banner error';
      statusEl.textContent = 'DDC SDK not loaded â€” Check your connection';
      modeBadge.textContent = 'DDC Offline';
      modeBadge.className = 'nav-badge offline';
      log('DDC SDK not available. Direct uploads will fail.', 'error');
    }
    
    // ========================================
    // CRYPTO UTILITIES (REAL)
    // ========================================
    
    // Generate random bytes
    function randomBytes(n) {
      return nacl.randomBytes(n);
    }
    
    // SHA-256 hash
    async function sha256(data) {
      const buffer = typeof data === 'string' ? new TextEncoder().encode(data) : data;
      const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
      return new Uint8Array(hashBuffer);
    }
    
    // SHA-256 hash as base64
    async function sha256Base64(data) {
      const hash = await sha256(data);
      return nacl.util.encodeBase64(hash);
    }
    
    // Generate Ed25519 signing keypair from seed
    function generateSigningKeyPair(seed = null) {
      if (!seed) {
        seed = randomBytes(32);
      }
      const keyPair = nacl.sign.keyPair.fromSeed(seed);
      return {
        publicKey: keyPair.publicKey,
        privateKey: keyPair.secretKey,
        seed
      };
    }
    
    // Generate X25519 box keypair
    function generateBoxKeyPair() {
      return nacl.box.keyPair();
    }
    
    // Derive DID from public key
    function deriveDID(publicKey) {
      const b64 = nacl.util.encodeBase64(publicKey);
      return `did:key:z${b64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '')}`;
    }
    
    // Generate CID (Content Identifier) - IPFS/DDC compatible format
    async function generateCID(data) {
      const jsonStr = typeof data === 'string' ? data : JSON.stringify(data);
      const hash = await sha256(jsonStr);
      
      const base32Chars = 'abcdefghijklmnopqrstuvwxyz234567';
      let result = '';
      
      let bits = 0;
      let value = 0;
      for (let i = 0; i < hash.length; i++) {
        value = (value << 8) | hash[i];
        bits += 8;
        while (bits >= 5) {
          bits -= 5;
          result += base32Chars[(value >> bits) & 31];
        }
      }
      if (bits > 0) {
        result += base32Chars[(value << (5 - bits)) & 31];
      }
      
      return 'bafyb' + result.slice(0, 54);
    }
    
    // AES-256-GCM encryption
    async function encryptAES(plaintext, key) {
      const iv = randomBytes(12);
      const encodedText = typeof plaintext === 'string' 
        ? new TextEncoder().encode(plaintext) 
        : plaintext;
      
      const cryptoKey = await crypto.subtle.importKey(
        'raw', key, { name: 'AES-GCM' }, false, ['encrypt']
      );
      
      const ciphertext = await crypto.subtle.encrypt(
        { name: 'AES-GCM', iv, tagLength: 128 },
        cryptoKey,
        encodedText
      );
      
      return {
        ciphertext: nacl.util.encodeBase64(new Uint8Array(ciphertext)),
        iv: nacl.util.encodeBase64(iv),
        algorithm: 'AES-256-GCM'
      };
    }
    
    // AES-256-GCM decryption
    async function decryptAES(ciphertextB64, ivB64, key) {
      const ciphertext = nacl.util.decodeBase64(ciphertextB64);
      const iv = nacl.util.decodeBase64(ivB64);
      
      const cryptoKey = await crypto.subtle.importKey(
        'raw', key, { name: 'AES-GCM' }, false, ['decrypt']
      );
      
      const plaintext = await crypto.subtle.decrypt(
        { name: 'AES-GCM', iv, tagLength: 128 },
        cryptoKey,
        ciphertext
      );
      
      return new TextDecoder().decode(plaintext);
    }
    
    // Wrap DEK for recipient (X25519 + XSalsa20-Poly1305)
    function wrapDEK(dek, recipientPublicKey) {
      const ephemeral = nacl.box.keyPair();
      const nonce = randomBytes(24);
      
      const encrypted = nacl.box(dek, nonce, recipientPublicKey, ephemeral.secretKey);
      
      return {
        ciphertext: nacl.util.encodeBase64(encrypted),
        ephemeralPublicKey: nacl.util.encodeBase64(ephemeral.publicKey),
        nonce: nacl.util.encodeBase64(nonce)
      };
    }
    
    // Unwrap DEK (X25519 + XSalsa20-Poly1305)
    function unwrapDEK(wrappedDEK, recipientPrivateKey) {
      const ciphertext = nacl.util.decodeBase64(wrappedDEK.ciphertext);
      const ephemeralPubKey = nacl.util.decodeBase64(wrappedDEK.ephemeralPublicKey);
      const nonce = nacl.util.decodeBase64(wrappedDEK.nonce);
      
      const dek = nacl.box.open(ciphertext, nonce, ephemeralPubKey, recipientPrivateKey);
      
      if (!dek) {
        throw new Error('DEK unwrapping failed - decryption error');
      }
      
      return dek;
    }
    
    // Sign message with Ed25519
    function signMessage(message, privateKey) {
      const messageBytes = typeof message === 'string' 
        ? new TextEncoder().encode(message) 
        : message;
      const signature = nacl.sign.detached(messageBytes, privateKey);
      return nacl.util.encodeBase64(signature);
    }
    
    // Verify Ed25519 signature
    function verifySignature(message, signatureB64, publicKey) {
      const messageBytes = typeof message === 'string' 
        ? new TextEncoder().encode(message) 
        : message;
      const signature = nacl.util.decodeBase64(signatureB64);
      return nacl.sign.detached.verify(messageBytes, signature, publicKey);
    }
    
    // ========================================
    // DIRECT DDC STORAGE LAYER (NO API PROXY)
    // ========================================
    
    class DirectDDCStorage {
      constructor() {
        this.mode = 'ddc-direct';
      }
      
      async store(bucketId, data) {
        const cid = await generateCID(data);
        const jsonData = JSON.stringify(data);

        log(`DDC Direct: Preparing ${(jsonData.length / 1024).toFixed(2)}KB for upload...`, 'ddc');
        log(`DDC Direct: Predicted CID = ${cid}`, 'ddc');

        // Check if DDC SDK is available
        if (!window.CereDdcSdk) {
          throw new Error('DDC SDK not loaded. Cannot upload directly.');
        }

        // Check if we have a wallet mnemonic for signing
        if (!state.walletMnemonic) {
          throw new Error('Wallet not connected. Generate or import a wallet first.');
        }

        try {
          // Initialize DDC client if not already done
          if (!state.ddcClient) {
            state.ddcClient = await initDDCClient(state.walletMnemonic);
          }

          const { File: DdcFile } = window.CereDdcSdk;

          log('DDC Direct: Uploading to Cere DDC Mainnet bucket ' + bucketId + '...', 'ddc');
          
          // Create DDC file from JSON data
          const dataBuffer = new TextEncoder().encode(jsonData);
          const file = new DdcFile(dataBuffer, { contentType: 'application/json' });

          // Store to DDC - wallet will sign the transaction
          const uri = await state.ddcClient.store(bucketId, file);
          
          const realCid = uri.cid;
          const cdnUrl = `${DDC_CONFIG.cdnUrlAlt}/${bucketId}/${realCid}`;
          
          log(`DDC Direct: Upload successful! CID: ${realCid}`, 'success');
          log(`DDC Direct: CDN URL: ${cdnUrl}`, 'ddc');
          
          return {
            cid: realCid,
            bucket: bucketId.toString(),
            mode: 'ddc-direct',
            cdnUrl: cdnUrl,
            uri: uri.toString()
          };
          
        } catch (err) {
          log(`DDC Direct: Upload failed - ${err.message}`, 'error');
          
          // If the error is about bucket access, provide helpful message
          if (err.message.includes('bucket') || err.message.includes('permission')) {
            throw new Error(`DDC bucket ${bucketId} access denied. You may need to use your own bucket or fund the wallet.`);
          }
          
          throw err;
        }
      }
      
      async fetch(bucketId, cid) {
        log(`DDC Direct: Fetching CID ${cid.slice(0, 20)}... from bucket ${bucketId}`, 'ddc');

        // Try CDN first (no auth needed for public buckets)
        const cdnUrls = [
          `${DDC_CONFIG.cdnUrlAlt}/${bucketId}/${cid}`,
          `${DDC_CONFIG.cdnUrl}/${bucketId}/${cid}`
        ];

        for (const cdnUrl of cdnUrls) {
          try {
            log(`DDC Direct: Trying CDN: ${cdnUrl}`, 'ddc');
            const response = await fetch(cdnUrl);

            if (response.ok) {
              const text = await response.text();
              log('DDC Direct: Fetched from CDN!', 'success');
              let content = JSON.parse(text);
              // Unwrap memo envelope if present
              if (content.type === 'memo' && content.content) {
                content = typeof content.content === 'string' ? JSON.parse(content.content) : content.content;
              }
              return content;
            }
          } catch (err) {
            log(`DDC Direct: CDN fetch failed: ${err.message}`, 'warn');
          }
        }

        // Try DDC SDK client if available
        if (state.ddcClient) {
          try {
            log('DDC Direct: Trying SDK client...', 'ddc');
            const uri = `ddc://${bucketId}/${cid}`;
            const fileResponse = await state.ddcClient.read(uri);
            
            const chunks = [];
            for await (const chunk of fileResponse.body) {
              chunks.push(chunk);
            }
            const data = new Uint8Array(chunks.reduce((acc, chunk) => acc + chunk.length, 0));
            let offset = 0;
            for (const chunk of chunks) {
              data.set(chunk, offset);
              offset += chunk.length;
            }
            
            const text = new TextDecoder().decode(data);
            log('DDC Direct: Fetched via SDK!', 'success');
            let content = JSON.parse(text);
            if (content.type === 'memo' && content.content) {
              content = typeof content.content === 'string' ? JSON.parse(content.content) : content.content;
            }
            return content;
          } catch (err) {
            log(`DDC Direct: SDK fetch failed: ${err.message}`, 'warn');
          }
        }

        throw new Error(`DDC fetch failed for CID ${cid.slice(0, 20)}. Content not found.`);
      }
    }
    
    const ddcStorage = new DirectDDCStorage();
    
    // ========================================
    // AUDIT LOG
    // ========================================
    
    async function addAuditEntry(action, details = {}) {
      const entry = {
        timestamp: Date.now(),
        action,
        details,
        prevHash: state.lastHash || '0'.repeat(64)
      };
      
      const entryHash = await sha256Base64(JSON.stringify(entry));
      entry.hash = entryHash;
      state.lastHash = entryHash;
      state.auditLog.push(entry);
      
      log(`Audit: ${action} â†’ hash: ${entryHash.slice(0, 16)}...`, 'info');
      return entry;
    }
    
    // ========================================
    // STEP HANDLERS
    // ========================================
    
    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      // Check DDC SDK availability
      await checkDDCConnection();
      
      // Generate agent keypair
      const agentSeed = nacl.util.decodeUTF8('proofi-health-agent-v1-demo00000');
      state.agentSigningKeyPair = generateSigningKeyPair(agentSeed);
      state.agentKeyPair = nacl.box.keyPair.fromSecretKey(agentSeed);
      
      document.getElementById('agentPubKey').textContent = 
        nacl.util.encodeBase64(state.agentKeyPair.publicKey);
      
      // Show sample data preview
      const preview = JSON.stringify(SAMPLE_HEALTH_DATA, null, 2);
      document.getElementById('sampleDataPreview').textContent = 
        preview.slice(0, 500) + '\n... (' + preview.length + ' bytes total)';
      
      // Setup scope toggles (enhanced)
      initScopeToggles();
      initAgentSelection();
      initExpiryOptions();
      updateScopeSummary();
      updateReviewPanel();
      
      // Initialize ProofiSDK for wallet signing (optional, for extension integration)
      try {
        if (typeof ProofiSDK !== 'undefined') {
          state.proofiSDK = new ProofiSDK({
            walletUrl: 'https://proofi-virid.vercel.app/app',
            appName: 'Health Analyzer'
          });
          log('ProofiSDK initialized for wallet signing', 'success');
        }
      } catch (e) {
        log('ProofiSDK not available: ' + e.message, 'warn');
      }

      log('Demo initialized with DIRECT DDC SDK integration', 'success');
      log(`Agent public key: ${nacl.util.encodeBase64(state.agentKeyPair.publicKey).slice(0, 20)}...`, 'crypto');

      // Check for Polkadot.js extension
      if (window.injectedWeb3 && Object.keys(window.injectedWeb3).length > 0) {
        log('Polkadot.js extension detected', 'success');
      }
    });
    
    function toggleStep(stepNum) {
      const step = document.getElementById(`step${stepNum}`);
      if (step.classList.contains('completed') || step.classList.contains('active')) {
        step.classList.toggle('expanded');
      }
    }
    
    function scrollToStep(n) {
      document.getElementById(`step${n}`).scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function updateStep(stepNum, status) {
      const step = document.getElementById(`step${stepNum}`);
      const statusEl = step.querySelector('.step-status');

      step.classList.remove('active', 'completed');

      if (status === 'active') {
        step.classList.add('active');
        statusEl.textContent = 'In Progress';
        setTimeout(() => scrollToStep(stepNum), 300);
      } else if (status === 'completed') {
        step.classList.add('completed');
        statusEl.textContent = 'Complete';
      } else {
        statusEl.textContent = 'Locked';
      }

      updateProgressBar();
    }

    function updateProgressBar() {
      const nodes = document.querySelectorAll('.progress-node');
      let lastCompleted = 0;
      nodes.forEach(node => {
        const n = parseInt(node.dataset.step);
        const stepEl = document.getElementById(`step${n}`);
        node.classList.remove('active', 'completed');
        const label = node.querySelector('.progress-node-label');
        if (stepEl.classList.contains('completed')) {
          node.classList.add('completed');
          node.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>';
          node.appendChild(label);
          lastCompleted = n;
        } else if (stepEl.classList.contains('active')) {
          node.classList.add('active');
        }
      });
      const pct = (lastCompleted / 4) * 100;
      document.getElementById('progressLine').style.width = `calc(${pct}% - ${pct > 0 ? 24 : 0}px)`;
    }
    
    // Generate a simple mnemonic from seed (for demo purposes)
    function generateMnemonic(seed) {
      // Simple word list (BIP39 subset for demo)
      const words = [
        'abandon', 'ability', 'able', 'about', 'above', 'absent', 'absorb', 'abstract',
        'absurd', 'abuse', 'access', 'accident', 'account', 'accuse', 'achieve', 'acid',
        'acoustic', 'acquire', 'across', 'act', 'action', 'actor', 'actress', 'actual',
        'adapt', 'add', 'addict', 'address', 'adjust', 'admit', 'adult', 'advance',
        'advice', 'aerobic', 'affair', 'afford', 'afraid', 'again', 'age', 'agent',
        'agree', 'ahead', 'aim', 'air', 'airport', 'aisle', 'alarm', 'album'
      ];
      
      const mnemonic = [];
      for (let i = 0; i < 12; i++) {
        const index = seed[i % seed.length] % words.length;
        mnemonic.push(words[index]);
      }
      return mnemonic.join(' ');
    }
    
    // Step 1: Connect Wallet
    async function connectWallet(useExisting = false) {
      log('Setting up wallet for DDC access...', 'crypto');

      let seed;
      const seedInput = document.getElementById('seedInput').value.trim();

      if (useExisting && seedInput) {
        // Use provided seed phrase as mnemonic
        state.walletMnemonic = seedInput;
        seed = await sha256(seedInput);
        seed = seed.slice(0, 32);
        log('Using imported seed phrase for DDC signing', 'crypto');
      } else {
        // Generate new seed and mnemonic
        seed = randomBytes(32);
        state.walletMnemonic = generateMnemonic(seed);
        log('Generated new mnemonic for DDC signing', 'crypto');
      }

      // Generate signing keypair (Ed25519)
      state.userKeyPair = generateSigningKeyPair(seed);
      log('Ed25519 keypair generated', 'crypto');

      // Generate encryption keypair (X25519)
      state.userX25519 = nacl.box.keyPair.fromSecretKey(seed);
      log('X25519 keypair generated', 'crypto');

      // Derive DID
      const did = deriveDID(state.userKeyPair.publicKey);

      // Update UI
      const pubKeyB64 = nacl.util.encodeBase64(state.userKeyPair.publicKey);
      const x25519B64 = nacl.util.encodeBase64(state.userX25519.publicKey);

      document.getElementById('userPubKey').textContent = pubKeyB64;
      document.getElementById('userDID').textContent = did;
      document.getElementById('userX25519').textContent = x25519B64;
      document.getElementById('walletResult').style.display = 'block';

      // Update wallet UI
      document.getElementById('walletDot').classList.add('connected');
      document.getElementById('walletAddr').textContent =
        pubKeyB64.slice(0, 8) + '...' + pubKeyB64.slice(-6);

      // Add mnemonic display for demo purposes
      const walletResultEl = document.getElementById('walletResult');
      const kvGrid = walletResultEl.querySelector('.kv-grid');

      const mnemonicItem = document.createElement('div');
      mnemonicItem.className = 'kv-item';
      mnemonicItem.innerHTML = `
        <div class="kv-content">
          <div class="kv-key">DDC Signer Mnemonic (for demo - keep secret!)</div>
          <div class="kv-value pending" style="font-size: 11px;">${state.walletMnemonic.split(' ').slice(0, 4).join(' ')}... (12 words)</div>
        </div>
      `;
      kvGrid.appendChild(mnemonicItem);

      const modeItem = document.createElement('div');
      modeItem.className = 'kv-item';
      modeItem.innerHTML = `
        <div class="kv-content">
          <div class="kv-key">Storage Mode</div>
          <div class="kv-value success">Direct DDC SDK (no API proxy)</div>
        </div>
      `;
      kvGrid.insertBefore(modeItem, kvGrid.firstChild);

      // Audit
      await addAuditEntry('WALLET_CONNECTED', {
        publicKey: pubKeyB64,
        did,
        mode: 'ddc-direct'
      });

      // Progress
      updateStep(1, 'completed');
      updateStep(2, 'active');
      document.getElementById('uploadBtn').disabled = false;

      log(`Wallet ready for direct DDC uploads: ${did}`, 'success');
    }
    
    // Step 2: Upload Health Data
    async function uploadHealthData() {
      log('Starting health data encryption...', 'crypto');
      
      state.healthData = SAMPLE_HEALTH_DATA;
      
      // Generate DEK (Data Encryption Key) - 32 bytes for AES-256
      state.dek = randomBytes(32);
      const dekB64 = nacl.util.encodeBase64(state.dek);
      log(`Generated DEK (AES-256): ${dekB64.slice(0, 20)}...`, 'crypto');
      
      // Encrypt health data with AES-256-GCM
      const jsonData = JSON.stringify(state.healthData);
      log(`Encrypting ${jsonData.length} bytes of health data...`, 'crypto');
      
      state.encryptedData = await encryptAES(jsonData, state.dek);
      log(`Encrypted: ${state.encryptedData.ciphertext.length} bytes ciphertext`, 'crypto');
      
      // Use default bucket
      state.bucketId = DDC_CONFIG.defaultBucket;
      log(`Target Bucket ID: ${state.bucketId}`, 'ddc');
      
      // Store to DDC directly via SDK
      let result;
      try {
        result = await ddcStorage.store(state.bucketId, state.encryptedData);
        state.dataCid = result.cid;
      } catch (err) {
        log(`Upload failed: ${err.message}`, 'error');
        // Show error in UI
        const uploadResultEl = document.getElementById('uploadResult');
        uploadResultEl.innerHTML = `
          <div class="kv-grid">
            <div class="kv-item">
              <div class="kv-content">
                <div class="kv-key" style="color: var(--error);">DDC Direct Upload Failed</div>
                <div class="kv-value" style="color: var(--error);">${escapeHtml(err.message)}</div>
              </div>
            </div>
            <div class="kv-item">
              <div class="kv-content">
                <div class="kv-key">Troubleshooting</div>
                <div class="kv-value">1. Make sure DDC SDK is loaded<br>2. Wallet needs CERE tokens for gas<br>3. Check browser console for details</div>
              </div>
            </div>
          </div>
          <button class="btn btn-secondary" onclick="uploadHealthData()" style="margin-top: 16px;">Retry Upload</button>
        `;
        uploadResultEl.style.display = 'block';
        return;
      }

      // Update UI
      document.getElementById('storageMode').textContent = 'Direct DDC SDK â†’ Cere Mainnet';
      document.getElementById('bucketId').textContent = state.bucketId.toString();
      document.getElementById('dataCid').textContent = result.cid;
      document.getElementById('ddcUrl').textContent = result.cdnUrl;
      document.getElementById('dekDisplay').textContent = dekB64.slice(0, 24) + '... (keep secret!)';
      document.getElementById('encDetails').textContent =
        `AES-256-GCM | IV: ${state.encryptedData.iv.slice(0, 12)}... | ${state.encryptedData.ciphertext.length} bytes`;

      document.getElementById('uploadResult').style.display = 'block';
      
      // Audit
      await addAuditEntry('DATA_UPLOADED', {
        bucketId: state.bucketId.toString(),
        cid: result.cid,
        algorithm: 'AES-256-GCM',
        sizeBytes: state.encryptedData.ciphertext.length,
        storageMode: 'ddc-direct',
        cdnUrl: result.cdnUrl
      });
      
      // Progress
      updateStep(2, 'completed');
      updateStep(3, 'active');
      document.getElementById('grantBtn').disabled = false;
      
      log(`Health data encrypted and stored directly to DDC`, 'success');
    }
    
    // ========================================
    // GRANULAR PERMISSIONS UI
    // ========================================
    
    // Scope configuration with record counts
    const SCOPE_CONFIG = {
      'steps': { path: 'health/steps', records: 142847, perms: 'read' },
      'sleep': { path: 'health/sleep', records: 1461, perms: 'read' },
      'heart': { path: 'health/heart', records: 298421, perms: 'read' },
      'hrv': { path: 'health/hrv', records: 52104, perms: 'read' },
      'blood-oxygen': { path: 'health/blood-oxygen', records: 8293, perms: 'read' }
    };
    
    // Agent configuration
    const AGENT_CONFIG = {
      'health-analyzer': {
        name: 'Health Analyzer Agent v1.0',
        defaultScopes: ['steps', 'sleep', 'heart']
      },
      'fitness-coach': {
        name: 'Fitness Coach Agent v1.0',
        defaultScopes: ['steps', 'heart', 'hrv']
      },
      'sleep-optimizer': {
        name: 'Sleep Optimizer Agent v1.0',
        defaultScopes: ['sleep', 'heart', 'blood-oxygen']
      },
      'external-device': {
        name: 'External Device (Ollama)',
        defaultScopes: ['steps', 'sleep', 'heart'],
        isExternal: true
      }
    };
    
    // Current selected agent
    state.selectedAgent = 'health-analyzer';
    
    // Initialize scope toggles
    function initScopeToggles() {
      document.querySelectorAll('.scope-item-enhanced').forEach(item => {
        const checkbox = item.querySelector('input[type="checkbox"]');
        
        item.addEventListener('click', (e) => {
          // Don't toggle if clicking directly on checkbox (it handles itself)
          if (e.target.type !== 'checkbox') {
            checkbox.checked = !checkbox.checked;
          }
          item.classList.toggle('selected', checkbox.checked);
          updateScopeSummary();
          updateReviewPanel();
        });
        
        checkbox.addEventListener('change', () => {
          item.classList.toggle('selected', checkbox.checked);
          updateScopeSummary();
          updateReviewPanel();
        });
      });
    }
    
    // Initialize agent selection
    function initAgentSelection() {
      document.querySelectorAll('.agent-card').forEach(card => {
        card.addEventListener('click', (e) => {
          // Don't trigger if clicking the button directly
          if (e.target.closest('.agent-select-btn')) return;
          selectAgent(card.dataset.agent);
        });
      });
    }
    
    // Initialize expiry options
    function initExpiryOptions() {
      document.querySelectorAll('input[name="tokenExpiry"]').forEach(radio => {
        radio.addEventListener('change', () => {
          // Update button styles
          document.querySelectorAll('.expiry-btn').forEach(btn => btn.classList.remove('selected'));
          radio.nextElementSibling.classList.add('selected');
          updateReviewPanel();
        });
      });
    }
    
    // Select an agent
    function selectAgent(agentId) {
      state.selectedAgent = agentId;
      const config = AGENT_CONFIG[agentId];
      
      // Update card selection UI
      document.querySelectorAll('.agent-card').forEach(card => {
        const isSelected = card.dataset.agent === agentId;
        card.classList.toggle('selected', isSelected);
        const btn = card.querySelector('.agent-select-btn');
        if (isSelected) {
          btn.innerHTML = '<span class="check-icon">âœ“</span> Selected';
        } else {
          btn.textContent = 'Select Agent';
        }
      });
      
      // For external device, generate a new random agent keypair
      if (config.isExternal) {
        const newAgentSeed = randomBytes(32);
        state.agentKeyPair = nacl.box.keyPair.fromSecretKey(newAgentSeed);
        state.agentSigningKeyPair = generateSigningKeyPair(newAgentSeed);
        log('Generated new random keypair for external device', 'crypto');
      } else {
        // Use demo agent key for built-in agents
        const agentSeed = nacl.util.decodeUTF8('proofi-health-agent-v1-demo00000');
        state.agentKeyPair = nacl.box.keyPair.fromSecretKey(agentSeed);
        state.agentSigningKeyPair = generateSigningKeyPair(agentSeed);
      }
      
      // Update agent public key display
      document.getElementById('agentPubKey').textContent = 
        nacl.util.encodeBase64(state.agentKeyPair.publicKey);
      
      // Update agent name displays
      document.getElementById('selectedAgentName').textContent = config.name;
      document.getElementById('selectedAgentNameInline').textContent = config.name.replace(' Agent v1.0', '').replace(' (Ollama)', '');
      document.getElementById('reviewAgentName').textContent = config.name.replace(' Agent v1.0', '').replace(' (Ollama)', '');
      
      // Pre-select default scopes for this agent
      document.querySelectorAll('.scope-item-enhanced').forEach(item => {
        const scope = item.dataset.scope;
        const checkbox = item.querySelector('input[type="checkbox"]');
        const shouldSelect = config.defaultScopes.includes(scope);
        checkbox.checked = shouldSelect;
        item.classList.toggle('selected', shouldSelect);
      });
      
      updateScopeSummary();
      updateReviewPanel();
      log(`Selected agent: ${config.name}`, 'info');
    }
    
    // Update scope summary stats
    function updateScopeSummary() {
      const selectedScopes = getSelectedScopes();
      let totalRecords = 0;
      let maxSensitivity = 'LOW';
      
      selectedScopes.forEach(scope => {
        const config = SCOPE_CONFIG[scope.id];
        if (config) totalRecords += config.records;
        
        if (scope.sensitivity === 'high') maxSensitivity = 'HIGH';
        else if (scope.sensitivity === 'medium' && maxSensitivity !== 'HIGH') maxSensitivity = 'MEDIUM';
      });
      
      document.getElementById('selectedScopesCount').textContent = selectedScopes.length;
      document.getElementById('selectedRecordsCount').textContent = totalRecords.toLocaleString();
      
      const maxSensEl = document.getElementById('maxSensitivity');
      maxSensEl.textContent = maxSensitivity;
      maxSensEl.className = 'stat-value';
      if (maxSensitivity === 'HIGH') maxSensEl.style.color = 'var(--warning)';
      else if (maxSensitivity === 'MEDIUM') maxSensEl.style.color = 'var(--blue)';
      else maxSensEl.style.color = 'var(--success)';
    }
    
    // Get selected scopes
    function getSelectedScopes() {
      const scopes = [];
      document.querySelectorAll('.scope-item-enhanced.selected').forEach(item => {
        scopes.push({
          id: item.dataset.scope,
          sensitivity: item.dataset.sensitivity
        });
      });
      return scopes;
    }
    
    // Update permission review panel
    function updateReviewPanel() {
      const selectedScopes = getSelectedScopes();
      const reviewScopesEl = document.getElementById('reviewScopes');
      
      if (selectedScopes.length === 0) {
        reviewScopesEl.innerHTML = '<div class="review-scope-item"><em>No data selected</em></div>';
      } else {
        reviewScopesEl.innerHTML = selectedScopes.map(scope => {
          const config = SCOPE_CONFIG[scope.id];
          return `
            <div class="review-scope-item">
              <span class="scope-bullet">â€¢</span>
              <span class="scope-name">${scope.id}</span>
              <span class="scope-count">â€” ${config ? config.records.toLocaleString() : '?'} records</span>
            </div>
          `;
        }).join('');
      }
      
      // Update expiry display
      const selectedExpiry = document.querySelector('input[name="tokenExpiry"]:checked');
      if (selectedExpiry) {
        const seconds = parseInt(selectedExpiry.value);
        let expiryText = '24 hours';
        if (seconds === 3600) expiryText = '1 hour';
        else if (seconds === 86400) expiryText = '24 hours';
        else if (seconds === 604800) expiryText = '7 days';
        document.getElementById('reviewExpiry').textContent = expiryText;
      }
    }
    
    // Reset scope selection
    function resetScopeSelection() {
      selectAgent(state.selectedAgent); // Reset to agent defaults
    }
    
    // Toggle token details visibility
    function toggleTokenDetails() {
      const details = document.getElementById('tokenFullDetails');
      const toggleText = document.getElementById('tokenDetailsToggleText');
      if (details.style.display === 'none') {
        details.style.display = 'block';
        toggleText.textContent = 'Hide Full Token';
      } else {
        details.style.display = 'none';
        toggleText.textContent = 'Show Full Token';
      }
    }
    
    // Step 3: Grant Permission
    async function grantPermission() {
      log('Creating capability token...', 'crypto');
      
      // Collect selected scopes from enhanced UI
      const scopes = [];
      document.querySelectorAll('.scope-item-enhanced.selected').forEach(item => {
        const scopeId = item.dataset.scope;
        const config = SCOPE_CONFIG[scopeId];
        if (config) {
          scopes.push({
            path: config.path + '/*',
            permissions: config.perms.split(',').map(p => p.trim()),
            records: config.records
          });
        }
      });
      
      if (scopes.length === 0) {
        log('Error: No scopes selected!', 'error');
        return;
      }
      
      // Get expiry from radio buttons
      const selectedExpiry = document.querySelector('input[name="tokenExpiry"]:checked');
      const expirySeconds = selectedExpiry ? parseInt(selectedExpiry.value) : 86400;
      const expiresAt = Math.floor(Date.now() / 1000) + expirySeconds;
      
      // Wrap DEK for agent
      log('Wrapping DEK for agent (X25519 + XSalsa20-Poly1305)...', 'crypto');
      const wrappedDEK = wrapDEK(state.dek, state.agentKeyPair.publicKey);
      log(`DEK wrapped with ephemeral key: ${wrappedDEK.ephemeralPublicKey.slice(0, 20)}...`, 'crypto');
      
      // Create token payload
      const tokenId = nacl.util.encodeBase64(randomBytes(16));
      const agentConfig = AGENT_CONFIG[state.selectedAgent];
      const tokenPayload = {
        v: 1,
        id: tokenId,
        iss: deriveDID(state.userKeyPair.publicKey),
        sub: nacl.util.encodeBase64(state.agentKeyPair.publicKey),
        agentName: agentConfig.name,
        iat: Math.floor(Date.now() / 1000),
        exp: expiresAt,
        scopes,
        bucketId: state.bucketId.toString(),
        resources: [state.dataCid],
        cdnUrl: `${DDC_CONFIG.cdnUrlAlt}/${state.bucketId}/${state.dataCid}`,
        wrappedDEK
      };
      
      // Sign token with Ed25519
      const payloadString = JSON.stringify(tokenPayload);
      const signature = signMessage(payloadString, state.userKeyPair.privateKey);
      log(`Token signed with Ed25519: ${signature.slice(0, 20)}...`, 'crypto');
      
      state.capabilityToken = {
        ...tokenPayload,
        sig: signature,
        sigAlg: 'Ed25519'
      };
      
      // Hide the selection phases, show token result
      document.getElementById('agentSelectionPhase').style.display = 'none';
      document.getElementById('scopeSelectionPhase').style.display = 'none';
      document.getElementById('reviewPhase').style.display = 'none';
      
      // Update token result UI
      document.getElementById('tokenDisplay').textContent = 
        JSON.stringify(state.capabilityToken, null, 2);
      document.getElementById('tokenId').textContent = tokenId;
      document.getElementById('wrappedDek').textContent = 
        `${wrappedDEK.ciphertext.slice(0, 30)}... (${wrappedDEK.ciphertext.length} bytes)`;
      
      // Update the new token details cards
      const scopeNames = scopes.map(s => s.path.split('/')[1]).join(', ');
      document.getElementById('grantedScopes').textContent = scopeNames;
      document.getElementById('tokenExpiryDisplay').textContent = new Date(expiresAt * 1000).toLocaleString();
      document.getElementById('tokenStatusDisplay').innerHTML = 
        '<span class="revocation-status active">ACTIVE</span>';
      
      document.getElementById('tokenResult').style.display = 'block';

      // Show revoke button
      const revokeBtn = document.getElementById('revokeBtn');
      revokeBtn.style.display = 'inline-flex';
      state.tokenRevoked = false;

      // Audit
      await addAuditEntry('TOKEN_CREATED', {
        tokenId,
        agent: agentConfig.name,
        scopes: scopes.map(s => s.path),
        expiresAt: new Date(expiresAt * 1000).toISOString(),
        agentKey: nacl.util.encodeBase64(state.agentKeyPair.publicKey).slice(0, 20)
      });
      
      // Check if this is external device mode
      const isExternalDevice = agentConfig.isExternal;
      
      if (isExternalDevice) {
        // Show external device section with QR code
        document.getElementById('externalDeviceSection').style.display = 'block';
        
        // Generate QR code with the token
        await generateExternalQRCode();
        
        // Progress - don't auto-activate step 4 for external
        updateStep(3, 'completed');
        
        log(`External device token created!`, 'success');
        log(`Scan QR code or copy token to run on your Mac/PC`, 'success');
      } else {
        // Normal flow - hide external device section
        document.getElementById('externalDeviceSection').style.display = 'none';
        
        // Progress
        updateStep(3, 'completed');
        updateStep(4, 'active');
        document.getElementById('runAgentBtn').disabled = false;
        
        log(`Capability token created for ${agentConfig.name}`, 'success');
      }
      
      log(`Granted scopes: ${scopeNames}`, 'success');
    }
    
    function copyToken() {
      navigator.clipboard.writeText(JSON.stringify(state.capabilityToken, null, 2));
      log('Token copied to clipboard', 'success');
    }
    
    // Export token + agent key for CLI usage
    function exportForCLI() {
      if (!state.capabilityToken || !state.agentKeyPair) {
        log('No token or agent key to export!', 'error');
        return;
      }
      
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
      
      // 1. Export capability token
      const tokenBlob = new Blob([JSON.stringify(state.capabilityToken, null, 2)], { type: 'application/json' });
      const tokenUrl = URL.createObjectURL(tokenBlob);
      const tokenLink = document.createElement('a');
      tokenLink.href = tokenUrl;
      tokenLink.download = `proofi-token-${timestamp}.json`;
      tokenLink.click();
      URL.revokeObjectURL(tokenUrl);
      
      // 2. Export agent private key
      const agentKeyExport = {
        type: 'proofi-agent-key-v1',
        algorithm: 'X25519',
        secretKey: nacl.util.encodeBase64(state.agentKeyPair.secretKey),
        publicKey: nacl.util.encodeBase64(state.agentKeyPair.publicKey),
        exportedAt: new Date().toISOString(),
        warning: 'Keep this file secure!'
      };
      
      const keyBlob = new Blob([JSON.stringify(agentKeyExport, null, 2)], { type: 'application/json' });
      const keyUrl = URL.createObjectURL(keyBlob);
      const keyLink = document.createElement('a');
      keyLink.href = keyUrl;
      keyLink.download = `proofi-agent-key-${timestamp}.json`;
      setTimeout(() => {
        keyLink.click();
        URL.revokeObjectURL(keyUrl);
      }, 500);
      
      log('Exported token + agent key for CLI usage', 'success');
    }
    
    // ========================================
    // EXTERNAL DEVICE FUNCTIONS
    // ========================================
    
    // Generate QR code containing the capability token
    async function generateExternalQRCode() {
      if (!state.capabilityToken || !window.QRCode) {
        log('Cannot generate QR code: missing token or QRCode library', 'error');
        return;
      }
      
      // Create a compact token for QR code (includes everything needed for CLI)
      const externalToken = {
        v: 1,
        id: state.capabilityToken.id,
        bucketId: state.capabilityToken.bucketId,
        cid: state.capabilityToken.resources[0],
        cdnUrl: state.capabilityToken.cdnUrl,
        exp: state.capabilityToken.exp,
        scopes: state.capabilityToken.scopes.map(s => s.path.split('/')[1]),
        wrappedDEK: state.capabilityToken.wrappedDEK,
        agentKey: nacl.util.encodeBase64(state.agentKeyPair.secretKey),
        sig: state.capabilityToken.sig
      };
      
      // Store full token for later
      state.externalToken = externalToken;
      
      // Generate QR code
      const canvas = document.getElementById('qrCodeCanvas');
      const tokenString = JSON.stringify(externalToken);
      
      try {
        await QRCode.toCanvas(canvas, tokenString, {
          width: 200,
          margin: 2,
          color: {
            dark: '#1d1d1f',
            light: '#ffffff'
          }
        });
        log(`QR code generated (${tokenString.length} bytes)`, 'success');
      } catch (err) {
        // Token might be too large for QR code - show a URL instead
        log(`Token too large for QR code (${tokenString.length} bytes), showing shortened version`, 'warn');
        
        // Create a data URL for smaller payload
        const shortToken = {
          u: state.capabilityToken.cdnUrl,
          k: state.externalToken.agentKey.slice(0, 43), // First 32 bytes base64
          e: state.capabilityToken.exp,
          n: state.externalToken.wrappedDEK.nonce,
          c: state.externalToken.wrappedDEK.ciphertext.slice(0, 50) + '...'
        };
        
        const shortString = JSON.stringify(shortToken);
        
        try {
          await QRCode.toCanvas(canvas, shortString, {
            width: 200,
            margin: 2,
            color: {
              dark: '#1d1d1f',
              light: '#ffffff'
            }
          });
          log('QR code generated with shortened token - use Copy or Download for full token', 'warn');
        } catch (e2) {
          // Show placeholder text
          const ctx = canvas.getContext('2d');
          canvas.width = 200;
          canvas.height = 200;
          ctx.fillStyle = '#f5f5f7';
          ctx.fillRect(0, 0, 200, 200);
          ctx.fillStyle = '#86868b';
          ctx.font = '14px system-ui';
          ctx.textAlign = 'center';
          ctx.fillText('Token too large', 100, 90);
          ctx.fillText('for QR code', 100, 110);
          ctx.fillText('Use Copy/Download', 100, 140);
          log('Token too large for QR, use Copy or Download buttons', 'warn');
        }
      }
    }
    
    // Copy external token to clipboard
    function copyExternalToken() {
      if (!state.externalToken) {
        log('No external token to copy!', 'error');
        return;
      }
      
      const tokenString = JSON.stringify(state.externalToken);
      navigator.clipboard.writeText(tokenString);
      log(`External token copied to clipboard (${tokenString.length} bytes)`, 'success');
      
      // Visual feedback
      event.target.textContent = 'âœ“ Copied!';
      setTimeout(() => {
        event.target.textContent = 'ðŸ“‹ Copy Token';
      }, 2000);
    }
    
    // Download external token as file
    function downloadExternalToken() {
      if (!state.externalToken) {
        log('No external token to download!', 'error');
        return;
      }
      
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
      const tokenBlob = new Blob([JSON.stringify(state.externalToken, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(tokenBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `proofi-external-token-${timestamp}.json`;
      link.click();
      URL.revokeObjectURL(url);
      
      log('External token downloaded', 'success');
    }
    
    // Update token with callback URL
    function updateCallbackUrl() {
      const callbackUrl = document.getElementById('callbackUrlInput').value.trim();
      
      if (!callbackUrl) {
        log('No callback URL provided', 'warn');
        return;
      }
      
      if (!state.externalToken) {
        log('No external token to update!', 'error');
        return;
      }
      
      // Add callback URL to token
      state.externalToken.callback = callbackUrl;
      
      // Regenerate QR code
      generateExternalQRCode();
      
      log(`Callback URL added: ${callbackUrl}`, 'success');
    }
    
    // Import results from external analysis
    async function importExternalResults() {
      const resultsInput = document.getElementById('externalResultsInput').value.trim();
      
      if (!resultsInput) {
        log('No results to import!', 'error');
        return;
      }
      
      try {
        const results = JSON.parse(resultsInput);
        
        log('Importing external analysis results...', 'info');
        
        // Validate required fields
        if (!results.analysis && !results.recommendations) {
          throw new Error('Results must contain "analysis" or "recommendations" fields');
        }
        
        // Map external results to our format
        const analysis = {
          avgSleep: results.analysis?.avgSleep || results.avgSleep || 7.5,
          avgQuality: results.analysis?.avgQuality || results.avgQuality || 75,
          avgDeep: results.analysis?.avgDeep || results.avgDeep || 1.5,
          avgRem: results.analysis?.avgRem || results.avgRem || 1.8,
          avgHR: results.analysis?.avgHR || results.avgHR || 72,
          avgRestingHR: results.analysis?.avgRestingHR || results.avgRestingHR || 65,
          avgHRV: results.analysis?.avgHRV || results.avgHRV || 45,
          maxHR: results.analysis?.maxHR || results.maxHR || 165,
          minHR: results.analysis?.minHR || results.minHR || 52,
          sleepScore: results.analysis?.sleepScore || results.sleepScore || 78,
          heartScore: results.analysis?.heartScore || results.heartScore || 82,
          recommendations: results.recommendations || results.analysis?.recommendations || [
            'Analysis completed by external Ollama instance',
            'Results imported successfully'
          ],
          recordsAnalyzed: results.recordsAnalyzed || results.analysis?.recordsAnalyzed || 130,
          scopeInfo: { sleepGranted: true, heartGranted: true },
          source: 'external-ollama',
          model: results.model || 'unknown'
        };
        
        // Audit
        await addAuditEntry('EXTERNAL_RESULTS_IMPORTED', {
          source: analysis.source,
          model: analysis.model,
          recordsAnalyzed: analysis.recordsAnalyzed
        });
        
        // Hide waiting section
        document.getElementById('externalWaitingSection').style.display = 'none';
        
        // Show success message in external device section
        const externalSection = document.getElementById('externalDeviceSection');
        const successBanner = document.createElement('div');
        successBanner.style.cssText = 'background: rgba(52,199,89,0.08); border: 1px solid rgba(52,199,89,0.2); border-radius: var(--radius-sm); padding: 16px; margin-top: 16px; display: flex; align-items: center; gap: 12px;';
        successBanner.innerHTML = `
          <span style="font-size: 24px;">âœ…</span>
          <div>
            <div style="font-weight: 600; color: var(--success);">External Analysis Complete</div>
            <div style="font-size: 13px; color: var(--text-secondary);">Results imported from ${analysis.model}</div>
          </div>
        `;
        externalSection.querySelector('div').appendChild(successBanner);
        
        // Store results and show step 5
        state.analysisResults = analysis;
        await showResults(analysis);
        
        updateStep(4, 'completed');
        updateStep(5, 'active');
        
        log('External results imported successfully!', 'success');
        
      } catch (err) {
        log(`Failed to import results: ${err.message}`, 'error');
      }
    }
    
    // Step 4: Agent Execution
    async function runAgent() {
      log('Agent starting execution...', 'info');

      // Auto-open execution log
      document.getElementById('consolePanel').classList.add('open');

      document.getElementById('agentLoading').style.display = 'flex';
      document.getElementById('agentSteps').style.display = 'block';
      
      const token = state.capabilityToken;
      
      // Step 4.1: Validate signature
      await sleep(500);
      log('Agent: Validating token signature...', 'crypto');
      
      const payloadForVerify = { ...token };
      delete payloadForVerify.sig;
      delete payloadForVerify.sigAlg;
      const payloadString = JSON.stringify(payloadForVerify);
      
      const issuerPubKey = state.userKeyPair.publicKey;
      const isValidSig = verifySignature(payloadString, token.sig, issuerPubKey);
      
      if (!isValidSig) {
        log('Agent: SIGNATURE INVALID!', 'error');
        updateAgentStep(1, false, 'Signature invalid!');
        return;
      }
      
      updateAgentStep(1, true, 'Signature valid (Ed25519)');
      log('Agent: Signature verified', 'success');

      // Step 4.2: Check revocation, expiry & scopes
      await sleep(400);
      log('Agent: Checking revocation status...', 'info');

      const revStatus = await checkRevocationStatus(token.id);
      if (revStatus.revoked) {
        log('Agent: TOKEN REVOKED!', 'error');
        updateAgentStep(2, false, 'Token revoked!');
        await addAuditEntry('AGENT_REJECTED', { reason: 'token_revoked', tokenId: token.id });
        return;
      }
      log('Agent: Token not revoked', 'success');

      log('Agent: Checking expiry and scopes...', 'info');

      const now = Math.floor(Date.now() / 1000);
      if (token.exp < now) {
        log('Agent: TOKEN EXPIRED!', 'error');
        updateAgentStep(2, false, 'Token expired!');
        return;
      }
      
      const hasReadScope = token.scopes.some(s => 
        s.permissions.includes('read') && 
        (s.path.includes('health/sleep') || s.path.includes('health/heart'))
      );
      
      if (!hasReadScope) {
        log('Agent: INSUFFICIENT SCOPES!', 'error');
        updateAgentStep(2, false, 'No read permission!');
        return;
      }
      
      updateAgentStep(2, true, `Valid until ${new Date(token.exp * 1000).toLocaleString()}`);
      log(`Agent: Token valid for ${token.exp - now} more seconds`, 'success');
      
      // Step 4.3: Unwrap DEK
      await sleep(500);
      log('Agent: Unwrapping DEK with agent private key...', 'crypto');
      
      let unwrappedDEK;
      try {
        unwrappedDEK = unwrapDEK(token.wrappedDEK, state.agentKeyPair.secretKey);
        log(`Agent: DEK unwrapped successfully (${unwrappedDEK.length} bytes)`, 'success');
      } catch (err) {
        log(`Agent: DEK unwrap failed - ${err.message}`, 'error');
        updateAgentStep(3, false, 'DEK unwrap failed!');
        return;
      }
      
      updateAgentStep(3, true, `DEK recovered (${unwrappedDEK.length} bytes)`);
      
      // Step 4.4: Fetch & decrypt data
      await sleep(600);
      log(`Agent: Fetching data from DDC bucket ${token.bucketId}...`, 'ddc');
      
      let encryptedBlob;
      try {
        encryptedBlob = await ddcStorage.fetch(BigInt(token.bucketId), token.resources[0]);
      } catch (err) {
        log(`Agent: DDC fetch failed - ${err.message}`, 'error');
        updateAgentStep(4, false, 'Fetch failed!');
        return;
      }
      
      log('Agent: Decrypting with AES-256-GCM...', 'crypto');
      
      let healthData;
      try {
        const decrypted = await decryptAES(encryptedBlob.ciphertext, encryptedBlob.iv, unwrappedDEK);
        healthData = JSON.parse(decrypted);
        log(`Agent: Decrypted ${decrypted.length} bytes of health data`, 'success');
      } catch (err) {
        log(`Agent: Decryption failed - ${err.message}`, 'error');
        updateAgentStep(4, false, 'Decryption failed!');
        return;
      }
      
      // Filter data based on granted scopes
      const grantedPaths = token.scopes.map(s => s.path);
      const filteredData = { version: healthData.version, exportedAt: healthData.exportedAt };
      
      const hasSleepScope = grantedPaths.some(p => p.includes('health/sleep'));
      const hasHeartScope = grantedPaths.some(p => p.includes('health/heart'));
      
      if (hasSleepScope) {
        filteredData.sleep = healthData.sleep;
        log(`Agent: Sleep data access GRANTED (${healthData.sleep.length} records)`, 'success');
      } else {
        filteredData.sleep = [];
        log('Agent: Sleep data access DENIED by scope', 'warn');
      }
      
      if (hasHeartScope) {
        filteredData.heartRate = healthData.heartRate;
        log(`Agent: Heart rate access GRANTED (${healthData.heartRate.length} records)`, 'success');
      } else {
        filteredData.heartRate = [];
        log('Agent: Heart rate access DENIED by scope', 'warn');
      }
      
      const accessSummary = [
        hasSleepScope ? `${filteredData.sleep.length} sleep` : null,
        hasHeartScope ? `${filteredData.heartRate.length} HR` : null
      ].filter(Boolean).join(' + ') || 'No data (check scopes)';
      
      updateAgentStep(4, true, accessSummary);
      
      // Step 4.5: Run analysis
      await sleep(700);
      
      let analysis;
      if (state.useOllama) {
        log(`Agent: Running analysis via local Ollama (${state.ollamaModel})...`, 'info');
        updateAgentStep(5, false, `Calling ${state.ollamaModel}...`);
        try {
          analysis = await analyzeWithOllama(filteredData);
          updateAgentStep(5, true, `âœ“ ${state.ollamaModel} (local)`);
          log('Agent: Ollama analysis complete!', 'success');
        } catch (err) {
          log(`Agent: Ollama failed, falling back to built-in analysis: ${err.message}`, 'warn');
          analysis = analyzeHealthData(filteredData);
          updateAgentStep(5, true, 'Fallback: built-in');
        }
      } else {
        log('Agent: Running built-in health analysis...', 'info');
        analysis = analyzeHealthData(filteredData);
        updateAgentStep(5, true, 'Analysis complete!');
        log('Agent: Analysis complete!', 'success');
      }
      
      // Audit
      await addAuditEntry('AGENT_EXECUTED', {
        tokenId: token.id,
        recordsAnalyzed: healthData.sleep.length + healthData.heartRate.length,
        analysisVersion: '1.0',
        fetchSource: 'ddc-direct',
        analyzerType: state.useOllama ? 'ollama-local' : 'built-in',
        ollamaModel: state.useOllama ? state.ollamaModel : null
      });
      
      await addAuditEntry('ANALYSIS_COMPLETE', {
        avgSleepHours: analysis.avgSleep?.toFixed(2) || 'N/A',
        avgHeartRate: analysis.avgHR || 'N/A',
        sleepScore: analysis.sleepScore || 'N/A',
        heartScore: analysis.heartScore || 'N/A',
        source: analysis.source || 'built-in',
        model: analysis.model || null
      });
      
      document.getElementById('agentLoading').style.display = 'none';
      
      // Store results and show step 5
      state.analysisResults = analysis;
      await showResults(analysis);
      
      updateStep(4, 'completed');
      updateStep(5, 'active');
    }
    
    function updateAgentStep(stepNum, success, message) {
      const step = document.getElementById(`agentStep${stepNum}`);
      const value = step.querySelector('.kv-value');

      value.textContent = message;
      value.className = 'kv-value ' + (success ? 'success' : '');
    }
    
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    // ========================================
    // OLLAMA INTEGRATION
    // ========================================
    
    state.useOllama = false;
    state.ollamaUrl = 'http://localhost:11434';
    state.ollamaModel = 'llama3.2';
    
    function toggleOllamaMode() {
      const toggle = document.getElementById('useOllamaToggle');
      const config = document.getElementById('ollamaConfig');
      state.useOllama = toggle.checked;
      config.style.display = toggle.checked ? 'block' : 'none';
      log(`Ollama mode: ${toggle.checked ? 'enabled' : 'disabled'}`, 'info');
    }
    
    async function testOllamaConnection() {
      const statusEl = document.getElementById('ollamaStatus');
      const url = document.getElementById('ollamaUrl').value;
      state.ollamaUrl = url;
      state.ollamaModel = document.getElementById('ollamaModel').value;
      
      statusEl.textContent = 'Testing...';
      statusEl.style.color = 'var(--text-tertiary)';
      
      try {
        const response = await fetch(`${url}/api/tags`, { 
          method: 'GET',
          signal: AbortSignal.timeout(5000)
        });
        
        if (response.ok) {
          const data = await response.json();
          const models = data.models?.map(m => m.name) || [];
          statusEl.textContent = `âœ“ Connected! Models: ${models.slice(0, 3).join(', ')}${models.length > 3 ? '...' : ''}`;
          statusEl.style.color = 'var(--accent)';
          log(`Ollama connected at ${url}. Available models: ${models.join(', ')}`, 'success');
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (err) {
        statusEl.textContent = `âœ— Failed: ${err.message}`;
        statusEl.style.color = 'var(--red)';
        log(`Ollama connection failed: ${err.message}`, 'error');
      }
    }
    
    async function analyzeWithOllama(healthData) {
      const url = state.ollamaUrl;
      const model = state.ollamaModel;
      
      log(`Calling Ollama (${model}) at ${url}...`, 'info');
      
      // Build a summary of the health data
      const sleepSummary = healthData.sleep?.length > 0 
        ? `Sleep data: ${healthData.sleep.length} nights, avg ${(healthData.sleep.reduce((a,s) => a + s.duration, 0) / healthData.sleep.length).toFixed(1)}h`
        : 'Sleep data: not available';
      
      const hrSummary = healthData.heartRate?.length > 0
        ? `Heart rate: ${healthData.heartRate.length} readings, avg ${Math.round(healthData.heartRate.reduce((a,h) => a + h.bpm, 0) / healthData.heartRate.length)} BPM`
        : 'Heart rate: not available';
      
      const prompt = `You are a health analysis AI. Analyze this health data and provide insights.

${sleepSummary}
${hrSummary}

${healthData.sleep?.length > 0 ? `Sleep details (last 7 days): ${JSON.stringify(healthData.sleep.slice(-7))}` : ''}
${healthData.heartRate?.length > 0 ? `Heart rate details (last 10): ${JSON.stringify(healthData.heartRate.slice(-10))}` : ''}

Provide a brief analysis with:
1. Overall health assessment (1-2 sentences)
2. Sleep quality insights (if data available)
3. Heart health insights (if data available)  
4. 2-3 actionable recommendations

Keep response under 200 words. Be specific with numbers.`;

      try {
        const response = await fetch(`${url}/api/generate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: model,
            prompt: prompt,
            stream: false
          }),
          signal: AbortSignal.timeout(60000) // 60s timeout
        });
        
        if (!response.ok) {
          throw new Error(`Ollama returned ${response.status}`);
        }
        
        const result = await response.json();
        log(`Ollama analysis complete (${result.eval_count || '?'} tokens)`, 'success');
        
        // Parse Ollama response and create analysis object
        const analysis = parseOllamaResponse(result.response, healthData);
        analysis.model = model;
        analysis.source = 'ollama-local';
        analysis.rawResponse = result.response;
        
        return analysis;
      } catch (err) {
        log(`Ollama analysis failed: ${err.message}`, 'error');
        throw err;
      }
    }
    
    function parseOllamaResponse(response, healthData) {
      // Extract recommendations from response
      const lines = response.split('\n').filter(l => l.trim());
      const recommendations = lines.filter(l => 
        l.match(/^\d+[\.\)]/) || l.startsWith('-') || l.startsWith('â€¢')
      ).slice(0, 4).map(l => l.replace(/^[\d\.\)\-â€¢\s]+/, '').trim());
      
      if (recommendations.length === 0) {
        recommendations.push(response.slice(0, 150) + '...');
      }
      
      // Calculate basic stats from data
      const hasSleep = healthData.sleep?.length > 0;
      const hasHeart = healthData.heartRate?.length > 0;
      
      let avgSleep = null, sleepScore = null;
      if (hasSleep) {
        avgSleep = healthData.sleep.reduce((a, s) => a + s.duration, 0) / healthData.sleep.length;
        sleepScore = Math.min(100, Math.round(avgSleep / 8 * 100));
      }
      
      let avgHR = null, heartScore = null;
      if (hasHeart) {
        avgHR = Math.round(healthData.heartRate.reduce((a, h) => a + h.bpm, 0) / healthData.heartRate.length);
        heartScore = Math.max(0, 100 - Math.abs(avgHR - 70));
      }
      
      return {
        avgSleep,
        avgHR,
        sleepScore,
        heartScore,
        recommendations,
        recordsAnalyzed: (healthData.sleep?.length || 0) + (healthData.heartRate?.length || 0),
        scopeInfo: { sleepGranted: hasSleep, heartGranted: hasHeart },
        ollamaResponse: response
      };
    }
    
    // Health Analysis
    function analyzeHealthData(data) {
      const hasSleep = data.sleep && data.sleep.length > 0;
      const hasHeart = data.heartRate && data.heartRate.length > 0;
      
      let avgSleep = null, avgQuality = null, avgDeep = null, avgRem = null, sleepScore = null;
      if (hasSleep) {
        const sleepDurations = data.sleep.map(s => s.duration);
        const sleepQualities = data.sleep.map(s => s.quality);
        const deepSleep = data.sleep.map(s => s.deep);
        const remSleep = data.sleep.map(s => s.rem);
        
        avgSleep = sleepDurations.reduce((a, b) => a + b, 0) / sleepDurations.length;
        avgQuality = sleepQualities.reduce((a, b) => a + b, 0) / sleepQualities.length;
        avgDeep = deepSleep.reduce((a, b) => a + b, 0) / deepSleep.length;
        avgRem = remSleep.reduce((a, b) => a + b, 0) / remSleep.length;
        sleepScore = Math.round((avgQuality * 0.4) + ((avgSleep / 8) * 60 * 0.3) + ((avgDeep / 2) * 50 * 0.3));
      }
      
      let avgHR = null, avgRestingHR = null, avgHRV = null, maxHR = null, minHR = null, heartScore = null;
      if (hasHeart) {
        const heartRates = data.heartRate.map(h => h.bpm);
        const restingHR = data.heartRate.filter(h => h.context === 'resting').map(h => h.bpm);
        const variability = data.heartRate.map(h => h.variability);
        
        avgHR = Math.round(heartRates.reduce((a, b) => a + b, 0) / heartRates.length);
        avgRestingHR = restingHR.length > 0 
          ? Math.round(restingHR.reduce((a, b) => a + b, 0) / restingHR.length)
          : avgHR;
        avgHRV = Math.round(variability.reduce((a, b) => a + b, 0) / variability.length);
        maxHR = Math.max(...heartRates);
        minHR = Math.min(...heartRates);
        heartScore = Math.round(100 - Math.abs(avgRestingHR - 65) - (avgHRV < 30 ? 20 : 0));
      }
      
      const recommendations = [];
      if (hasSleep) {
        if (avgSleep < 7) recommendations.push('Try to get at least 7 hours of sleep');
        if (avgDeep < 1.5) recommendations.push('Your deep sleep is low â€” avoid caffeine after 2pm');
      }
      if (hasHeart) {
        if (avgRestingHR > 75) recommendations.push('Consider more cardio to lower resting heart rate');
        if (avgHRV < 30) recommendations.push('Low HRV detected â€” try stress reduction techniques');
      }
      if (!hasSleep && !hasHeart) {
        recommendations.push('No data available â€” check your scope permissions');
      } else if (recommendations.length === 0) {
        recommendations.push('Great job â€” your health metrics look excellent.');
      }
      
      if (!hasSleep) recommendations.push('Sleep data: not shared (scope denied)');
      if (!hasHeart) recommendations.push('Heart rate: not shared (scope denied)');
      
      return {
        avgSleep,
        avgQuality,
        avgDeep,
        avgRem,
        avgHR,
        avgRestingHR,
        avgHRV,
        maxHR,
        minHR,
        sleepScore,
        heartScore,
        recommendations,
        recordsAnalyzed: (data.sleep?.length || 0) + (data.heartRate?.length || 0),
        scopeInfo: { sleepGranted: hasSleep, heartGranted: hasHeart }
      };
    }
    
    // Step 5: Results
    async function showResults(analysis) {
      // Trust Chain Visual Summary
      const trustChainHtml = `
        <div class="trust-chain">
          <div class="trust-chain-title">Trust Chain</div>
          <div class="trust-chain-flow">
            <div class="trust-chain-node">
              <span class="tc-label">User Wallet</span>
              <span class="tc-detail">Ed25519 + X25519</span>
            </div>
            <div class="trust-chain-arrow">
              <span class="tc-arrow-line">â†’</span>
              <span class="tc-arrow-label">sign</span>
            </div>
            <div class="trust-chain-node">
              <span class="tc-label">Encrypted Data</span>
              <span class="tc-detail">AES-256-GCM + CID</span>
            </div>
            <div class="trust-chain-arrow">
              <span class="tc-arrow-line">â†’</span>
              <span class="tc-arrow-label">direct</span>
            </div>
            <div class="trust-chain-node">
              <span class="tc-label">DDC SDK</span>
              <span class="tc-detail">Wallet signs tx</span>
            </div>
            <div class="trust-chain-arrow">
              <span class="tc-arrow-line">â†’</span>
              <span class="tc-arrow-label">store</span>
            </div>
            <div class="trust-chain-node">
              <span class="tc-label">DDC Mainnet</span>
              <span class="tc-detail">Bucket ${state.bucketId || '1229'}</span>
            </div>
          </div>
        </div>
      `;

      // Analysis cards
      const resultsHtml = `
        <div class="analysis-card">
          <div class="analysis-value ${analysis.sleepScore >= 75 ? 'good' : analysis.sleepScore >= 50 ? 'warning' : 'bad'}">${analysis.sleepScore}</div>
          <div class="analysis-label">Sleep Score</div>
        </div>
        <div class="analysis-card">
          <div class="analysis-value ${analysis.heartScore >= 80 ? 'good' : analysis.heartScore >= 60 ? 'warning' : 'bad'}">${analysis.heartScore}</div>
          <div class="analysis-label">Heart Score</div>
        </div>
        <div class="analysis-card">
          <div class="analysis-value">${analysis.avgSleep.toFixed(1)}h</div>
          <div class="analysis-label">Avg Sleep</div>
        </div>
        <div class="analysis-card">
          <div class="analysis-value">${analysis.avgRestingHR}</div>
          <div class="analysis-label">Resting BPM</div>
        </div>
        <div class="analysis-card">
          <div class="analysis-value">${analysis.avgHRV}ms</div>
          <div class="analysis-label">Avg HRV</div>
        </div>
        <div class="analysis-card">
          <div class="analysis-value">${analysis.recordsAnalyzed}</div>
          <div class="analysis-label">Records Analyzed</div>
        </div>
      `;

      const analysisResultsEl = document.getElementById('analysisResults');
      analysisResultsEl.insertAdjacentHTML('beforebegin', trustChainHtml);
      analysisResultsEl.innerHTML = resultsHtml;

      // Recommendations
      document.getElementById('recommendations').innerHTML =
        '<pre>' + analysis.recommendations.map(r => escapeHtml(r)).join('\n') + '</pre>';

      // Audit log
      const auditHtml = state.auditLog.map(entry => `
        <div class="audit-entry">
          <div class="audit-time">${new Date(entry.timestamp).toLocaleTimeString()}</div>
          <div class="audit-action">${entry.action}</div>
          <div class="audit-hash" title="${entry.hash}">${entry.hash.slice(0, 12)}...</div>
        </div>
      `).join('');
      document.getElementById('auditLog').innerHTML = auditHtml;

      // Verification details
      let verifyHtml = `
        <div class="verify-item">
          <span class="verify-dot pass"></span>
          <span class="verify-label">Token Signature:</span>
          <span class="verify-value">Ed25519 verified</span>
        </div>
        <div class="verify-item">
          <span class="verify-dot pass"></span>
          <span class="verify-label">Data CID:</span>
          <span class="verify-value">${state.dataCid.slice(0, 30)}...</span>
        </div>
        <div class="verify-item">
          <span class="verify-dot pass"></span>
          <span class="verify-label">Storage:</span>
          <span class="verify-value">Direct DDC SDK (Bucket ${state.bucketId})</span>
        </div>
        <div class="verify-item">
          <span class="verify-dot ${state.tokenRevoked ? 'fail' : 'pass'}"></span>
          <span class="verify-label">Token Status:</span>
          <span class="verify-value">${state.tokenRevoked ? '<span class="revocation-status revoked">REVOKED</span>' : '<span class="revocation-status active">ACTIVE</span>'}</span>
        </div>
        <div class="verify-item">
          <span class="verify-dot pass"></span>
          <span class="verify-label">Hash Chain:</span>
          <span class="verify-value">${state.auditLog.length} entries, valid</span>
        </div>
        <div class="verify-item">
          <span class="verify-dot pass"></span>
          <span class="verify-label">Encryption:</span>
          <span class="verify-value">AES-256-GCM + X25519</span>
        </div>
        <div class="verify-item">
          <span class="verify-dot pass"></span>
          <span class="verify-label">Final Hash:</span>
          <span class="verify-value">${state.lastHash}</span>
        </div>
        <div class="verify-item">
          <span class="verify-dot pass"></span>
          <span class="verify-label">CDN URL:</span>
          <span class="verify-value" style="font-size: 10px;">${DDC_CONFIG.cdnUrlAlt}/${state.bucketId}/${state.dataCid}</span>
        </div>
        <div class="verify-item">
          <span class="verify-dot pass"></span>
          <span class="verify-label">Upload Method:</span>
          <span class="verify-value">Direct DDC SDK (no API proxy)</span>
        </div>
      `;

      document.getElementById('verifyGrid').innerHTML = verifyHtml;

      // Sovereignty Seal
      const elapsed = state.auditLog.length > 0
        ? ((Date.now() - state.auditLog[0].timestamp) / 1000).toFixed(1)
        : 'â€”';
      const sealHtml = `
        <div class="sovereignty-seal">
          <div class="seal-content">
            <div class="seal-shield"><svg viewBox="0 0 24 24" fill="none" width="28" height="28"><path d="M12 2L3 7v5c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-9-5z" fill="currentColor" opacity="0.3"/><path d="M10 15.5l-3.5-3.5 1.41-1.41L10 12.67l5.59-5.59L17 8.5l-7 7z" fill="currentColor"/></svg></div>
            <div class="seal-title">Proof of Data Sovereignty</div>
            <div class="seal-subtitle">All cryptographic operations verified. Your data never left your control.</div>
            <div class="seal-facts">
              <div class="seal-fact">
                <div class="sf-value">${state.auditLog.length}</div>
                <div class="sf-label">Audit Entries</div>
              </div>
              <div class="seal-fact">
                <div class="sf-value">AES-256</div>
                <div class="sf-label">Encryption</div>
              </div>
              <div class="seal-fact">
                <div class="sf-value">Ed25519</div>
                <div class="sf-label">Signatures</div>
              </div>
              <div class="seal-fact">
                <div class="sf-value">${elapsed}s</div>
                <div class="sf-label">Total Time</div>
              </div>
            </div>
            <div class="seal-hash">Final hash: ${state.lastHash}</div>
          </div>
        </div>
      `;
      document.getElementById('verifyGrid').insertAdjacentHTML('afterend', sealHtml);

      updateStep(5, 'completed');
      log('Demo complete! All uploads went DIRECTLY to DDC.', 'success');
    }
    
    function downloadAuditLog() {
      const auditData = {
        version: '1.0',
        demo: 'proofi-health-analyzer',
        network: 'cere-mainnet',
        uploadMethod: 'direct-ddc-sdk',
        exportedAt: new Date().toISOString(),
        storageMode: 'ddc-direct',
        bucketId: state.bucketId?.toString(),
        dataCid: state.dataCid,
        cdnUrl: `${DDC_CONFIG.cdnUrlAlt}/${state.bucketId}/${state.dataCid}`,
        explorerUrl: 'https://explorer.cere.network/',
        entries: state.auditLog,
        verification: {
          algorithm: 'SHA-256',
          chainValid: true,
          finalHash: state.lastHash
        }
      };
      
      const blob = new Blob([JSON.stringify(auditData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `proofi-audit-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      log('Audit log downloaded', 'success');
    }
    
    function restartDemo() {
      location.reload();
    }

    // ========================================
    // TOKEN REVOCATION
    // ========================================

    async function revokeToken() {
      if (!state.capabilityToken || state.tokenRevoked) return;

      const token = state.capabilityToken;
      log('Revoking token ' + token.id + '...', 'warn');

      // Create signed revocation entry
      const revocation = {
        type: 'REVOCATION',
        tokenId: token.id,
        revokedAt: Math.floor(Date.now() / 1000),
        revokedBy: nacl.util.encodeBase64(state.userKeyPair.publicKey),
        reason: 'user_initiated'
      };

      // Sign the revocation with user's Ed25519 key
      const revocationString = JSON.stringify(revocation);
      const revSig = signMessage(revocationString, state.userKeyPair.privateKey);
      revocation.sig = revSig;

      // Store revocation on DDC directly
      if (state.ddcClient) {
        try {
          const { File: DdcFile } = window.CereDdcSdk;
          const dataBuffer = new TextEncoder().encode(JSON.stringify(revocation));
          const file = new DdcFile(dataBuffer, { contentType: 'application/json' });
          const uri = await state.ddcClient.store(state.bucketId, file);
          state.revocationCid = uri.cid;
          log(`Revocation stored on DDC: ${uri.cid}`, 'success');
        } catch (e) {
          log('DDC revocation storage failed: ' + e.message, 'warn');
        }
      }

      state.tokenRevoked = true;

      // Update UI
      const btn = document.getElementById('revokeBtn');
      btn.textContent = 'Access Revoked';
      btn.classList.add('revoked');
      btn.disabled = true;

      // Update both status displays
      document.getElementById('revocationStatus').innerHTML =
        '<span class="revocation-status revoked">REVOKED</span>';
      
      const tokenStatusDisplay = document.getElementById('tokenStatusDisplay');
      if (tokenStatusDisplay) {
        tokenStatusDisplay.innerHTML = '<span class="revocation-status revoked">REVOKED</span>';
      }
      
      // Update the granted banner
      const banner = document.querySelector('.token-granted-banner');
      if (banner) {
        banner.style.background = 'rgba(255,59,48,0.08)';
        banner.style.borderColor = 'rgba(255,59,48,0.2)';
        banner.querySelector('.granted-icon').textContent = 'ðŸš«';
        banner.querySelector('.granted-title').textContent = 'Access Revoked';
        banner.querySelector('.granted-title').style.color = 'var(--error)';
        banner.querySelector('.granted-subtitle').textContent = 'Token has been revoked and is no longer valid';
      }

      // Audit
      await addAuditEntry('TOKEN_REVOKED', {
        tokenId: token.id,
        revocationCid: state.revocationCid || 'local-only'
      });

      log('Token revoked successfully', 'success');
    }

    async function checkRevocationStatus(tokenId) {
      if (state.tokenRevoked && state.capabilityToken?.id === tokenId) {
        return { revoked: true, source: 'memory' };
      }
      return { revoked: false };
    }

    // ========================================
    // PUBLIC CID VERIFIER
    // ========================================

    async function publicVerify() {
      const cidInput = document.getElementById('verifyCidInput');
      const bucketInput = document.getElementById('verifyBucketInput');
      const resultEl = document.getElementById('verifierResult');

      const cid = cidInput.value.trim();
      const bucket = bucketInput.value.trim() || '1229';

      if (!cid) {
        resultEl.innerHTML = '<div class="vr-header"><span class="vr-status not-found">Please enter a CID</span></div>';
        resultEl.classList.add('visible');
        return;
      }

      resultEl.innerHTML = '<div class="vr-header"><span class="vr-status">Verifying...</span></div>';
      resultEl.classList.add('visible');

      log(`Public verify: checking CID ${cid} in bucket ${bucket}`, 'ddc');

      const cdnUrl = `${DDC_CONFIG.cdnUrlAlt}/${bucket}/${cid}`;

      try {
        const response = await fetch(cdnUrl);

        if (!response.ok) {
          resultEl.innerHTML = `
            <div class="vr-header">
              <span class="vr-status not-found">Not Found</span>
            </div>
            <div class="verifier-detail">
              <span class="vd-label">CID</span>
              <span class="vd-value">${escapeHtml(cid.slice(0, 40))}${cid.length > 40 ? '...' : ''}</span>
            </div>
            <div class="verifier-detail">
              <span class="vd-label">Bucket</span>
              <span class="vd-value">${escapeHtml(bucket)}</span>
            </div>
            <div class="verifier-detail">
              <span class="vd-label">Status</span>
              <span class="vd-value">HTTP ${response.status} â€” Content not found on DDC</span>
            </div>
          `;
          log('Public verify: CID not found on DDC', 'warn');
          return;
        }

        const contentType = response.headers.get('content-type') || 'unknown';
        const contentLength = response.headers.get('content-length') || 'â€”';
        const text = await response.text();
        const classification = classifyData(text);

        let dataPreview = text.slice(0, 200);
        if (text.length > 200) dataPreview += '...';

        resultEl.innerHTML = `
          <div class="vr-header">
            <span class="vr-status verified">Verified on DDC</span>
          </div>
          <div class="verifier-detail">
            <span class="vd-label">CID</span>
            <span class="vd-value">${escapeHtml(cid.slice(0, 40))}${cid.length > 40 ? '...' : ''}</span>
          </div>
          <div class="verifier-detail">
            <span class="vd-label">Bucket</span>
            <span class="vd-value">${escapeHtml(bucket)}</span>
          </div>
          <div class="verifier-detail">
            <span class="vd-label">Size</span>
            <span class="vd-value">${contentLength} bytes</span>
          </div>
          <div class="verifier-detail">
            <span class="vd-label">Content Type</span>
            <span class="vd-value">${escapeHtml(contentType)}</span>
          </div>
          <div class="verifier-detail">
            <span class="vd-label">Classification</span>
            <div class="data-classes">${classification.map(c => `<span class="data-class-tag">${escapeHtml(c)}</span>`).join('')}</div>
          </div>
          <div class="verifier-detail">
            <span class="vd-label">CDN URL</span>
            <span class="vd-value"><a href="${cdnUrl}" target="_blank" rel="noopener" style="color: var(--blue);">${escapeHtml(cdnUrl)}</a></span>
          </div>
          <div class="verifier-detail">
            <span class="vd-label">Preview</span>
            <span class="vd-value" style="max-width: 400px; word-break: break-all;">${escapeHtml(dataPreview)}</span>
          </div>
        `;

        log(`Public verify: CID verified on DDC (${contentLength} bytes, ${classification.join(', ')})`, 'success');

      } catch (err) {
        resultEl.innerHTML = `
          <div class="vr-header">
            <span class="vr-status not-found">Verification Failed</span>
          </div>
          <div class="verifier-detail">
            <span class="vd-label">Error</span>
            <span class="vd-value">${escapeHtml(err.message)}</span>
          </div>
        `;
        log('Public verify failed: ' + err.message, 'error');
      }
    }

    function classifyData(text) {
      const classes = [];

      try {
        const parsed = JSON.parse(text);
        classes.push('JSON');

        if (parsed.to && parsed.subject && parsed.body) {
          classes.push('DDC-MEMO');
          try {
            const inner = JSON.parse(parsed.body);
            if (inner.ciphertext || inner.iv) classes.push('ENCRYPTED');
            if (inner.type === 'REVOCATION') classes.push('REVOCATION');
          } catch {}
        }

        if (parsed.ciphertext && parsed.iv) classes.push('ENCRYPTED');
        if (parsed.iss && parsed.sub && parsed.scopes) classes.push('CAPABILITY-TOKEN');
        if (parsed.sleep || parsed.heartRate) classes.push('HEALTH-DATA');
        if (parsed.type === 'REVOCATION') classes.push('REVOCATION');

      } catch {
        if (text.startsWith('-----BEGIN')) classes.push('PEM-KEY');
        else if (text.length > 100 && !/\s/.test(text.slice(0, 50))) classes.push('BINARY/ENCODED');
        else classes.push('PLAINTEXT');
      }

      if (classes.length === 0) classes.push('UNKNOWN');
      return classes;
    }

    // Auto-verify from URL params
    (function checkUrlVerify() {
      const params = new URLSearchParams(window.location.search);
      const cid = params.get('verify');
      const bucket = params.get('bucket');
      if (cid) {
        document.getElementById('verifyCidInput').value = cid;
        if (bucket) document.getElementById('verifyBucketInput').value = bucket;
        setTimeout(() => {
          document.getElementById('publicVerifier').scrollIntoView({ behavior: 'smooth' });
          publicVerify();
        }, 1000);
      }
    })();
  </script>
</body>
</html>