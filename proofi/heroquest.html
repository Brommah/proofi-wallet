<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeroQuest ‚Äî Prove Your Worth</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --gold: #ffd700;
            --gold-dark: #b8860b;
            --parchment: #f4e4bc;
            --wood: #3d2914;
            --wood-light: #5c3d1e;
            --blood: #8b0000;
            --mana: #4169e1;
            --success: #228b22;
        }
        
        body {
            font-family: 'Cinzel', serif;
            background: linear-gradient(135deg, #1a0a00 0%, #2d1810 50%, #1a0a00 100%);
            min-height: 100vh;
            color: var(--parchment);
            overflow-x: hidden;
        }
        
        /* ============================================
           WARCRAFT-STYLE FRAME & BORDERS
           ============================================ */
        .game-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }
        
        .panel {
            background: linear-gradient(180deg, #2a1a0a 0%, #1a0f05 100%);
            border: 4px solid var(--gold-dark);
            border-radius: 8px;
            position: relative;
            box-shadow: 
                0 0 20px rgba(255, 215, 0, 0.2),
                inset 0 0 60px rgba(0,0,0,0.8);
        }
        
        .panel::before {
            content: '';
            position: absolute;
            inset: 4px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 4px;
            pointer-events: none;
        }
        
        /* Corner ornaments */
        .panel-corner {
            position: absolute;
            width: 32px;
            height: 32px;
            background: var(--gold);
            clip-path: polygon(0 0, 100% 0, 0 100%);
        }
        .panel-corner.tl { top: -2px; left: -2px; }
        .panel-corner.tr { top: -2px; right: -2px; transform: rotate(90deg); }
        .panel-corner.bl { bottom: -2px; left: -2px; transform: rotate(-90deg); }
        .panel-corner.br { bottom: -2px; right: -2px; transform: rotate(180deg); }
        
        /* ============================================
           HEADER
           ============================================ */
        .header {
            text-align: center;
            padding: 30px 20px;
            margin-bottom: 20px;
        }
        
        .title {
            font-size: clamp(2rem, 6vw, 3.5rem);
            font-weight: 900;
            color: var(--gold);
            text-shadow: 
                0 2px 0 var(--gold-dark),
                0 4px 8px rgba(0,0,0,0.8),
                0 0 40px rgba(255, 215, 0, 0.5);
            letter-spacing: 4px;
            margin-bottom: 8px;
        }
        
        .subtitle {
            font-size: 1rem;
            color: rgba(244, 228, 188, 0.7);
            letter-spacing: 2px;
        }
        
        /* ============================================
           HERO STATS BAR
           ============================================ */
        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 30px;
            padding: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gold);
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .stat-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: rgba(244, 228, 188, 0.6);
        }
        
        .stat-value.xp { color: #9370db; }
        .stat-value.gold { color: #ffd700; }
        .stat-value.streak { color: #ff6347; }
        
        /* ============================================
           GAME ARENA
           ============================================ */
        .arena {
            padding: 40px;
            margin-bottom: 20px;
        }
        
        .quest-title {
            text-align: center;
            font-size: 1.2rem;
            color: var(--gold);
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        
        .challenge-word {
            text-align: center;
            font-size: clamp(2rem, 8vw, 4rem);
            font-weight: 700;
            color: var(--parchment);
            text-shadow: 0 4px 8px rgba(0,0,0,0.8);
            margin-bottom: 30px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 4px;
        }
        
        .challenge-word .correct { color: var(--success); }
        .challenge-word .incorrect { color: var(--blood); text-decoration: underline; }
        .challenge-word .cursor { 
            border-bottom: 3px solid var(--gold);
            animation: blink 0.8s infinite;
        }
        
        @keyframes blink {
            0%, 50% { border-color: var(--gold); }
            51%, 100% { border-color: transparent; }
        }
        
        .input-container {
            max-width: 500px;
            margin: 0 auto 30px;
        }
        
        .game-input {
            width: 100%;
            padding: 16px 24px;
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            text-align: center;
            background: linear-gradient(180deg, #1a0f05 0%, #0d0705 100%);
            border: 3px solid var(--gold-dark);
            border-radius: 8px;
            color: var(--parchment);
            outline: none;
            transition: all 0.2s;
            box-shadow: inset 0 4px 12px rgba(0,0,0,0.8);
        }
        
        .game-input:focus {
            border-color: var(--gold);
            box-shadow: 
                inset 0 4px 12px rgba(0,0,0,0.8),
                0 0 20px rgba(255, 215, 0, 0.3);
        }
        
        .game-input::placeholder {
            color: rgba(244, 228, 188, 0.3);
        }
        
        .timer-bar {
            height: 8px;
            background: rgba(0,0,0,0.5);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .timer-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--blood), var(--gold));
            transition: width 0.1s linear;
            border-radius: 4px;
        }
        
        .game-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            font-size: 0.9rem;
            color: rgba(244, 228, 188, 0.7);
        }
        
        .game-stats span {
            color: var(--gold);
            font-weight: 600;
        }
        
        /* ============================================
           BUTTONS
           ============================================ */
        .btn {
            display: inline-block;
            padding: 16px 48px;
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--parchment);
            background: linear-gradient(180deg, var(--wood-light) 0%, var(--wood) 100%);
            border: 3px solid var(--gold-dark);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: 
                0 4px 0 #1a0a00,
                0 6px 12px rgba(0,0,0,0.5);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            border-color: var(--gold);
            box-shadow: 
                0 6px 0 #1a0a00,
                0 8px 16px rgba(0,0,0,0.5),
                0 0 20px rgba(255, 215, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(2px);
            box-shadow: 
                0 2px 0 #1a0a00,
                0 4px 8px rgba(0,0,0,0.5);
        }
        
        .btn-primary {
            background: linear-gradient(180deg, #4a3520 0%, #2d1810 100%);
            border-color: var(--gold);
            color: var(--gold);
        }
        
        .btn-center {
            display: block;
            margin: 20px auto;
        }
        
        /* ============================================
           ACHIEVEMENTS SECTION
           ============================================ */
        .achievements-section {
            padding: 30px;
        }
        
        .section-title {
            text-align: center;
            font-size: 1.5rem;
            color: var(--gold);
            margin-bottom: 24px;
            text-transform: uppercase;
            letter-spacing: 3px;
        }
        
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 16px;
        }
        
        .achievement {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: linear-gradient(180deg, rgba(45, 24, 16, 0.8) 0%, rgba(26, 15, 5, 0.8) 100%);
            border: 2px solid rgba(184, 134, 11, 0.3);
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .achievement.unlocked {
            border-color: var(--gold);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
        }
        
        .achievement.locked {
            opacity: 0.5;
            filter: grayscale(0.8);
        }
        
        .achievement-icon {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #3d2914 0%, #1a0a00 100%);
            border: 2px solid var(--gold-dark);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
        }
        
        .achievement.unlocked .achievement-icon {
            background: linear-gradient(135deg, var(--gold-dark) 0%, #5c3d1e 100%);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        
        .achievement-info h3 {
            font-size: 1rem;
            color: var(--gold);
            margin-bottom: 4px;
        }
        
        .achievement-info p {
            font-size: 0.8rem;
            color: rgba(244, 228, 188, 0.6);
            font-family: -apple-system, sans-serif;
        }
        
        .achievement-info .xp-reward {
            font-size: 0.75rem;
            color: #9370db;
            margin-top: 4px;
        }
        
        /* ============================================
           ACHIEVEMENT POPUP
           ============================================ */
        .achievement-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 20px 30px;
            background: linear-gradient(180deg, #3d2914 0%, #1a0a00 100%);
            border: 3px solid var(--gold);
            border-radius: 12px;
            box-shadow: 
                0 0 40px rgba(255, 215, 0, 0.5),
                0 10px 40px rgba(0,0,0,0.8);
            z-index: 1000;
            transform: translateX(120%);
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .achievement-popup.show {
            transform: translateX(0);
        }
        
        .achievement-popup-header {
            font-size: 0.8rem;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }
        
        .achievement-popup-title {
            font-size: 1.2rem;
            color: var(--parchment);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .achievement-popup-title span {
            font-size: 1.5rem;
        }
        
        /* ============================================
           LEADERBOARD
           ============================================ */
        .leaderboard {
            padding: 30px;
            margin-top: 20px;
        }
        
        .leaderboard-entry {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .leaderboard-rank {
            width: 32px;
            height: 32px;
            background: var(--gold-dark);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }
        
        .leaderboard-entry:nth-child(1) .leaderboard-rank { background: linear-gradient(135deg, #ffd700, #ffb800); color: #1a0a00; }
        .leaderboard-entry:nth-child(2) .leaderboard-rank { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #1a0a00; }
        .leaderboard-entry:nth-child(3) .leaderboard-rank { background: linear-gradient(135deg, #cd7f32, #a05a2c); color: #1a0a00; }
        
        .leaderboard-name {
            flex: 1;
            font-weight: 600;
        }
        
        .leaderboard-score {
            color: var(--gold);
            font-weight: 700;
        }
        
        /* ============================================
           WALLET CONNECT
           ============================================ */
        .wallet-section {
            text-align: center;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .wallet-address {
            font-family: monospace;
            font-size: 0.85rem;
            color: var(--gold);
            background: rgba(0,0,0,0.4);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
        }
        
        /* ============================================
           SCREENS
           ============================================ */
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 600px) {
            .stats-bar { gap: 20px; }
            .stat-value { font-size: 1.5rem; }
            .arena { padding: 20px; }
            .achievements-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        
        <!-- HEADER -->
        <div class="header">
            <h1 class="title">‚öîÔ∏è HeroQuest</h1>
            <p class="subtitle">Prove Your Worth ‚Ä¢ Earn Achievements ‚Ä¢ Build Your Legend</p>
        </div>
        
        <!-- WALLET SECTION -->
        <div class="wallet-section" id="walletSection">
            <button class="btn btn-primary" id="connectBtn" onclick="connectWallet()">
                üîÆ Connect Wallet
            </button>
            <div class="wallet-address" id="walletAddress" style="display: none;"></div>
        </div>
        
        <!-- STATS BAR -->
        <div class="stats-bar">
            <div class="stat">
                <div class="stat-value xp" id="totalXP">0</div>
                <div class="stat-label">Total XP</div>
            </div>
            <div class="stat">
                <div class="stat-value gold" id="totalGold">0</div>
                <div class="stat-label">Gold</div>
            </div>
            <div class="stat">
                <div class="stat-value streak" id="bestStreak">0</div>
                <div class="stat-label">Best Streak</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="gamesPlayed">0</div>
                <div class="stat-label">Quests</div>
            </div>
        </div>
        
        <!-- GAME ARENA -->
        <div class="panel arena" id="gameArena">
            <div class="panel-corner tl"></div>
            <div class="panel-corner tr"></div>
            <div class="panel-corner bl"></div>
            <div class="panel-corner br"></div>
            
            <!-- START SCREEN -->
            <div class="screen active" id="startScreen">
                <div class="quest-title">üè∞ The Typing Challenge Awaits</div>
                <div style="text-align: center; margin: 40px 0;">
                    <p style="color: rgba(244, 228, 188, 0.8); margin-bottom: 20px; max-width: 500px; margin-left: auto; margin-right: auto;">
                        Type the ancient words as fast as you can. Build your streak, earn XP, and unlock legendary achievements!
                    </p>
                    <button class="btn btn-primary" onclick="startGame()">
                        ‚öîÔ∏è Begin Quest
                    </button>
                </div>
            </div>
            
            <!-- GAME SCREEN -->
            <div class="screen" id="gameScreen">
                <div class="quest-title">‚öîÔ∏è Type the Word!</div>
                <div class="timer-bar">
                    <div class="timer-fill" id="timerFill" style="width: 100%;"></div>
                </div>
                <div class="challenge-word" id="challengeWord">DRAGON</div>
                <div class="input-container">
                    <input type="text" class="game-input" id="gameInput" placeholder="Type here..." autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false">
                </div>
                <div class="game-stats">
                    <div>Streak: <span id="currentStreak">0</span></div>
                    <div>WPM: <span id="currentWPM">0</span></div>
                    <div>Score: <span id="currentScore">0</span></div>
                </div>
            </div>
            
            <!-- RESULT SCREEN -->
            <div class="screen" id="resultScreen">
                <div class="quest-title">üèÜ Quest Complete!</div>
                <div style="text-align: center; margin: 30px 0;">
                    <div class="stat-value gold" style="font-size: 3rem;" id="finalScore">0</div>
                    <div class="stat-label" style="margin-bottom: 20px;">Final Score</div>
                    
                    <div style="display: flex; justify-content: center; gap: 40px; margin-bottom: 30px;">
                        <div class="stat">
                            <div class="stat-value xp" id="earnedXP">+0</div>
                            <div class="stat-label">XP Earned</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="earnedGold">+0</div>
                            <div class="stat-label">Gold</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="finalWPM">0</div>
                            <div class="stat-label">Avg WPM</div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="startGame()">
                        üîÑ Play Again
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ACHIEVEMENTS -->
        <div class="panel achievements-section">
            <div class="panel-corner tl"></div>
            <div class="panel-corner tr"></div>
            <div class="panel-corner bl"></div>
            <div class="panel-corner br"></div>
            
            <h2 class="section-title">üèÖ Achievements</h2>
            <div class="achievements-grid" id="achievementsGrid">
                <!-- Populated by JS -->
            </div>
        </div>
        
        <!-- ACHIEVEMENT POPUP -->
        <div class="achievement-popup" id="achievementPopup">
            <div class="achievement-popup-header">üèÜ Achievement Unlocked!</div>
            <div class="achievement-popup-title">
                <span id="popupIcon">‚öîÔ∏è</span>
                <span id="popupTitle">First Blood</span>
            </div>
        </div>
        
    </div>

    <script>
        // ============================================
        // GAME STATE
        // ============================================
        const WORDS = [
            'DRAGON', 'KNIGHT', 'SWORD', 'MAGIC', 'QUEST', 'HERO', 'BATTLE', 'GLORY',
            'VALOR', 'HONOR', 'LEGEND', 'THRONE', 'SHIELD', 'ARMOR', 'CASTLE', 'KINGDOM',
            'WIZARD', 'ARCHER', 'WARRIOR', 'PALADIN', 'ROGUE', 'MAGE', 'PRIEST', 'HUNTER',
            'PHOENIX', 'GRIFFIN', 'DEMON', 'ANGEL', 'TITAN', 'GIANT', 'DWARF', 'ELVEN',
            'MYSTIC', 'ARCANE', 'DIVINE', 'SHADOW', 'FLAME', 'FROST', 'STORM', 'EARTH',
            'VICTORY', 'TRIUMPH', 'CONQUEST', 'DESTINY', 'FORTUNE', 'BLESSED', 'CURSED'
        ];
        
        const ACHIEVEMENTS = [
            { id: 'first_quest', icon: '‚öîÔ∏è', title: 'First Quest', desc: 'Complete your first game', xp: 50, condition: (s) => s.gamesPlayed >= 1 },
            { id: 'streak_5', icon: 'üî•', title: 'On Fire', desc: 'Get a 5 word streak', xp: 100, condition: (s) => s.bestStreak >= 5 },
            { id: 'streak_10', icon: 'üí•', title: 'Unstoppable', desc: 'Get a 10 word streak', xp: 250, condition: (s) => s.bestStreak >= 10 },
            { id: 'streak_20', icon: '‚ö°', title: 'Lightning Fingers', desc: 'Get a 20 word streak', xp: 500, condition: (s) => s.bestStreak >= 20 },
            { id: 'wpm_50', icon: 'üèÉ', title: 'Swift', desc: 'Reach 50 WPM', xp: 100, condition: (s) => s.bestWPM >= 50 },
            { id: 'wpm_80', icon: 'ü¶Ö', title: 'Eagle Eye', desc: 'Reach 80 WPM', xp: 300, condition: (s) => s.bestWPM >= 80 },
            { id: 'wpm_100', icon: 'üöÄ', title: 'Supersonic', desc: 'Reach 100 WPM', xp: 500, condition: (s) => s.bestWPM >= 100 },
            { id: 'score_1000', icon: 'üåü', title: 'Rising Star', desc: 'Score 1000 in one game', xp: 200, condition: (s) => s.bestScore >= 1000 },
            { id: 'score_5000', icon: 'üíé', title: 'Diamond Hands', desc: 'Score 5000 in one game', xp: 500, condition: (s) => s.bestScore >= 5000 },
            { id: 'games_10', icon: 'üéÆ', title: 'Dedicated', desc: 'Play 10 games', xp: 200, condition: (s) => s.gamesPlayed >= 10 },
            { id: 'games_50', icon: 'üëë', title: 'Veteran', desc: 'Play 50 games', xp: 500, condition: (s) => s.gamesPlayed >= 50 },
            { id: 'xp_1000', icon: 'üìà', title: 'Leveling Up', desc: 'Earn 1000 total XP', xp: 100, condition: (s) => s.totalXP >= 1000 },
            { id: 'gold_500', icon: 'üí∞', title: 'Treasure Hunter', desc: 'Collect 500 gold', xp: 150, condition: (s) => s.totalGold >= 500 },
            { id: 'perfect_10', icon: '‚ú®', title: 'Perfectionist', desc: '10 words without mistakes', xp: 300, condition: (s) => s.perfectStreak >= 10 },
        ];
        
        let state = {
            wallet: null,
            totalXP: 0,
            totalGold: 0,
            bestStreak: 0,
            bestWPM: 0,
            bestScore: 0,
            gamesPlayed: 0,
            perfectStreak: 0,
            unlockedAchievements: []
        };
        
        let game = {
            active: false,
            words: [],
            currentWord: '',
            score: 0,
            streak: 0,
            correctWords: 0,
            startTime: 0,
            wordStartTime: 0,
            timeLeft: 60,
            timer: null,
            perfectRun: true
        };
        
        // ============================================
        // WALLET CONNECTION
        // ============================================
        async function connectWallet() {
            // Check for Polkadot.js extension
            if (window.injectedWeb3 && window.injectedWeb3['polkadot-js']) {
                try {
                    const ext = await window.injectedWeb3['polkadot-js'].enable('HeroQuest');
                    const accounts = await ext.accounts.get();
                    if (accounts.length > 0) {
                        state.wallet = accounts[0].address;
                        document.getElementById('connectBtn').style.display = 'none';
                        document.getElementById('walletAddress').style.display = 'inline-block';
                        document.getElementById('walletAddress').textContent = 
                            state.wallet.slice(0, 6) + '...' + state.wallet.slice(-4);
                        loadState();
                        return;
                    }
                } catch (e) {
                    console.log('Wallet connection failed:', e);
                }
            }
            
            // Fallback: generate local wallet ID
            state.wallet = 'local_' + Math.random().toString(36).slice(2, 10);
            document.getElementById('connectBtn').style.display = 'none';
            document.getElementById('walletAddress').style.display = 'inline-block';
            document.getElementById('walletAddress').textContent = 'üéÆ Guest Mode';
            loadState();
        }
        
        // ============================================
        // STATE MANAGEMENT
        // ============================================
        function loadState() {
            const saved = localStorage.getItem('heroquest_' + state.wallet);
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed };
            }
            updateUI();
            renderAchievements();
        }
        
        function saveState() {
            localStorage.setItem('heroquest_' + state.wallet, JSON.stringify({
                totalXP: state.totalXP,
                totalGold: state.totalGold,
                bestStreak: state.bestStreak,
                bestWPM: state.bestWPM,
                bestScore: state.bestScore,
                gamesPlayed: state.gamesPlayed,
                perfectStreak: state.perfectStreak,
                unlockedAchievements: state.unlockedAchievements
            }));
        }
        
        function updateUI() {
            document.getElementById('totalXP').textContent = state.totalXP;
            document.getElementById('totalGold').textContent = state.totalGold;
            document.getElementById('bestStreak').textContent = state.bestStreak;
            document.getElementById('gamesPlayed').textContent = state.gamesPlayed;
        }
        
        // ============================================
        // GAME LOGIC
        // ============================================
        function startGame() {
            game = {
                active: true,
                words: [...WORDS].sort(() => Math.random() - 0.5),
                currentWord: '',
                score: 0,
                streak: 0,
                correctWords: 0,
                startTime: Date.now(),
                wordStartTime: Date.now(),
                timeLeft: 60,
                timer: null,
                perfectRun: true
            };
            
            showScreen('gameScreen');
            nextWord();
            
            const input = document.getElementById('gameInput');
            input.value = '';
            input.focus();
            
            // Start timer
            game.timer = setInterval(updateTimer, 100);
        }
        
        function nextWord() {
            if (game.words.length === 0) {
                game.words = [...WORDS].sort(() => Math.random() - 0.5);
            }
            game.currentWord = game.words.pop();
            game.wordStartTime = Date.now();
            document.getElementById('challengeWord').innerHTML = game.currentWord;
            document.getElementById('gameInput').value = '';
        }
        
        function updateTimer() {
            const elapsed = (Date.now() - game.startTime) / 1000;
            game.timeLeft = Math.max(0, 60 - elapsed);
            
            const pct = (game.timeLeft / 60) * 100;
            document.getElementById('timerFill').style.width = pct + '%';
            
            if (game.timeLeft <= 0) {
                endGame();
            }
        }
        
        function checkInput(input) {
            const typed = input.value.toUpperCase();
            const target = game.currentWord;
            
            // Render with colors
            let html = '';
            for (let i = 0; i < target.length; i++) {
                if (i < typed.length) {
                    if (typed[i] === target[i]) {
                        html += `<span class="correct">${target[i]}</span>`;
                    } else {
                        html += `<span class="incorrect">${target[i]}</span>`;
                        game.perfectRun = false;
                    }
                } else if (i === typed.length) {
                    html += `<span class="cursor">${target[i]}</span>`;
                } else {
                    html += target[i];
                }
            }
            document.getElementById('challengeWord').innerHTML = html;
            
            // Check if word complete
            if (typed === target) {
                const wordTime = (Date.now() - game.wordStartTime) / 1000;
                const wordWPM = Math.round((target.length / 5) / (wordTime / 60));
                
                game.streak++;
                game.correctWords++;
                
                // Score: base + streak bonus + speed bonus
                const baseScore = target.length * 10;
                const streakBonus = game.streak * 5;
                const speedBonus = Math.max(0, (100 - wordTime * 10)) * 2;
                const wordScore = Math.round(baseScore + streakBonus + speedBonus);
                
                game.score += wordScore;
                
                // Update display
                document.getElementById('currentStreak').textContent = game.streak;
                document.getElementById('currentScore').textContent = game.score;
                
                // Calculate WPM
                const totalTime = (Date.now() - game.startTime) / 1000 / 60;
                const avgWPM = Math.round((game.correctWords * 5) / totalTime);
                document.getElementById('currentWPM').textContent = avgWPM || 0;
                
                nextWord();
            }
        }
        
        function endGame() {
            game.active = false;
            clearInterval(game.timer);
            
            // Calculate final stats
            const totalTime = 60; // Full game time
            const avgWPM = Math.round((game.correctWords * 5) / (totalTime / 60));
            const earnedXP = Math.round(game.score / 10);
            const earnedGold = Math.round(game.score / 20);
            
            // Update state
            state.totalXP += earnedXP;
            state.totalGold += earnedGold;
            state.gamesPlayed++;
            state.bestStreak = Math.max(state.bestStreak, game.streak);
            state.bestWPM = Math.max(state.bestWPM, avgWPM);
            state.bestScore = Math.max(state.bestScore, game.score);
            if (game.perfectRun && game.correctWords > state.perfectStreak) {
                state.perfectStreak = game.correctWords;
            }
            
            saveState();
            updateUI();
            checkAchievements();
            
            // Show results
            document.getElementById('finalScore').textContent = game.score;
            document.getElementById('earnedXP').textContent = '+' + earnedXP;
            document.getElementById('earnedGold').textContent = '+' + earnedGold;
            document.getElementById('finalWPM').textContent = avgWPM;
            
            showScreen('resultScreen');
        }
        
        // ============================================
        // ACHIEVEMENTS
        // ============================================
        function checkAchievements() {
            for (const ach of ACHIEVEMENTS) {
                if (!state.unlockedAchievements.includes(ach.id) && ach.condition(state)) {
                    unlockAchievement(ach);
                }
            }
            renderAchievements();
        }
        
        function unlockAchievement(ach) {
            state.unlockedAchievements.push(ach.id);
            state.totalXP += ach.xp;
            saveState();
            updateUI();
            
            // Show popup
            document.getElementById('popupIcon').textContent = ach.icon;
            document.getElementById('popupTitle').textContent = ach.title;
            const popup = document.getElementById('achievementPopup');
            popup.classList.add('show');
            
            setTimeout(() => popup.classList.remove('show'), 3000);
        }
        
        function renderAchievements() {
            const grid = document.getElementById('achievementsGrid');
            grid.innerHTML = ACHIEVEMENTS.map(ach => {
                const unlocked = state.unlockedAchievements.includes(ach.id);
                return `
                    <div class="achievement ${unlocked ? 'unlocked' : 'locked'}">
                        <div class="achievement-icon">${ach.icon}</div>
                        <div class="achievement-info">
                            <h3>${ach.title}</h3>
                            <p>${ach.desc}</p>
                            <div class="xp-reward">+${ach.xp} XP</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ============================================
        // UI HELPERS
        // ============================================
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        
        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.getElementById('gameInput').addEventListener('input', (e) => {
            if (game.active) {
                checkInput(e.target);
            }
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !game.active) {
                const startScreen = document.getElementById('startScreen');
                const resultScreen = document.getElementById('resultScreen');
                if (startScreen.classList.contains('active') || resultScreen.classList.contains('active')) {
                    startGame();
                }
            }
        });
        
        // Auto-connect on load
        window.addEventListener('load', () => {
            renderAchievements();
            // Try auto-connect
            setTimeout(connectWallet, 500);
        });
    </script>
</body>
</html>
