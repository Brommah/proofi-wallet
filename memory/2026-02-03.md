# 2026-02-03 Session Notes

## Proofi Wallet - Major Refactor to Fully Decentralized

### Problem 1: Different wallets on different browsers
- Same email getting different wallet addresses in different browsers
- **Root cause**: PIN screen always showed "Create PIN" even for returning users
- User would enter different PIN → different derived wallet
- **Fix**: 
  - Store `hasExistingWallet` and `existingAddress` after OTP verify
  - Show "Welcome Back" UI for restore flow
  - Verify derived address matches stored address → "Wrong PIN" if mismatch
  - Commits: `0d42516`, `5c0c2b2`

### Problem 2: Memos not persisting after logout
- Old system used SQLite database for memo index
- **Mart's requirement**: FULLY decentralized, NO databases
- **Solution implemented**:
  - Each wallet has index on DDC via CNS name: `proofi-index-{walletAddress}`
  - `storeMemo()` and `storeCredential()` now add to DDC index
  - `readWalletIndex()` reads from DDC, not SQLite
  - `/ddc/list` endpoint reads from DDC
  - Commits: `1cef0c0`, `5491f96`, `2a62b46`

### Problem 3: Vercel `/undefined` errors
- Frontend calling `/undefined` because `VITE_API_URL` not set
- **Fix**: Add env var on Vercel (NOT Railway):
  - `VITE_API_URL` = `https://proofi-api-production.up.railway.app`
  - Must redeploy with cache clear (VITE env vars are build-time)

### Architecture
- **Railway**: proofi-api backend (`proofi-api-production.up.railway.app`)
- **Vercel**: proofi UI frontend (`proofi-virid.vercel.app`)
- **DDC**: Cere Network decentralized storage (Bucket #1229)

### Key Files Modified
- `packages/api/src/ddc/service.ts` - Added `readWalletIndex()`, `addToWalletIndex()`
- `packages/api/src/server.ts` - `/ddc/list` now reads from DDC
- `packages/ui/src/stores/authStore.ts` - Added `hasExistingWallet`, address verification
- `packages/ui/src/screens/PinScreen.tsx` - Restore vs Create flow
- `packages/ui/src/screens/DdcScreen.tsx` - Migration button, load on mount

### Repo
- GitHub: `Brommah/proofi-wallet`
- Local: `~/clawd/proofi-wallet`

### Problem 4: Cere Network RPC WebSocket failures (late evening session)
- App deployed to Vercel, console spammed with `wss://rpc.mainnet.cere.network/` 1006 Abnormal Closure
- **Root cause 1**: Missing `/ws` suffix — official SDK uses `wss://rpc.mainnet.cere.network/ws`
- **Root cause 2**: The standard RPC node is unstable, always times out
- **Root cause 3**: Archive node (`wss://archive.mainnet.cere.network/ws`) connects but had `state_getMetadata` error initially, then worked
- **Fix applied**: 
  - Swapped to archive node as primary endpoint
  - Added fallback logic: tries archive first, then standard RPC
  - Added 12s connection timeout (no more infinite loading)
  - Source: `~/clawd/proofi-wallet/packages/ui/src/lib/cere.ts`
- **Key discovery**: Cere DDC SDK presets at `packages/ddc/src/presets.ts` in `Cerebellum-Network/cere-ddc-sdk-js` GitHub repo has all official endpoints
- **polkadot.js apps config** lists `wss://archive.mainnet.cere.network/ws` as the Cere endpoint

### Mart bridged 105 CERE to Proofi wallet
- Balance showing correctly after RPC fix
- Wallet address works on mainnet

### Game Integration: NEURAL REFLEX
- Mart requested full WalletConnect-style flow: game → connect Proofi → store achievements on DDC
- Built by sub-agent: https://proofi-virid.vercel.app/game
- Two modes: Reflex (reaction speed) + Memory (card matching)
- 8 auto-tracked achievements stored on DDC
- **Proofi SDK** (`proofi-sdk.js`): lightweight JS library any app can embed
  - `proofi.connect()` → opens popup, returns address
  - `proofi.storeAchievement()` → stores on DDC
  - Uses postMessage communication with wallet iframe/popup
- **API endpoints added**: `POST /game/achievement`, `GET /game/achievements/:wallet`
- **DdcScreen.tsx** updated: GameAchievement items show with gold (#FFE100) styling
- All deployed: game on Vercel, API on Railway

### Build/Deploy Commands (reference)
```bash
# UI build
cd ~/clawd/proofi-wallet/packages/ui
VITE_API_URL=https://proofi-api-production.up.railway.app pnpm vite build --base=/app/

# Copy and deploy
rm -rf ~/clawd/proofi/app && cp -r ~/clawd/proofi-wallet/packages/ui/dist ~/clawd/proofi/app
cd ~/clawd/proofi && vercel --prod --force --yes

# API deploy
cd ~/clawd/proofi-wallet && git add -A && git commit -m "msg" && git push
```
