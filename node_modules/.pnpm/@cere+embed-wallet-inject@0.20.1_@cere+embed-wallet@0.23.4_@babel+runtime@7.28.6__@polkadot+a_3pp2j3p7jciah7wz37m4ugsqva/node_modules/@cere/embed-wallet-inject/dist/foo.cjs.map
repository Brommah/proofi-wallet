{"version":3,"file":"foo.cjs","sources":["../src/polkadot/PolkadotInjector.ts","../src/index.ts"],"sourcesContent":["import { EmbedWallet, WalletConnectOptions, WalletAccount } from '@cere/embed-wallet';\nimport { injectExtension } from '@polkadot/extension-inject';\nimport type { Injected, InjectedAccount, InjectedAccounts } from '@polkadot/extension-inject/types';\nimport type { SignerPayloadRaw, SignerResult, Signer, SignerPayloadJSON } from '@polkadot/types/types';\n\nexport type PolkadotInjectorOptions = {\n  name?: string;\n  version?: string;\n  autoConnect?: boolean;\n  waitReady?: boolean;\n  connectOptions?: WalletConnectOptions;\n};\n\nexport class PolkadotInjector {\n  private name: string;\n  private version: string;\n  private injected: boolean = false;\n  private shouldConnect: boolean;\n  private shouldWait: boolean;\n  private connectOptions?: WalletConnectOptions;\n\n  constructor(\n    readonly wallet: EmbedWallet,\n    { name, version, autoConnect = false, waitReady = true, connectOptions }: PolkadotInjectorOptions = {},\n  ) {\n    this.name = name || 'Cere Wallet';\n    this.version = version || '0.0.0';\n    this.shouldConnect = autoConnect;\n    this.shouldWait = waitReady;\n    this.connectOptions = connectOptions;\n  }\n\n  get isInjected() {\n    return this.injected;\n  }\n\n  private waitReady = () => this.wallet.isReady.then(() => true);\n  private filterAccounts = (accounts: WalletAccount[]) => {\n    return accounts.filter((account: WalletAccount) => account.type === 'ed25519') as InjectedAccount[];\n  };\n\n  readonly getAccounts = async () => {\n    const allAccounts = await this.wallet.provider.request({\n      method: 'wallet_accounts',\n    });\n\n    return this.filterAccounts(allAccounts);\n  };\n\n  readonly subscribeAccounts = (onReceive: (accounts: InjectedAccount[]) => void) => {\n    return this.wallet.subscribe('accounts-update', (accounts: WalletAccount[]) =>\n      onReceive(this.filterAccounts(accounts)),\n    );\n  };\n\n  readonly signRaw = async (raw: SignerPayloadRaw): Promise<SignerResult> => {\n    const signature = await this.wallet.provider.request({\n      method: 'ed25519_signRaw',\n      params: [raw.address, raw.data],\n    });\n\n    return { id: 0, signature };\n  };\n\n  readonly signPayload = async (payload: SignerPayloadJSON): Promise<SignerResult> => {\n    const signature = await this.wallet.provider.request({\n      method: 'ed25519_signPayload',\n      params: [payload],\n    });\n\n    return { id: 0, signature };\n  };\n\n  readonly enable = async (): Promise<Injected> => {\n    if (this.shouldWait) {\n      await this.waitReady();\n    }\n\n    const { permissions } = this.connectOptions || {};\n\n    if (this.shouldConnect && this.wallet.status === 'ready') {\n      await this.wallet.connect(this.connectOptions);\n    } else if (this.wallet.status === 'connected' && permissions) {\n      await this.wallet.requestPermissions(permissions).catch(console.warn);\n    }\n\n    const accounts: InjectedAccounts = {\n      get: this.getAccounts,\n      subscribe: this.subscribeAccounts,\n    };\n\n    const signer: Signer = {\n      signRaw: this.signRaw,\n      signPayload: this.signPayload,\n    };\n\n    return { accounts, signer };\n  };\n\n  inject() {\n    injectExtension(this.enable, {\n      version: this.version,\n      name: this.name,\n    });\n\n    this.injected = true;\n  }\n}\n","import { EmbedWallet, WalletConnectOptions } from '@cere/embed-wallet';\n\nimport { PolkadotInjector } from './polkadot';\n\ntype InjectTarget = 'polkadot';\n\nexport type EnableOptions = {\n  name?: string;\n  target?: InjectTarget;\n  autoConnect?: boolean;\n  connectOptions?: WalletConnectOptions;\n};\n\nexport type InjectOptions = Omit<EnableOptions, 'target'> & {\n  targets?: InjectTarget[];\n};\n\n/**\n * Enables the injected wallet and returns the injected application\n */\nexport const enable = async (wallet: EmbedWallet, { target = 'polkadot', ...options }: EnableOptions = {}) => {\n  if (target !== 'polkadot') {\n    throw new Error(`Unsupported target: ${target}`);\n  }\n\n  return new PolkadotInjector(wallet, options).enable();\n};\n\n/**\n * Injects the wallet into the global object (Window)\n */\nexport const inject = async (wallet: EmbedWallet, { targets = ['polkadot'], ...options }: InjectOptions = {}) => {\n  if (targets.includes('polkadot')) {\n    new PolkadotInjector(wallet, options).inject();\n  }\n};\n"],"names":["PolkadotInjector","constructor","wallet","_temp","_this","this","_this2","_this3","_this4","name","version","autoConnect","waitReady","connectOptions","injected","shouldConnect","shouldWait","isReady","then","filterAccounts","accounts","filter","account","type","getAccounts","Promise","resolve","provider","request","method","allAccounts","e","reject","subscribeAccounts","onReceive","subscribe","signRaw","raw","params","address","data","signature","id","signPayload","payload","enable","_temp6","_temp4","get","signer","permissions","_temp3","status","connect","_temp2","requestPermissions","catch","console","warn","_temp5","isInjected","inject","injectExtension","target","options","Error","targets","includes"],"mappings":"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"}