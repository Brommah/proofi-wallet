{"version":3,"file":"foo.modern.js","sources":["../src/polkadot/PolkadotInjector.ts","../src/index.ts"],"sourcesContent":["import { EmbedWallet, WalletConnectOptions, WalletAccount } from '@cere/embed-wallet';\nimport { injectExtension } from '@polkadot/extension-inject';\nimport type { Injected, InjectedAccount, InjectedAccounts } from '@polkadot/extension-inject/types';\nimport type { SignerPayloadRaw, SignerResult, Signer, SignerPayloadJSON } from '@polkadot/types/types';\n\nexport type PolkadotInjectorOptions = {\n  name?: string;\n  version?: string;\n  autoConnect?: boolean;\n  waitReady?: boolean;\n  connectOptions?: WalletConnectOptions;\n};\n\nexport class PolkadotInjector {\n  private name: string;\n  private version: string;\n  private injected: boolean = false;\n  private shouldConnect: boolean;\n  private shouldWait: boolean;\n  private connectOptions?: WalletConnectOptions;\n\n  constructor(\n    readonly wallet: EmbedWallet,\n    { name, version, autoConnect = false, waitReady = true, connectOptions }: PolkadotInjectorOptions = {},\n  ) {\n    this.name = name || 'Cere Wallet';\n    this.version = version || '0.0.0';\n    this.shouldConnect = autoConnect;\n    this.shouldWait = waitReady;\n    this.connectOptions = connectOptions;\n  }\n\n  get isInjected() {\n    return this.injected;\n  }\n\n  private waitReady = () => this.wallet.isReady.then(() => true);\n  private filterAccounts = (accounts: WalletAccount[]) => {\n    return accounts.filter((account: WalletAccount) => account.type === 'ed25519') as InjectedAccount[];\n  };\n\n  readonly getAccounts = async () => {\n    const allAccounts = await this.wallet.provider.request({\n      method: 'wallet_accounts',\n    });\n\n    return this.filterAccounts(allAccounts);\n  };\n\n  readonly subscribeAccounts = (onReceive: (accounts: InjectedAccount[]) => void) => {\n    return this.wallet.subscribe('accounts-update', (accounts: WalletAccount[]) =>\n      onReceive(this.filterAccounts(accounts)),\n    );\n  };\n\n  readonly signRaw = async (raw: SignerPayloadRaw): Promise<SignerResult> => {\n    const signature = await this.wallet.provider.request({\n      method: 'ed25519_signRaw',\n      params: [raw.address, raw.data],\n    });\n\n    return { id: 0, signature };\n  };\n\n  readonly signPayload = async (payload: SignerPayloadJSON): Promise<SignerResult> => {\n    const signature = await this.wallet.provider.request({\n      method: 'ed25519_signPayload',\n      params: [payload],\n    });\n\n    return { id: 0, signature };\n  };\n\n  readonly enable = async (): Promise<Injected> => {\n    if (this.shouldWait) {\n      await this.waitReady();\n    }\n\n    const { permissions } = this.connectOptions || {};\n\n    if (this.shouldConnect && this.wallet.status === 'ready') {\n      await this.wallet.connect(this.connectOptions);\n    } else if (this.wallet.status === 'connected' && permissions) {\n      await this.wallet.requestPermissions(permissions).catch(console.warn);\n    }\n\n    const accounts: InjectedAccounts = {\n      get: this.getAccounts,\n      subscribe: this.subscribeAccounts,\n    };\n\n    const signer: Signer = {\n      signRaw: this.signRaw,\n      signPayload: this.signPayload,\n    };\n\n    return { accounts, signer };\n  };\n\n  inject() {\n    injectExtension(this.enable, {\n      version: this.version,\n      name: this.name,\n    });\n\n    this.injected = true;\n  }\n}\n","import { EmbedWallet, WalletConnectOptions } from '@cere/embed-wallet';\n\nimport { PolkadotInjector } from './polkadot';\n\ntype InjectTarget = 'polkadot';\n\nexport type EnableOptions = {\n  name?: string;\n  target?: InjectTarget;\n  autoConnect?: boolean;\n  connectOptions?: WalletConnectOptions;\n};\n\nexport type InjectOptions = Omit<EnableOptions, 'target'> & {\n  targets?: InjectTarget[];\n};\n\n/**\n * Enables the injected wallet and returns the injected application\n */\nexport const enable = async (wallet: EmbedWallet, { target = 'polkadot', ...options }: EnableOptions = {}) => {\n  if (target !== 'polkadot') {\n    throw new Error(`Unsupported target: ${target}`);\n  }\n\n  return new PolkadotInjector(wallet, options).enable();\n};\n\n/**\n * Injects the wallet into the global object (Window)\n */\nexport const inject = async (wallet: EmbedWallet, { targets = ['polkadot'], ...options }: InjectOptions = {}) => {\n  if (targets.includes('polkadot')) {\n    new PolkadotInjector(wallet, options).inject();\n  }\n};\n"],"names":["PolkadotInjector","constructor","wallet","name","version","autoConnect","waitReady","connectOptions","_this","injected","this","shouldConnect","shouldWait","isReady","then","filterAccounts","accounts","filter","account","type","getAccounts","async","allAccounts","provider","request","method","subscribeAccounts","onReceive","subscribe","signRaw","raw","id","signature","params","address","data","signPayload","payload","enable","permissions","status","connect","requestPermissions","catch","console","warn","get","signer","isInjected","inject","injectExtension","_ref","target","options","_objectWithoutPropertiesLoose","_excluded","Error","_ref2","targets","_excluded2","includes"],"mappings":"uMAaaA,EAQXC,YACWC,GACTC,KAAEA,EAAIC,QAAEA,EAAOC,YAAEA,GAAc,EAAKC,UAAEA,GAAY,EAAIC,eAAEA,GAA4C,CAAE,GAAA,IAAAC,EAD7FN,KAAAA,KAAAA,YARHC,EAAAA,KAAAA,UACAC,EAAAA,KAAAA,oBACAK,UAAoB,EAAKC,KACzBC,mBAAa,EAAAD,KACbE,gBAAU,EAAAF,KACVH,oBAAc,EAAAG,KAiBdJ,UAAY,IAAMI,KAAKR,OAAOW,QAAQC,KAAK,KAAM,GACjDC,KAAAA,eAAkBC,GACjBA,EAASC,OAAQC,GAA4C,YAAjBA,EAAQC,MAGpDC,KAAAA,YAAcC,iBACrB,MAAMC,QAAoBd,EAAKN,OAAOqB,SAASC,QAAQ,CACrDC,OAAQ,oBAGV,OAAOjB,EAAKO,eAAeO,EAC7B,EAACZ,KAEQgB,kBAAqBC,GACrBjB,KAAKR,OAAO0B,UAAU,kBAAoBZ,GAC/CW,EAAUjB,KAAKK,eAAeC,KAEjCN,KAEQmB,QAAUR,eAAOS,GAMxB,MAAO,CAAEC,GAAI,EAAGC,gBALQxB,EAAKN,OAAOqB,SAASC,QAAQ,CACnDC,OAAQ,kBACRQ,OAAQ,CAACH,EAAII,QAASJ,EAAIK,QAI9B,OAESC,YAAcf,eAAOgB,GAM5B,MAAO,CAAEN,GAAI,EAAGC,gBALQxB,EAAKN,OAAOqB,SAASC,QAAQ,CACnDC,OAAQ,sBACRQ,OAAQ,CAACI,KAIb,OAESC,OAASjB,iBACZb,EAAKI,kBACDJ,EAAKF,YAGb,MAAMiC,YAAEA,GAAgB/B,EAAKD,gBAAkB,CAAE,EAkBjD,OAhBIC,EAAKG,eAAwC,UAAvBH,EAAKN,OAAOsC,aAC9BhC,EAAKN,OAAOuC,QAAQjC,EAAKD,gBACC,cAAvBC,EAAKN,OAAOsC,QAA0BD,SACzC/B,EAAKN,OAAOwC,mBAAmBH,GAAaI,MAAMC,QAAQC,MAa3D,CAAE7B,SAV0B,CACjC8B,IAAKtC,EAAKY,YACVQ,UAAWpB,EAAKkB,mBAQCqB,OALI,CACrBlB,QAASrB,EAAKqB,QACdO,YAAa5B,EAAK4B,aAItB,EA3EW1B,KAAMR,OAANA,EAGTQ,KAAKP,KAAOA,GAAQ,cACpBO,KAAKN,QAAUA,GAAW,QAC1BM,KAAKC,cAAgBN,EACrBK,KAAKE,WAAaN,EAClBI,KAAKH,eAAiBA,CACxB,CAEIyC,iBACF,OAAOtC,KAAKD,QACd,CAiEAwC,SACEC,EAAgBxC,KAAK4B,OAAQ,CAC3BlC,QAASM,KAAKN,QACdD,KAAMO,KAAKP,OAGbO,KAAKD,UAAW,CAClB,mCCtFW6B,EAASjB,MAAOnB,EAAqBiD,EAAqD,CAAA,KAArD,IAAAC,OAAEA,EAAS,YAA0CD,EAA3BE,EAAOC,EAAAH,EAAAI,GACjF,GAAe,aAAXH,EACF,MAAM,IAAII,6BAA6BJ,KAGzC,OAAO,IAAIpD,EAAiBE,EAAQmD,GAASf,QAC/C,EAKaW,EAAS5B,MAAOnB,EAAqBuD,EAAwD,CAAE,KAAI,IAA9DC,QAAEA,EAAU,CAAC,aAA2CD,EAA3BJ,EAAOC,EAAAG,EAAAE,GAChFD,EAAQE,SAAS,aACnB,IAAI5D,EAAiBE,EAAQmD,GAASJ,QACvC"}