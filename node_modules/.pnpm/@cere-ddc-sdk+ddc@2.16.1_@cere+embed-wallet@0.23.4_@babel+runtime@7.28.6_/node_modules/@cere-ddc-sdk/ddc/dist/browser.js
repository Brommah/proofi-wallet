import{ServiceType as e,stackIntercept as t,RpcError as r,Deferred as n,ClientStreamingCall as s,RpcOutputStreamController as o,DuplexStreamingCall as i,mergeRpcOptions as a,UnaryCall as c,DeferredState as l}from"@protobuf-ts/runtime-rpc";import d from"bs58";import{encodeAddress as u,decodeAddress as h,Web3Signer as p,createRandomSigner as g,StorageNodeMode as f}from"@cere-ddc-sdk/blockchain";export{CereWalletSigner,JsonSigner,KeyringSigner,StorageNodeMode,UriSigner}from"@cere-ddc-sdk/blockchain";import{MessageType as y,reflectionMergePartial as m,UnknownFieldHandler as b,WireType as w}from"@protobuf-ts/runtime";import k from"format-util";import{levels as v}from"pino";import{v4 as E}from"uuid";import{Buffer as T}from"buffer";import{createBLAKE3 as U}from"hash-wasm";import R from"async-retry";import N from"cross-fetch";function I(e,t){this.v=e,this.k=t}function S(e){var t,r,n,s=2;for("undefined"!=typeof Symbol&&(r=Symbol.asyncIterator,n=Symbol.iterator);s--;){if(r&&null!=(t=e[r]))return t.call(e);if(n&&null!=(t=e[n]))return new C(t.call(e));r="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function C(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then(function(e){return{value:e,done:t}})}return C=function(e){this.s=e,this.n=e.next},C.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var r=this.s.return;return void 0===r?Promise.resolve({value:e,done:!0}):t(r.apply(this.s,arguments))},throw:function(e){var r=this.s.return;return void 0===r?Promise.reject(e):t(r.apply(this.s,arguments))}},new C(e)}function P(e){return new I(e,0)}function A(){return A=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)({}).hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},A.apply(null,arguments)}function O(e,t){if(null==e)return{};var r={};for(var n in e)if({}.hasOwnProperty.call(e,n)){if(-1!==t.indexOf(n))continue;r[n]=e[n]}return r}function D(e){return function(){return new F(e.apply(this,arguments))}}function F(e){var t,r;function n(t,r){try{var o=e[t](r),i=o.value,a=i instanceof I;Promise.resolve(a?i.v:i).then(function(r){if(a){var c="return"===t?"return":"next";if(!i.k||r.done)return n(c,r);r=e[c](r).value}s(o.done?"return":"normal",r)},function(e){n("throw",e)})}catch(e){s("throw",e)}}function s(e,s){switch(e){case"return":t.resolve({value:s,done:!0});break;case"throw":t.reject(s);break;default:t.resolve({value:s,done:!1})}(t=t.next)?n(t.key,t.arg):r=null}this._invoke=function(e,s){return new Promise(function(o,i){var a={key:e,arg:s,resolve:o,reject:i,next:null};r?r=r.next=a:(t=r=a,n(e,s))})},"function"!=typeof e.return&&(this.return=void 0)}F.prototype["function"==typeof Symbol&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},F.prototype.next=function(e){return this._invoke("next",e)},F.prototype.throw=function(e){return this._invoke("throw",e)},F.prototype.return=function(e){return this._invoke("return",e)};const B=(e,t)=>{const r={};return e&&(r.token=e.toString()),A({},t,r)};var L;!function(e){e[e.OK=0]="OK",e[e.CANCELLED=1]="CANCELLED",e[e.UNKNOWN=2]="UNKNOWN",e[e.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",e[e.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",e[e.NOT_FOUND=5]="NOT_FOUND",e[e.ALREADY_EXISTS=6]="ALREADY_EXISTS",e[e.PERMISSION_DENIED=7]="PERMISSION_DENIED",e[e.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",e[e.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",e[e.ABORTED=10]="ABORTED",e[e.OUT_OF_RANGE=11]="OUT_OF_RANGE",e[e.UNIMPLEMENTED=12]="UNIMPLEMENTED",e[e.INTERNAL=13]="INTERNAL",e[e.UNAVAILABLE=14]="UNAVAILABLE",e[e.DATA_LOSS=15]="DATA_LOSS",e[e.UNAUTHENTICATED=16]="UNAUTHENTICATED"}(L||(L={}));const x=1024,M=1048576,_=4*M,j=128*M,H=[L.UNAVAILABLE,L.DEADLINE_EXCEEDED,L.RESOURCE_EXHAUSTED,L.ABORTED,L.INTERNAL,L.UNKNOWN,L.CANCELLED],q=5;var $;!function(e){e[e.ED_25519=0]="ED_25519",e[e.SR_25519=1]="SR_25519"}($||($={}));const W=new class extends y{constructor(){super("common.Signature",[{no:1,name:"algorithm",kind:"enum",T:()=>["common.Signature.Algorithm",$]},{no:2,name:"signer",kind:"scalar",T:12},{no:3,name:"value",kind:"scalar",T:12}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.algorithm=0,t.signer=new Uint8Array(0),t.value=new Uint8Array(0),void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();switch(t){case 1:s.algorithm=e.int32();break;case 2:s.signer=e.bytes();break;case 3:s.value=e.bytes();break;default:let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){0!==e.algorithm&&t.tag(1,w.Varint).int32(e.algorithm),e.signer.length&&t.tag(2,w.LengthDelimited).bytes(e.signer),e.value.length&&t.tag(3,w.LengthDelimited).bytes(e.value);let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},z=e=>({algorithm:e.algorithm===$.SR_25519?"sr25519":"ed25519",signer:u(e.signer),value:new Uint8Array(e.value)}),G=async(e,t,{token:r}={})=>{const n=ue(e,r);if(await n.isReady(),"ed25519"!==n.type&&"sr25519"!==n.type)throw new Error(`Signer type ${n.type} is not allowed in DDC`);return W.create({algorithm:"ed25519"===n.type?$.ED_25519:$.SR_25519,signer:n.publicKey,value:await n.sign(t)})};var V;!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.PUT=1]="PUT",e[e.GET=2]="GET",e[e.DELETE=3]="DELETE"}(V||(V={}));const K=new class extends y{constructor(){super("AuthToken",[{no:1,name:"signature",kind:"message",T:()=>W},{no:2,name:"payload",kind:"message",T:()=>X}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();switch(t){case 1:s.signature=W.internalBinaryRead(e,e.uint32(),r,s.signature);break;case 2:s.payload=X.internalBinaryRead(e,e.uint32(),r,s.payload);break;default:let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){e.signature&&W.internalBinaryWrite(e.signature,t.tag(1,w.LengthDelimited).fork(),r).join(),e.payload&&X.internalBinaryWrite(e.payload,t.tag(2,w.LengthDelimited).fork(),r).join();let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},X=new class extends y{constructor(){super("Payload",[{no:1,name:"prev",kind:"message",T:()=>K},{no:2,name:"subject",kind:"scalar",opt:!0,T:12},{no:3,name:"canDelegate",kind:"scalar",opt:!0,T:8},{no:4,name:"bucketId",kind:"scalar",opt:!0,T:4,L:0},{no:5,name:"operations",kind:"enum",repeat:1,T:()=>["Operation",V]},{no:6,name:"expiresAt",kind:"scalar",opt:!0,T:3,L:2},{no:7,name:"pieceCid",kind:"scalar",opt:!0,T:12}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.operations=[],void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();switch(t){case 1:s.prev=K.internalBinaryRead(e,e.uint32(),r,s.prev);break;case 2:s.subject=e.bytes();break;case 3:s.canDelegate=e.bool();break;case 4:s.bucketId=e.uint64().toBigInt();break;case 5:if(n===w.LengthDelimited)for(let t=e.int32()+e.pos;e.pos<t;)s.operations.push(e.int32());else s.operations.push(e.int32());break;case 6:s.expiresAt=e.int64().toNumber();break;case 7:s.pieceCid=e.bytes();break;default:let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){if(e.prev&&K.internalBinaryWrite(e.prev,t.tag(1,w.LengthDelimited).fork(),r).join(),void 0!==e.subject&&t.tag(2,w.LengthDelimited).bytes(e.subject),void 0!==e.canDelegate&&t.tag(3,w.Varint).bool(e.canDelegate),void 0!==e.bucketId&&t.tag(4,w.Varint).uint64(e.bucketId),e.operations.length){t.tag(5,w.LengthDelimited).fork();for(let r=0;r<e.operations.length;r++)t.int32(e.operations[r]);t.join()}void 0!==e.expiresAt&&t.tag(6,w.Varint).int64(e.expiresAt),void 0!==e.pieceCid&&t.tag(7,w.LengthDelimited).bytes(e.pieceCid);let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}};class J{name;prefix;baseEncode;constructor(e,t,r){this.name=e,this.prefix=t,this.baseEncode=r}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}}class Y{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,r){this.name=e,this.prefix=t;const n=t.codePointAt(0);if(void 0===n)throw new Error("Invalid prefix character");this.prefixCodePoint=n,this.baseDecode=r}decode(e){if("string"==typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return Z(this,e)}}class Q{decoders;constructor(e){this.decoders=e}or(e){return Z(this,e)}decode(e){const t=this.decoders[e[0]];if(null!=t)return t.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function Z(e,t){return new Q({...e.decoders??{[e.prefix]:e},...t.decoders??{[t.prefix]:t}})}class ee{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,r,n){this.name=e,this.prefix=t,this.baseEncode=r,this.baseDecode=n,this.encoder=new J(e,t,r),this.decoder=new Y(e,t,n)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}function te({name:e,prefix:t,bitsPerChar:r,alphabet:n}){const s=function(e){const t={};for(let r=0;r<e.length;++r)t[e[r]]=r;return t}(n);return function({name:e,prefix:t,encode:r,decode:n}){return new ee(e,t,r,n)}({prefix:t,name:e,encode:e=>function(e,t,r){const n="="===t[t.length-1],s=(1<<r)-1;let o="",i=0,a=0;for(let n=0;n<e.length;++n)for(a=a<<8|e[n],i+=8;i>r;)i-=r,o+=t[s&a>>i];if(0!==i&&(o+=t[s&a<<r-i]),n)for(;o.length*r&7;)o+="=";return o}(e,n,r),decode:t=>function(e,t,r,n){let s=e.length;for(;"="===e[s-1];)--s;const o=new Uint8Array(s*r/8|0);let i=0,a=0,c=0;for(let l=0;l<s;++l){const s=t[e[l]];if(void 0===s)throw new SyntaxError(`Non-${n} character`);a=a<<r|s,i+=r,i>=8&&(i-=8,o[c++]=255&a>>i)}if(i>=r||255&a<<8-i)throw new SyntaxError("Unexpected end of data");return o}(t,s,r,e)})}const re=te({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5});te({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),te({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),te({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),te({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),te({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),te({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),te({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),te({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5});const ne=["none","dag-node","raw-piece","multipart-piece"];class se{constructor(e){this.cid=void 0,this.cid=e instanceof se?e.toBytes():e}get contentHash(){return this.toBytes().slice(-32)}get contentType(){return ne[this.toBytes()[1]]}toString(){return"string"==typeof this.cid?this.cid:re.encode(this.cid)}toBytes(){return"string"==typeof this.cid?re.decode(this.cid):this.cid}static isCid(e){try{return new se(e).toBytes().byteLength>32}catch(e){return!1}}}const oe=["subject"];class ie{constructor(e){var t,r,n,s;this.token=void 0;const o=null!=(t=e.expiresIn)?t:2592e6,i={bucketId:e.bucketId,operations:e.operations,canDelegate:null!=(r=e.canDelegate)&&r,expiresAt:null!=(n=e.expiresAt)?n:Date.now()+o,subject:e.subject?h(e.subject):void 0,pieceCid:e.pieceCid?new se(e.pieceCid).toBytes():void 0,prev:null==(s=ie.maybeToken(e.prev))?void 0:s.token};this.token=K.create({payload:i})}get subject(){var e;return(null==(e=this.token.payload)?void 0:e.subject)&&u(this.token.payload.subject)}get signature(){return this.token.signature&&z(this.token.signature)}get canDelegate(){var e;return null!=(e=this.token.payload.canDelegate)&&e}get bucketId(){return this.token.payload.bucketId}get operations(){return this.token.payload.operations}get pieceCid(){return this.token.payload.pieceCid&&new se(this.token.payload.pieceCid).toString()}get expiresAt(){return this.token.payload.expiresAt}get isSigned(){var e;return this.subject?(null==(e=this.signature)?void 0:e.signer)===this.subject:!!this.signature}toBinary(){return K.toBinary(this.token)}static fromProto(e){const t=new ie({operations:[]});return t.token=e,t}toString(){return d.encode(this.toBinary())}async sign(e){return this.token.signature=await G(e,this.toBinary()),this}static from(e){const t=this.maybeToken(e);if(null==t||!t.token.payload)throw new Error("Invalid token");const r=t.token.payload,{subject:n}=r,s=O(r,oe);return new ie(A({},s,{prev:n&&t}))}static maybeToken(e){return"string"!=typeof e?e:this.fromProto(K.fromBinary(d.decode(e)))}static fullAccess(e={}){return new ie(A({},e,{operations:[V.GET,V.PUT,V.DELETE]}))}}const ae=new WeakMap,ce=e=>(ae.has(e)||ae.set(e,new Map),ae.get(e)),le=(e,t)=>ce(e).get(t),de=async e=>{if(!(e=>e instanceof p)(e))return ie.fullAccess().sign(e);const t=await(async e=>{const t=g({type:e.type});return await t.isReady(),ce(e).set(t.address,t),t})(e);return ie.fullAccess({subject:t.address}).sign(e)},ue=(e,t)=>{const r=ie.maybeToken(t);return(null==r?void 0:r.signature)&&le(e,r.signature.signer)||e},he=globalThis.console,pe=e=>{var t;return e.logLevel||(null==(t=e.logger)?void 0:t.level)||"warn"},ge=(e,t,r)=>(...n)=>{var s,o;const i=pe(r);if("silent"===i||v.values[e]<v.values[i])return;const a=null!=(s=null==(o=r.logOptions)?void 0:o.msgPrefix)?s:`[${t}] `,c=n.filter(e=>void 0!==e),l=he[e],[d,u,...h]=c;if("string"==typeof d){const[e,...t]=c;return l(k(`${a}${e}`,...t))}return l(k(`${a}${u}`,...h),d)},fe=(e,t={})=>({level:pe(t),debug:ge("debug",e,t),info:ge("info",e,t),warn:ge("warn",e,t),error:ge("error",e,t),fatal:ge("error",e,t),trace:ge("trace",e,t),silent:()=>{}}),ye=new WeakSet,me=(e,t,r)=>{for(const n of r.filter(t=>"function"==typeof e[t])){const r=e[n];e[n]=async function(...e){try{return await r.apply(this,e)}catch(e){const n=e;throw ye.has(n)||(ye.add(n),t.error(n,"Error in %s",r.name||"anonymous function")),n}}}},be=new class extends y{constructor(){super("cns.PutRequest",[{no:1,name:"bucketId",kind:"scalar",T:4,L:0},{no:2,name:"record",kind:"message",T:()=>Ee}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.bucketId=0n,void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();switch(t){case 1:s.bucketId=e.uint64().toBigInt();break;case 2:s.record=Ee.internalBinaryRead(e,e.uint32(),r,s.record);break;default:let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){0n!==e.bucketId&&t.tag(1,w.Varint).uint64(e.bucketId),e.record&&Ee.internalBinaryWrite(e.record,t.tag(2,w.LengthDelimited).fork(),r).join();let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},we=new class extends y{constructor(){super("cns.PutResponse",[])}create(e){const t=globalThis.Object.create(this.messagePrototype);return void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){return null!=n?n:this.create()}internalBinaryWrite(e,t,r){let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},ke=new class extends y{constructor(){super("cns.GetRequest",[{no:1,name:"bucketId",kind:"scalar",T:4,L:0},{no:2,name:"name",kind:"scalar",T:9}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.bucketId=0n,t.name="",void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();switch(t){case 1:s.bucketId=e.uint64().toBigInt();break;case 2:s.name=e.string();break;default:let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){0n!==e.bucketId&&t.tag(1,w.Varint).uint64(e.bucketId),""!==e.name&&t.tag(2,w.LengthDelimited).string(e.name);let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},ve=new class extends y{constructor(){super("cns.GetResponse",[{no:1,name:"record",kind:"message",T:()=>Ee}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();if(1===t)s.record=Ee.internalBinaryRead(e,e.uint32(),r,s.record);else{let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){e.record&&Ee.internalBinaryWrite(e.record,t.tag(1,w.LengthDelimited).fork(),r).join();let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},Ee=new class extends y{constructor(){super("cns.Record",[{no:1,name:"signature",kind:"message",T:()=>W},{no:2,name:"cid",kind:"scalar",T:12},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"ttl",kind:"scalar",opt:!0,T:13}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.cid=new Uint8Array(0),t.name="",void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();switch(t){case 1:s.signature=W.internalBinaryRead(e,e.uint32(),r,s.signature);break;case 2:s.cid=e.bytes();break;case 3:s.name=e.string();break;case 4:s.ttl=e.uint32();break;default:let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){e.signature&&W.internalBinaryWrite(e.signature,t.tag(1,w.LengthDelimited).fork(),r).join(),e.cid.length&&t.tag(2,w.LengthDelimited).bytes(e.cid),""!==e.name&&t.tag(3,w.LengthDelimited).string(e.name),void 0!==e.ttl&&t.tag(4,w.Varint).uint32(e.ttl);let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},Te=new e("cns.CnsApi",[{name:"Put",options:{"google.api.http":{post:"/v1/cns/{bucketId}",body:"*"}},I:be,O:we},{name:"Get",options:{"google.api.http":{get:"/v1/cns/{bucketId}/{name}"}},I:ke,O:ve}]);class Ue{constructor(e){this._transport=void 0,this.typeName=Te.typeName,this.methods=Te.methods,this.options=Te.options,this._transport=e}put(e,r){const n=this.methods[0],s=this._transport.mergeOptions(r);return t("unary",this._transport,n,s,e)}get(e,r){const n=this.methods[1],s=this._transport.mergeOptions(r);return t("unary",this._transport,n,s,e)}}var Re,Ne;!function(e){e[e.STORE=0]="STORE",e[e.GET=1]="GET"}(Re||(Re={})),function(e){e[e.PIECE=0]="PIECE",e[e.SEGMENT=1]="SEGMENT",e[e.MERKLE_TREE=2]="MERKLE_TREE"}(Ne||(Ne={})),new class extends y{constructor(){super("activity_report.ActivityRecord",[{no:1,name:"upstream",kind:"message",T:()=>Ce},{no:2,name:"downstream",kind:"message",repeat:1,T:()=>Ce},{no:3,name:"timestamp",kind:"scalar",T:4,L:2},{no:10,name:"signature",kind:"message",T:()=>W}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.downstream=[],t.timestamp=0,void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();switch(t){case 1:s.upstream=Ce.internalBinaryRead(e,e.uint32(),r,s.upstream);break;case 2:s.downstream.push(Ce.internalBinaryRead(e,e.uint32(),r));break;case 3:s.timestamp=e.uint64().toNumber();break;case 10:s.signature=W.internalBinaryRead(e,e.uint32(),r,s.signature);break;default:let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){e.upstream&&Ce.internalBinaryWrite(e.upstream,t.tag(1,w.LengthDelimited).fork(),r).join();for(let n=0;n<e.downstream.length;n++)Ce.internalBinaryWrite(e.downstream[n],t.tag(2,w.LengthDelimited).fork(),r).join();0!==e.timestamp&&t.tag(3,w.Varint).uint64(e.timestamp),e.signature&&W.internalBinaryWrite(e.signature,t.tag(10,w.LengthDelimited).fork(),r).join();let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}};const Ie=new class extends y{constructor(){super("activity_report.ActivityRequest",[{no:1,name:"parentRequest",kind:"message",T:()=>Ie},{no:2,name:"requestId",kind:"scalar",T:9},{no:3,name:"requestType",kind:"enum",T:()=>["activity_report.ActivityRequest.RequestType",Re,"REQUEST_TYPE_"]},{no:4,name:"contentType",kind:"enum",T:()=>["activity_report.ActivityRequest.ContentType",Ne,"CONTENT_TYPE_"]},{no:5,name:"bucketId",kind:"scalar",T:4,L:0},{no:6,name:"id",kind:"scalar",T:12},{no:7,name:"offset",kind:"scalar",T:4,L:2},{no:8,name:"size",kind:"scalar",T:4,L:2},{no:9,name:"timestamp",kind:"scalar",T:4,L:2},{no:10,name:"signature",kind:"message",T:()=>W}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.requestId="",t.requestType=0,t.contentType=0,t.bucketId=0n,t.id=new Uint8Array(0),t.offset=0,t.size=0,t.timestamp=0,void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();switch(t){case 1:s.parentRequest=Ie.internalBinaryRead(e,e.uint32(),r,s.parentRequest);break;case 2:s.requestId=e.string();break;case 3:s.requestType=e.int32();break;case 4:s.contentType=e.int32();break;case 5:s.bucketId=e.uint64().toBigInt();break;case 6:s.id=e.bytes();break;case 7:s.offset=e.uint64().toNumber();break;case 8:s.size=e.uint64().toNumber();break;case 9:s.timestamp=e.uint64().toNumber();break;case 10:s.signature=W.internalBinaryRead(e,e.uint32(),r,s.signature);break;default:let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){e.parentRequest&&Ie.internalBinaryWrite(e.parentRequest,t.tag(1,w.LengthDelimited).fork(),r).join(),""!==e.requestId&&t.tag(2,w.LengthDelimited).string(e.requestId),0!==e.requestType&&t.tag(3,w.Varint).int32(e.requestType),0!==e.contentType&&t.tag(4,w.Varint).int32(e.contentType),0n!==e.bucketId&&t.tag(5,w.Varint).uint64(e.bucketId),e.id.length&&t.tag(6,w.LengthDelimited).bytes(e.id),0!==e.offset&&t.tag(7,w.Varint).uint64(e.offset),0!==e.size&&t.tag(8,w.Varint).uint64(e.size),0!==e.timestamp&&t.tag(9,w.Varint).uint64(e.timestamp),e.signature&&W.internalBinaryWrite(e.signature,t.tag(10,w.LengthDelimited).fork(),r).join();let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},Se=new class extends y{constructor(){super("activity_report.ActivityAcknowledgment",[{no:1,name:"requestId",kind:"scalar",T:9},{no:2,name:"bytesStoredOrDelivered",kind:"scalar",T:4,L:2},{no:3,name:"timestamp",kind:"scalar",T:4,L:2},{no:4,name:"signature",kind:"message",T:()=>W}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.requestId="",t.bytesStoredOrDelivered=0,t.timestamp=0,void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();switch(t){case 1:s.requestId=e.string();break;case 2:s.bytesStoredOrDelivered=e.uint64().toNumber();break;case 3:s.timestamp=e.uint64().toNumber();break;case 4:s.signature=W.internalBinaryRead(e,e.uint32(),r,s.signature);break;default:let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){""!==e.requestId&&t.tag(1,w.LengthDelimited).string(e.requestId),0!==e.bytesStoredOrDelivered&&t.tag(2,w.Varint).uint64(e.bytesStoredOrDelivered),0!==e.timestamp&&t.tag(3,w.Varint).uint64(e.timestamp),e.signature&&W.internalBinaryWrite(e.signature,t.tag(4,w.LengthDelimited).fork(),r).join();let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},Ce=new class extends y{constructor(){super("activity_report.ActivityFulfillment",[{no:1,name:"request",kind:"message",T:()=>Ie},{no:2,name:"ack",kind:"message",T:()=>Se}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();switch(t){case 1:s.request=Ie.internalBinaryRead(e,e.uint32(),r,s.request);break;case 2:s.ack=Se.internalBinaryRead(e,e.uint32(),r,s.ack);break;default:let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){e.request&&Ie.internalBinaryWrite(e.request,t.tag(1,w.LengthDelimited).fork(),r).join(),e.ack&&Se.internalBinaryWrite(e.ack,t.tag(2,w.LengthDelimited).fork(),r).join();let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},Pe=["signer","logger"],Ae=async(e,t)=>{let{signer:r,logger:n}=t,s=O(t,Pe);if(!r)throw new Error("Activity capturing cannot be enabled. Signer requred!");const o=Ie.create(A({timestamp:Date.now(),requestId:Oe()},e,{contentType:Ne.PIECE}));return o.signature=await G(r,Ie.toBinary(o),s),null==n||n.debug({activityRequest:o},"Activity request"),T.from(Ie.toBinary(o)).toString("base64")},Oe=()=>E(),De=["signer","logger"],Fe=async(e,t)=>{let{signer:r,logger:n}=t,s=O(t,De);if(!r)throw new Error("Cannot sign acknowledgment. Signer requred!");const o=Se.create(A({},e,{signature:await G(r,Se.toBinary(e),s)}));return null==n||n.debug({signedAck:o},"Activity acknowledgment"),o},Be="correlation-id",Le=(e,t)=>A({},t,{[Be]:e||E()}),xe=()=>E();class Me{constructor(e,t={}){this.options=void 0,this.logger=void 0,this.api=void 0,this.options=t,this.api=new Ue(e),this.logger=fe("CnsApi",t)}async putRecord({token:e,bucketId:t,record:r,correlationId:n}){this.logger.debug({bucketId:t,record:r,token:e,correlationId:n},"Storing CNS record");const s=Le(n,B(e)),{signer:o}=this.options;if(!o)throw new Error("Unnable to store CNS record. Signer required!");const i=await G(o,(e=>{const t=Ee.create(e);return Ee.toBinary(t)})(r),{token:e});return s.request=await Ae({bucketId:t,size:Ee.toBinary(r).byteLength,requestType:Re.STORE},{logger:this.logger,signer:o}),await this.api.put({bucketId:t,record:A({},r,{signature:i})},{meta:s}),this.logger.debug({record:r,correlationId:n},"CNS record stored"),A({},r,{signature:z(i)})}async getRecord({token:e,name:t,bucketId:n,correlationId:s,cacheControl:o}){var i;let a;this.logger.debug({name:t,bucketId:n,token:e,correlationId:s,cacheControl:o},"Retrieving CNS record");const c=Le(s,B(e));o&&(c["cache-control"]=o),this.options.signer&&(c.request=await Ae({bucketId:n,requestType:Re.GET},{token:e,logger:this.logger,signer:this.options.signer}));try{const{response:e}=await this.api.get({name:t,bucketId:n},{meta:c});a=e.record}catch(e){if(!(e instanceof r&&e.code===L[L.UNKNOWN]&&"no result"===e.message))throw e}if(null!=(i=a)&&i.signature)return this.logger.debug({record:a,correlationId:s},"CNS record retrieved"),A({},a,{signature:z(a.signature),cid:new Uint8Array(a.cid)});this.logger.debug({name:t,bucketId:n,correlationId:s},"CNS record not found")}}const _e=new class extends y{constructor(){super("dag.PutRequest",[{no:1,name:"bucketId",kind:"scalar",T:4,L:0},{no:2,name:"node",kind:"message",T:()=>$e},{no:3,name:"cid",kind:"scalar",opt:!0,T:12}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.bucketId=0n,void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();switch(t){case 1:s.bucketId=e.uint64().toBigInt();break;case 2:s.node=$e.internalBinaryRead(e,e.uint32(),r,s.node);break;case 3:s.cid=e.bytes();break;default:let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){0n!==e.bucketId&&t.tag(1,w.Varint).uint64(e.bucketId),e.node&&$e.internalBinaryWrite(e.node,t.tag(2,w.LengthDelimited).fork(),r).join(),void 0!==e.cid&&t.tag(3,w.LengthDelimited).bytes(e.cid);let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},je=new class extends y{constructor(){super("dag.PutResponse",[{no:1,name:"cid",kind:"scalar",T:12}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.cid=new Uint8Array(0),void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();if(1===t)s.cid=e.bytes();else{let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){e.cid.length&&t.tag(1,w.LengthDelimited).bytes(e.cid);let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},He=new class extends y{constructor(){super("dag.GetRequest",[{no:1,name:"bucketId",kind:"scalar",T:4,L:0},{no:2,name:"cid",kind:"scalar",T:12},{no:3,name:"path",kind:"scalar",opt:!0,T:9}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.bucketId=0n,t.cid=new Uint8Array(0),void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();switch(t){case 1:s.bucketId=e.uint64().toBigInt();break;case 2:s.cid=e.bytes();break;case 3:s.path=e.string();break;default:let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){0n!==e.bucketId&&t.tag(1,w.Varint).uint64(e.bucketId),e.cid.length&&t.tag(2,w.LengthDelimited).bytes(e.cid),void 0!==e.path&&t.tag(3,w.LengthDelimited).string(e.path);let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},qe=new class extends y{constructor(){super("dag.GetResponse",[{no:1,name:"node",kind:"message",T:()=>$e}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();if(1===t)s.node=$e.internalBinaryRead(e,e.uint32(),r,s.node);else{let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){e.node&&$e.internalBinaryWrite(e.node,t.tag(1,w.LengthDelimited).fork(),r).join();let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},$e=new class extends y{constructor(){super("dag.Node",[{no:1,name:"data",kind:"scalar",T:12},{no:2,name:"links",kind:"message",repeat:1,T:()=>We},{no:3,name:"tags",kind:"message",repeat:1,T:()=>ze}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.data=new Uint8Array(0),t.links=[],t.tags=[],void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();switch(t){case 1:s.data=e.bytes();break;case 2:s.links.push(We.internalBinaryRead(e,e.uint32(),r));break;case 3:s.tags.push(ze.internalBinaryRead(e,e.uint32(),r));break;default:let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){e.data.length&&t.tag(1,w.LengthDelimited).bytes(e.data);for(let n=0;n<e.links.length;n++)We.internalBinaryWrite(e.links[n],t.tag(2,w.LengthDelimited).fork(),r).join();for(let n=0;n<e.tags.length;n++)ze.internalBinaryWrite(e.tags[n],t.tag(3,w.LengthDelimited).fork(),r).join();let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},We=new class extends y{constructor(){super("dag.Link",[{no:1,name:"cid",kind:"scalar",T:12},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"size",kind:"scalar",T:4,L:2}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.cid=new Uint8Array(0),t.name="",t.size=0,void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();switch(t){case 1:s.cid=e.bytes();break;case 2:s.name=e.string();break;case 3:s.size=e.uint64().toNumber();break;default:let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){e.cid.length&&t.tag(1,w.LengthDelimited).bytes(e.cid),""!==e.name&&t.tag(2,w.LengthDelimited).string(e.name),0!==e.size&&t.tag(3,w.Varint).uint64(e.size);let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},ze=new class extends y{constructor(){super("dag.Tag",[{no:1,name:"key",kind:"scalar",T:9},{no:2,name:"value",kind:"scalar",T:9}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.key="",t.value="",void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();switch(t){case 1:s.key=e.string();break;case 2:s.value=e.string();break;default:let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){""!==e.key&&t.tag(1,w.LengthDelimited).string(e.key),""!==e.value&&t.tag(2,w.LengthDelimited).string(e.value);let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},Ge=new e("dag.DagApi",[{name:"Put",options:{"google.api.http":{post:"/v1/dag/{bucketId}",body:"*"}},I:_e,O:je},{name:"Get",options:{"google.api.http":{get:"/v1/dag/{bucketId}/{cid}/{path}",additionalBindings:[{get:"/v1/dag/{bucketId}/{cid}"}]}},I:He,O:qe}]);class Ve{constructor(e){this._transport=void 0,this.typeName=Ge.typeName,this.methods=Ge.methods,this.options=Ge.options,this._transport=e}put(e,r){const n=this.methods[0],s=this._transport.mergeOptions(r);return t("unary",this._transport,n,s,e)}get(e,r){const n=this.methods[1],s=this._transport.mergeOptions(r);return t("unary",this._transport,n,s,e)}}class Ke{constructor(e,{logger:t,enable:r=!0}={}){this.hasherPromise=void 0,this.cid=void 0,this.logger=void 0,this.enable=void 0,this.cid=new se(e),this.logger=t,this.enable=r}async getHasher(){return this.hasherPromise||(this.hasherPromise=U()),this.hasherPromise}async update(e){return this.enable?((await this.getHasher()).update(e),this):this}async validate(){var e;if(!this.enable)return;const t=(await this.getHasher()).digest("hex"),r=Buffer.from(this.cid.contentHash).toString("hex");if(null==(e=this.logger)||e.debug({expectedHash:r,receivedHash:t},"Validating content hash"),t!==r)throw new Error("Received content is not valid - hash does not match")}}const Xe=["range"];class Je extends Ke{constructor(e,t={}){let{range:r}=t;super(e,O(t,Xe)),this.range=void 0,this.isProved=!1,this.range=r}async prove({proof:e}){this.isProved=e.length>0}async validate(){this.isProved||this.range||await super.validate()}}class Ye extends Ke{}const Qe=["token","correlationId"];class Ze{constructor(e,t={}){var r;this.logger=void 0,this.api=void 0,this.options=void 0,this.api=new Ve(e),this.logger=fe("DagApi",t),this.options=A({},t,{authenticate:null!=(r=t.authenticate)&&r})}async putNode({token:e,bucketId:t,node:r,cid:n,correlationId:s}){const o=Le(s,B(e));this.logger.debug({token:e,correlationId:s,bucketId:t,node:r,cid:n},"Storing DAG Node"),this.options.signer&&r&&(o.request=await Ae({id:n,bucketId:t,size:$e.toBinary(r).byteLength,requestType:Re.STORE},{token:e,logger:this.logger,signer:this.options.signer}));const{response:i}=await this.api.put({bucketId:t,node:r,cid:n},{meta:o});return this.logger.debug({cid:n,correlationId:s},"DAG Node stored"),new Uint8Array(i.cid)}async getNode(e){let{token:t,correlationId:r}=e,n=O(e,Qe);this.logger.debug(A({},n,{token:t,correlationId:r}),"Retrieving DAG Node");const s=this.options.authenticate&&!n.path,o=Le(r,B(t)),i=new Ye(n.cid,{enable:s,logger:this.logger});this.options.signer&&(o.request=await Ae({id:n.cid,bucketId:n.bucketId,requestType:Re.GET},{token:t,logger:this.logger,signer:this.options.signer}));const{response:a}=await this.api.get(n,{meta:o});return a.node&&s&&await i.update($e.toBinary(a.node)),await i.validate(),this.logger.debug({node:a.node,correlationId:r},"DAG Node retrieved"),a.node&&A({},a.node,{data:new Uint8Array(a.node.data)})}}var et,tt;class rt extends globalThis.TransformStream{}class nt extends globalThis.ReadableStream{}null!=(et=globalThis.ReadableStream.prototype)[tt=Symbol.asyncIterator]||(et[tt]=/*#__PURE__*/D(function*(){const e=this.getReader();try{for(;;){const{done:t,value:r}=yield P(e.read());if(t)return;yield r}}finally{e.releaseLock()}}));const st=e=>{let t;const r=Uint8Array.prototype.slice;return new rt({transform(n,s){for(t=t?T.concat([t,n]):T.from(n);t.byteLength>=e;)s.enqueue(r.call(t,0,e)),t=T.from(r.call(t,e))},flush(e){var n;null!=(n=t)&&n.byteLength&&e.enqueue(r.call(t)),t=void 0}})};function ot(){return(ot=D(function*(e){if(!(e=>"getReader"in e)(e))return yield*function(e){var t={},r=!1;function n(t,n){return r=!0,n=new Promise(function(r){r(e[t](n))}),{done:!1,value:new I(n,1)}}return t["undefined"!=typeof Symbol&&Symbol.iterator||"@@iterator"]=function(){return this},t.next=function(e){return r?(r=!1,e):n("next",e)},"function"==typeof e.throw&&(t.throw=function(e){if(r)throw r=!1,e;return n("throw",e)}),"function"==typeof e.return&&(t.return=function(e){return r?(r=!1,e):n("return",e)}),t}(S(e));const t=e.getReader();for(;;){const{done:e,value:r}=yield P(t.read());if(e)break;yield r}})).apply(this,arguments)}const it=(e,t)=>"byteLength"in e?e.byteLength:t,at=Symbol("ContentStream"),ct=e=>!!e&&"object"==typeof e&&at in e,lt=(e,t=4091904)=>{const r=function(e){return ot.apply(this,arguments)}(e instanceof Uint8Array?[e]:e),n=new nt({async pull(e){const{done:t,value:n}=await r.next();n&&e.enqueue(n),t&&e.close()}});return Object.assign(t?n.pipeThrough(st(t)):n,{[at]:!0})},dt=e=>new Response(e).json(),ut=e=>new Response(e).arrayBuffer(),ht=e=>new Response(e).text();var pt={__proto__:null,json:dt,arrayBuffer:ut,text:ht};const gt=new class extends y{constructor(){super("file.PutRawPieceRequest",[{no:1,name:"metadata",kind:"message",oneof:"body",T:()=>ft},{no:2,name:"content",kind:"message",oneof:"body",T:()=>yt}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.body={oneofKind:void 0},void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();switch(t){case 1:s.body={oneofKind:"metadata",metadata:ft.internalBinaryRead(e,e.uint32(),r,s.body.metadata)};break;case 2:s.body={oneofKind:"content",content:yt.internalBinaryRead(e,e.uint32(),r,s.body.content)};break;default:let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){"metadata"===e.body.oneofKind&&ft.internalBinaryWrite(e.body.metadata,t.tag(1,w.LengthDelimited).fork(),r).join(),"content"===e.body.oneofKind&&yt.internalBinaryWrite(e.body.content,t.tag(2,w.LengthDelimited).fork(),r).join();let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},ft=new class extends y{constructor(){super("file.PutRawPieceRequest.Metadata",[{no:1,name:"bucketId",kind:"scalar",T:4,L:0},{no:2,name:"cid",kind:"scalar",opt:!0,T:12},{no:3,name:"offset",kind:"scalar",opt:!0,T:4,L:2},{no:4,name:"isMultipart",kind:"scalar",T:8},{no:5,name:"size",kind:"scalar",T:4,L:2}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.bucketId=0n,t.isMultipart=!1,t.size=0,void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();switch(t){case 1:s.bucketId=e.uint64().toBigInt();break;case 2:s.cid=e.bytes();break;case 3:s.offset=e.uint64().toNumber();break;case 4:s.isMultipart=e.bool();break;case 5:s.size=e.uint64().toNumber();break;default:let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){0n!==e.bucketId&&t.tag(1,w.Varint).uint64(e.bucketId),void 0!==e.cid&&t.tag(2,w.LengthDelimited).bytes(e.cid),void 0!==e.offset&&t.tag(3,w.Varint).uint64(e.offset),!1!==e.isMultipart&&t.tag(4,w.Varint).bool(e.isMultipart),0!==e.size&&t.tag(5,w.Varint).uint64(e.size);let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},yt=new class extends y{constructor(){super("file.PutRawPieceRequest.Content",[{no:1,name:"data",kind:"scalar",T:12}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.data=new Uint8Array(0),void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();if(1===t)s.data=e.bytes();else{let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){e.data.length&&t.tag(1,w.LengthDelimited).bytes(e.data);let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},mt=new class extends y{constructor(){super("file.PutRawPieceResponse",[{no:1,name:"cid",kind:"scalar",T:12}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.cid=new Uint8Array(0),void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();if(1===t)s.cid=e.bytes();else{let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){e.cid.length&&t.tag(1,w.LengthDelimited).bytes(e.cid);let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},bt=new class extends y{constructor(){super("file.PutMultiPartPieceRequest",[{no:1,name:"bucketId",kind:"scalar",T:4,L:0},{no:2,name:"cid",kind:"scalar",opt:!0,T:12},{no:3,name:"totalSize",kind:"scalar",T:4,L:2},{no:4,name:"partSize",kind:"scalar",T:4,L:2},{no:5,name:"partHashes",kind:"scalar",repeat:2,T:12}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.bucketId=0n,t.totalSize=0,t.partSize=0,t.partHashes=[],void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();switch(t){case 1:s.bucketId=e.uint64().toBigInt();break;case 2:s.cid=e.bytes();break;case 3:s.totalSize=e.uint64().toNumber();break;case 4:s.partSize=e.uint64().toNumber();break;case 5:s.partHashes.push(e.bytes());break;default:let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){0n!==e.bucketId&&t.tag(1,w.Varint).uint64(e.bucketId),void 0!==e.cid&&t.tag(2,w.LengthDelimited).bytes(e.cid),0!==e.totalSize&&t.tag(3,w.Varint).uint64(e.totalSize),0!==e.partSize&&t.tag(4,w.Varint).uint64(e.partSize);for(let r=0;r<e.partHashes.length;r++)t.tag(5,w.LengthDelimited).bytes(e.partHashes[r]);let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},wt=new class extends y{constructor(){super("file.PutMultiPartPieceResponse",[{no:1,name:"cid",kind:"scalar",T:12}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.cid=new Uint8Array(0),void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();if(1===t)s.cid=e.bytes();else{let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){e.cid.length&&t.tag(1,w.LengthDelimited).bytes(e.cid);let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},kt=new class extends y{constructor(){super("file.GetFileRequest",[{no:1,name:"request",kind:"message",oneof:"body",T:()=>vt},{no:2,name:"ack",kind:"message",oneof:"body",T:()=>Se}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.body={oneofKind:void 0},void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();switch(t){case 1:s.body={oneofKind:"request",request:vt.internalBinaryRead(e,e.uint32(),r,s.body.request)};break;case 2:s.body={oneofKind:"ack",ack:Se.internalBinaryRead(e,e.uint32(),r,s.body.ack)};break;default:let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){"request"===e.body.oneofKind&&vt.internalBinaryWrite(e.body.request,t.tag(1,w.LengthDelimited).fork(),r).join(),"ack"===e.body.oneofKind&&Se.internalBinaryWrite(e.body.ack,t.tag(2,w.LengthDelimited).fork(),r).join();let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},vt=new class extends y{constructor(){super("file.GetFileRequest.Request",[{no:1,name:"cid",kind:"scalar",T:12},{no:2,name:"bucketId",kind:"scalar",T:4,L:0},{no:3,name:"range",kind:"message",T:()=>Et},{no:4,name:"authenticate",kind:"scalar",T:8}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.cid=new Uint8Array(0),t.bucketId=0n,t.authenticate=!1,void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();switch(t){case 1:s.cid=e.bytes();break;case 2:s.bucketId=e.uint64().toBigInt();break;case 3:s.range=Et.internalBinaryRead(e,e.uint32(),r,s.range);break;case 4:s.authenticate=e.bool();break;default:let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){e.cid.length&&t.tag(1,w.LengthDelimited).bytes(e.cid),0n!==e.bucketId&&t.tag(2,w.Varint).uint64(e.bucketId),e.range&&Et.internalBinaryWrite(e.range,t.tag(3,w.LengthDelimited).fork(),r).join(),!1!==e.authenticate&&t.tag(4,w.Varint).bool(e.authenticate);let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},Et=new class extends y{constructor(){super("file.GetFileRequest.Request.Range",[{no:1,name:"start",kind:"scalar",T:4,L:2},{no:2,name:"end",kind:"scalar",T:4,L:2}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.start=0,t.end=0,void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();switch(t){case 1:s.start=e.uint64().toNumber();break;case 2:s.end=e.uint64().toNumber();break;default:let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){0!==e.start&&t.tag(1,w.Varint).uint64(e.start),0!==e.end&&t.tag(2,w.Varint).uint64(e.end);let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},Tt=new class extends y{constructor(){super("file.GetFileResponse",[{no:1,name:"proof",kind:"message",oneof:"body",T:()=>Ut},{no:2,name:"data",kind:"scalar",oneof:"body",T:12}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.body={oneofKind:void 0},void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();switch(t){case 1:s.body={oneofKind:"proof",proof:Ut.internalBinaryRead(e,e.uint32(),r,s.body.proof)};break;case 2:s.body={oneofKind:"data",data:e.bytes()};break;default:let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){"proof"===e.body.oneofKind&&Ut.internalBinaryWrite(e.body.proof,t.tag(1,w.LengthDelimited).fork(),r).join(),"data"===e.body.oneofKind&&t.tag(2,w.LengthDelimited).bytes(e.body.data);let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},Ut=new class extends y{constructor(){super("file.GetFileResponse.Proof",[{no:1,name:"proof",kind:"scalar",repeat:2,T:12}])}create(e){const t=globalThis.Object.create(this.messagePrototype);return t.proof=[],void 0!==e&&m(this,t,e),t}internalBinaryRead(e,t,r,n){let s=null!=n?n:this.create(),o=e.pos+t;for(;e.pos<o;){let[t,n]=e.tag();if(1===t)s.proof.push(e.bytes());else{let o=r.readUnknownField;if("throw"===o)throw new globalThis.Error(`Unknown field ${t} (wire type ${n}) for ${this.typeName}`);let i=e.skip(n);!1!==o&&(!0===o?b.onRead:o)(this.typeName,s,t,n,i)}}return s}internalBinaryWrite(e,t,r){for(let r=0;r<e.proof.length;r++)t.tag(1,w.LengthDelimited).bytes(e.proof[r]);let n=r.writeUnknownFields;return!1!==n&&(1==n?b.onWrite:n)(this.typeName,e,t),t}},Rt=new e("file.FileApi",[{name:"putRawPiece",clientStreaming:!0,options:{},I:gt,O:mt},{name:"putMultipartPiece",options:{},I:bt,O:wt},{name:"getFile",serverStreaming:!0,clientStreaming:!0,options:{},I:kt,O:Tt}]);class Nt{constructor(e){this._transport=void 0,this.typeName=Rt.typeName,this.methods=Rt.methods,this.options=Rt.options,this._transport=e}putRawPiece(e){const r=this.methods[0],n=this._transport.mergeOptions(e);return t("clientStreaming",this._transport,r,n)}putMultipartPiece(e,r){const n=this.methods[1],s=this._transport.mergeOptions(r);return t("unary",this._transport,n,s,e)}getFile(e){const r=this.methods[2],n=this._transport.mergeOptions(e);return t("duplex",this._transport,r,n)}}const It=["token","correlationId"],St=["token","correlationId"],Ct=["token","correlationId"];class Pt{constructor(e,t={}){var r,n;this.logger=void 0,this.api=void 0,this.options=void 0,this.api=new Nt(e),this.logger=fe("FileApi",t),this.options=A({},t,{enableAcks:null!=(r=t.enableAcks)?r:!!t.signer,authenticate:null!=(n=t.authenticate)&&n})}async putMultipartPiece(e){let{token:t,correlationId:r}=e,n=O(e,It);const{signer:s}=this.options,o=Le(r,B(t)),i=Math.pow(2,Math.ceil(Math.log2(n.partSize)));this.logger.debug(A({},n,{partSize:i,token:t,correlationId:r}),"Storing multipart piece"),s&&(o.request=await Ae({bucketId:n.bucketId,size:bt.toBinary(n).byteLength,requestType:Re.STORE},{token:t,signer:s,logger:this.logger}));const{response:a}=await this.api.putMultipartPiece(A({},n,{partSize:i}),{meta:o});return this.logger.debug({response:a,correlationId:r},"Multipart piece stored"),new Uint8Array(a.cid)}async putRawPiece(e,t){let{token:r,correlationId:n}=e,s=O(e,St);const o=Le(n,B(r)),i=it(t,s.size),{signer:a}=this.options;if(this.logger.debug({metadata:s,token:r,correlationId:n},"Storing raw piece of size %d",i),!i)throw new Error("Cannot determine the raw piece size");if(i>j)throw new Error("Raw piece size should not be greather then 128 MB");a&&(o.request=await Ae({size:i,bucketId:s.bucketId,requestType:Re.STORE},{token:r,signer:a,logger:this.logger}));const c=this.api.putRawPiece({meta:o});c.requests.send({body:{oneofKind:"metadata",metadata:A({},s,{size:i})}});const l=await c.headers;this.logger.debug({headers:l,correlationId:n},"Server responded with headers");let d=0;const u=(ct(t)?t:lt(t)).getReader();for(;d<j;){const{done:e,value:t}=await u.read();if(e||!t)break;await Promise.race([c.status,c.requests.send({body:{oneofKind:"content",content:{data:t}}})]),d+=t.byteLength}u.releaseLock(),await c.requests.complete();const{cid:h}=await c.response;return this.logger.debug({cid:h,correlationId:n},"Raw piece stored"),new Uint8Array(h)}async getFile(e){let{token:t,correlationId:r}=e,n=O(e,Ct);const{enableAcks:s,signer:o,authenticate:i=!1}=this.options;this.logger.debug({request:n,token:t,correlationId:r},"Started reading data");const a=Oe(),c=Le(r,B(t)),l=new Je(n.cid,{logger:this.logger,enable:i,range:n.range});var d;o&&(c.request=await Ae({requestId:a,id:n.cid,bucketId:n.bucketId,offset:null==(d=n.range)?void 0:d.start,size:n.range&&n.range.end-n.range.start+1,requestType:Re.GET},{token:t,signer:o,logger:this.logger}));const u=this.api.getFile({meta:c});u.requests.send({body:{oneofKind:"request",request:A({},n,{authenticate:i})}});const h=await u.headers;function p(){return(p=D(function*(){let e=0;try{var r,n=!1,i=!1;try{for(var c,d=S(u.responses);n=!(c=yield P(d.next())).done;n=!1){const{body:r}=c.value;"data"===r.oneofKind&&(yield r.data,e+=r.data.byteLength,s&&u.requests.send({body:{oneofKind:"ack",ack:yield P(Fe({requestId:a,bytesStoredOrDelivered:e,timestamp:Date.now()},{token:t,signer:o,logger:this.logger}))}}).then(()=>{this.logger.info("Acknowledgment sent with request ID: %s (%d bytes)",a,e)}).catch(()=>{this.logger.warn("Failed to send acknowledgment with request ID: %s (%d bytes)",a,e)}),yield P(l.update(r.data))),"proof"===r.oneofKind&&(yield P(l.prove(r.proof)))}}catch(e){i=!0,r=e}finally{try{n&&null!=d.return&&(yield P(d.return()))}finally{if(i)throw r}}yield P(u.requests.complete()),yield P(l.validate())}catch(e){throw this.logger.error(e,"An error occurred while reading file stream"),e}})).apply(this,arguments)}return this.logger.debug({headers:h,correlationId:r},"Server responded with headers"),lt(function(){return p.apply(this,arguments)}.call(this),null)}}class At{constructor(){throw new Error("GrpcTransport in not supported in browser environment")}}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var Ot,Dt,Ft=(Ot=function(e,t){var r,n;e.exports=(r={418:function(e,t){!function(e,t){for(var r in t)e[r]=t[r]}(t,function(e){var t={};function r(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,r),s.l=!0,s.exports}return r.m=e,r.c=t,r.i=function(e){return e},r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=1)}([function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var n=r(3),s=function(){function e(e,t){void 0===e&&(e={}),void 0===t&&(t={splitValues:!1});var r,s=this;this.headersMap={},e&&("undefined"!=typeof Headers&&e instanceof Headers?n.getHeaderKeys(e).forEach(function(r){n.getHeaderValues(e,r).forEach(function(e){s.append(r,t.splitValues?n.splitHeaderValue(e):e)})}):"object"==typeof(r=e)&&"object"==typeof r.headersMap&&"function"==typeof r.forEach?e.forEach(function(e,t){s.append(e,t)}):"undefined"!=typeof Map&&e instanceof Map?e.forEach(function(e,t){s.append(t,e)}):"string"==typeof e?this.appendFromString(e):"object"==typeof e&&Object.getOwnPropertyNames(e).forEach(function(t){var r=e[t];Array.isArray(r)?r.forEach(function(e){s.append(t,e)}):s.append(t,r)}))}return e.prototype.appendFromString=function(e){for(var t=e.split("\r\n"),r=0;r<t.length;r++){var n=t[r],s=n.indexOf(":");if(s>0){var o=n.substring(0,s).trim(),i=n.substring(s+1).trim();this.append(o,i)}}},e.prototype.delete=function(e,t){var r=n.normalizeName(e);if(void 0===t)delete this.headersMap[r];else{var s=this.headersMap[r];if(s){var o=s.indexOf(t);o>=0&&s.splice(o,1),0===s.length&&delete this.headersMap[r]}}},e.prototype.append=function(e,t){var r=this,s=n.normalizeName(e);Array.isArray(this.headersMap[s])||(this.headersMap[s]=[]),Array.isArray(t)?t.forEach(function(e){r.headersMap[s].push(n.normalizeValue(e))}):this.headersMap[s].push(n.normalizeValue(t))},e.prototype.set=function(e,t){var r=n.normalizeName(e);if(Array.isArray(t)){var s=[];t.forEach(function(e){s.push(n.normalizeValue(e))}),this.headersMap[r]=s}else this.headersMap[r]=[n.normalizeValue(t)]},e.prototype.has=function(e,t){var r=this.headersMap[n.normalizeName(e)];if(!Array.isArray(r))return!1;if(void 0!==t){var s=n.normalizeValue(t);return r.indexOf(s)>=0}return!0},e.prototype.get=function(e){var t=this.headersMap[n.normalizeName(e)];return void 0!==t?t.concat():[]},e.prototype.forEach=function(e){var t=this;Object.getOwnPropertyNames(this.headersMap).forEach(function(r){e(r,t.headersMap[r])},this)},e.prototype.toHeaders=function(){if("undefined"!=typeof Headers){var e=new Headers;return this.forEach(function(t,r){r.forEach(function(r){e.append(t,r)})}),e}throw new Error("Headers class is not defined")},e}();t.BrowserHeaders=s},function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var n=r(0);t.BrowserHeaders=n.BrowserHeaders},function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.iterateHeaders=function(e,t){for(var r=e[Symbol.iterator](),n=r.next();!n.done;)t(n.value[0]),n=r.next()},t.iterateHeadersKeys=function(e,t){for(var r=e.keys(),n=r.next();!n.done;)t(n.value),n=r.next()}},function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var n=r(2);t.normalizeName=function(e){if("string"!=typeof e&&(e=String(e)),/[^a-z0-9\-#$%&'*+.\^_`|~]/i.test(e))throw new TypeError("Invalid character in header field name");return e.toLowerCase()},t.normalizeValue=function(e){return"string"!=typeof e&&(e=String(e)),e},t.getHeaderValues=function(e,t){var r=e;if(r instanceof Headers&&r.getAll)return r.getAll(t);var n=r.get(t);return n&&"string"==typeof n?[n]:n},t.getHeaderKeys=function(e){var t=e,r={},s=[];return t.keys?n.iterateHeadersKeys(t,function(e){r[e]||(r[e]=!0,s.push(e))}):t.forEach?t.forEach(function(e,t){r[t]||(r[t]=!0,s.push(t))}):n.iterateHeaders(t,function(e){var t=e[0];r[t]||(r[t]=!0,s.push(t))}),s},t.splitHeaderValue=function(e){var t=[];return e.split(", ").forEach(function(e){e.split(",").forEach(function(e){t.push(e)})}),t}}]))},617:function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.ChunkParser=t.ChunkType=t.encodeASCII=t.decodeASCII=void 0;var n,s=r(65);function o(e){return 9===(t=e)||10===t||13===t||e>=32&&e<=126;var t}function i(e){for(var t=0;t!==e.length;++t)if(!o(e[t]))throw new Error("Metadata is not valid (printable) ASCII");return String.fromCharCode.apply(String,Array.prototype.slice.call(e))}function a(e){return!(128&~e.getUint8(0))}function c(e){return e.getUint32(1,!1)}function l(e,t,r){return e.byteLength-t>=r}function d(e,t,r){if(e.slice)return e.slice(t,r);var n=e.length;void 0!==r&&(n=r);for(var s=new Uint8Array(n-t),o=0,i=t;i<n;i++)s[o++]=e[i];return s}t.decodeASCII=i,t.encodeASCII=function(e){for(var t=new Uint8Array(e.length),r=0;r!==e.length;++r){var n=e.charCodeAt(r);if(!o(n))throw new Error("Metadata contains invalid ASCII");t[r]=n}return t},function(e){e[e.MESSAGE=1]="MESSAGE",e[e.TRAILERS=2]="TRAILERS"}(n=t.ChunkType||(t.ChunkType={}));var u=function(){function e(){this.buffer=null,this.position=0}return e.prototype.parse=function(e,t){if(0===e.length&&t)return[];var r,o=[];if(null==this.buffer)this.buffer=e,this.position=0;else if(this.position===this.buffer.byteLength)this.buffer=e,this.position=0;else{var u=this.buffer.byteLength-this.position,h=new Uint8Array(u+e.byteLength),p=d(this.buffer,this.position);h.set(p,0);var g=new Uint8Array(e);h.set(g,u),this.buffer=h,this.position=0}for(;;){if(!l(this.buffer,this.position,5))return o;var f=d(this.buffer,this.position,this.position+5),y=new DataView(f.buffer,f.byteOffset,f.byteLength),m=c(y);if(!l(this.buffer,this.position,5+m))return o;var b=d(this.buffer,this.position+5,this.position+5+m);if(this.position+=5+m,a(y))return o.push({chunkType:n.TRAILERS,trailers:(r=b,new s.Metadata(i(r)))}),o;o.push({chunkType:n.MESSAGE,data:b})}},e}();t.ChunkParser=u},8:function(e,t){var r;Object.defineProperty(t,"__esModule",{value:!0}),t.httpStatusToCode=t.Code=void 0,function(e){e[e.OK=0]="OK",e[e.Canceled=1]="Canceled",e[e.Unknown=2]="Unknown",e[e.InvalidArgument=3]="InvalidArgument",e[e.DeadlineExceeded=4]="DeadlineExceeded",e[e.NotFound=5]="NotFound",e[e.AlreadyExists=6]="AlreadyExists",e[e.PermissionDenied=7]="PermissionDenied",e[e.ResourceExhausted=8]="ResourceExhausted",e[e.FailedPrecondition=9]="FailedPrecondition",e[e.Aborted=10]="Aborted",e[e.OutOfRange=11]="OutOfRange",e[e.Unimplemented=12]="Unimplemented",e[e.Internal=13]="Internal",e[e.Unavailable=14]="Unavailable",e[e.DataLoss=15]="DataLoss",e[e.Unauthenticated=16]="Unauthenticated"}(r=t.Code||(t.Code={})),t.httpStatusToCode=function(e){switch(e){case 0:return r.Internal;case 200:return r.OK;case 400:return r.InvalidArgument;case 401:return r.Unauthenticated;case 403:return r.PermissionDenied;case 404:return r.NotFound;case 409:return r.Aborted;case 412:return r.FailedPrecondition;case 429:return r.ResourceExhausted;case 499:return r.Canceled;case 500:default:return r.Unknown;case 501:return r.Unimplemented;case 503:return r.Unavailable;case 504:return r.DeadlineExceeded}}},934:function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.client=void 0;var n=r(65),s=r(617),o=r(8),i=r(346),a=r(57),c=r(882);t.client=function(e,t){return new l(e,t)};var l=function(){function e(e,t){this.started=!1,this.sentFirstMessage=!1,this.completed=!1,this.closed=!1,this.finishedSending=!1,this.onHeadersCallbacks=[],this.onMessageCallbacks=[],this.onEndCallbacks=[],this.parser=new s.ChunkParser,this.methodDefinition=e,this.props=t,this.createTransport()}return e.prototype.createTransport=function(){var e={methodDefinition:this.methodDefinition,debug:this.props.debug||!1,url:this.props.host+"/"+this.methodDefinition.service.serviceName+"/"+this.methodDefinition.methodName,onHeaders:this.onTransportHeaders.bind(this),onChunk:this.onTransportChunk.bind(this),onEnd:this.onTransportEnd.bind(this)};this.transport=this.props.transport?this.props.transport(e):a.makeDefaultTransport(e)},e.prototype.onTransportHeaders=function(e,t){if(this.props.debug&&i.debug("onHeaders",e,t),this.closed)this.props.debug&&i.debug("grpc.onHeaders received after request was closed - ignoring");else if(0===t);else{this.responseHeaders=e,this.props.debug&&i.debug("onHeaders.responseHeaders",JSON.stringify(this.responseHeaders,null,2));var r=d(e);this.props.debug&&i.debug("onHeaders.gRPCStatus",r);var n=r&&r>=0?r:o.httpStatusToCode(t);this.props.debug&&i.debug("onHeaders.code",n);var s=e.get("grpc-message")||[];if(this.props.debug&&i.debug("onHeaders.gRPCMessage",s),this.rawOnHeaders(e),n!==o.Code.OK){var a=this.decodeGRPCStatus(s[0]);this.rawOnError(n,a,e)}}},e.prototype.onTransportChunk=function(e){var t=this;if(this.closed)this.props.debug&&i.debug("grpc.onChunk received after request was closed - ignoring");else{var r=[];try{r=this.parser.parse(e)}catch(e){return this.props.debug&&i.debug("onChunk.parsing error",e,e.message),void this.rawOnError(o.Code.Internal,"parsing error: "+e.message)}r.forEach(function(e){if(e.chunkType===s.ChunkType.MESSAGE){var r=t.methodDefinition.responseType.deserializeBinary(e.data);t.rawOnMessage(r)}else e.chunkType===s.ChunkType.TRAILERS&&(t.responseHeaders?(t.responseTrailers=new n.Metadata(e.trailers),t.props.debug&&i.debug("onChunk.trailers",t.responseTrailers)):(t.responseHeaders=new n.Metadata(e.trailers),t.rawOnHeaders(t.responseHeaders)))})}},e.prototype.onTransportEnd=function(){if(this.props.debug&&i.debug("grpc.onEnd"),this.closed)this.props.debug&&i.debug("grpc.onEnd received after request was closed - ignoring");else if(void 0!==this.responseTrailers){var e=d(this.responseTrailers);if(null!==e){var t=this.responseTrailers.get("grpc-message"),r=this.decodeGRPCStatus(t[0]);this.rawOnEnd(e,r,this.responseTrailers)}else this.rawOnError(o.Code.Internal,"Response closed without grpc-status (Trailers provided)")}else{if(void 0===this.responseHeaders)return void this.rawOnError(o.Code.Unknown,"Response closed without headers");var n=d(this.responseHeaders),s=this.responseHeaders.get("grpc-message");if(this.props.debug&&i.debug("grpc.headers only response ",n,s),null===n)return void this.rawOnEnd(o.Code.Unknown,"Response closed without grpc-status (Headers only)",this.responseHeaders);var a=this.decodeGRPCStatus(s[0]);this.rawOnEnd(n,a,this.responseHeaders)}},e.prototype.decodeGRPCStatus=function(e){if(!e)return"";try{return decodeURIComponent(e)}catch(t){return e}},e.prototype.rawOnEnd=function(e,t,r){var n=this;this.props.debug&&i.debug("rawOnEnd",e,t,r),this.completed||(this.completed=!0,this.onEndCallbacks.forEach(function(s){if(!n.closed)try{s(e,t,r)}catch(e){setTimeout(function(){throw e},0)}}))},e.prototype.rawOnHeaders=function(e){this.props.debug&&i.debug("rawOnHeaders",e),this.completed||this.onHeadersCallbacks.forEach(function(t){try{t(e)}catch(e){setTimeout(function(){throw e},0)}})},e.prototype.rawOnError=function(e,t,r){var s=this;void 0===r&&(r=new n.Metadata),this.props.debug&&i.debug("rawOnError",e,t),this.completed||(this.completed=!0,this.onEndCallbacks.forEach(function(n){if(!s.closed)try{n(e,t,r)}catch(e){setTimeout(function(){throw e},0)}}))},e.prototype.rawOnMessage=function(e){var t=this;this.props.debug&&i.debug("rawOnMessage",e.toObject()),this.completed||this.closed||this.onMessageCallbacks.forEach(function(r){if(!t.closed)try{r(e)}catch(e){setTimeout(function(){throw e},0)}})},e.prototype.onHeaders=function(e){this.onHeadersCallbacks.push(e)},e.prototype.onMessage=function(e){this.onMessageCallbacks.push(e)},e.prototype.onEnd=function(e){this.onEndCallbacks.push(e)},e.prototype.start=function(e){if(this.started)throw new Error("Client already started - cannot .start()");this.started=!0;var t=new n.Metadata(e||{});t.set("content-type","application/grpc-web+proto"),t.set("x-grpc-web","1"),this.transport.start(t)},e.prototype.send=function(e){if(!this.started)throw new Error("Client not started - .start() must be called before .send()");if(this.closed)throw new Error("Client already closed - cannot .send()");if(this.finishedSending)throw new Error("Client already finished sending - cannot .send()");if(!this.methodDefinition.requestStream&&this.sentFirstMessage)throw new Error("Message already sent for non-client-streaming method - cannot .send()");this.sentFirstMessage=!0;var t=c.frameRequest(e);this.transport.sendMessage(t)},e.prototype.finishSend=function(){if(!this.started)throw new Error("Client not started - .finishSend() must be called before .close()");if(this.closed)throw new Error("Client already closed - cannot .send()");if(this.finishedSending)throw new Error("Client already finished sending - cannot .finishSend()");this.finishedSending=!0,this.transport.finishSend()},e.prototype.close=function(){if(!this.started)throw new Error("Client not started - .start() must be called before .close()");if(this.closed)throw new Error("Client already closed - cannot .close()");this.closed=!0,this.props.debug&&i.debug("request.abort aborting request"),this.transport.cancel()},e}();function d(e){var t=e.get("grpc-status")||[];if(t.length>0)try{return parseInt(t[0],10)}catch(e){return null}return null}},346:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.debug=void 0,t.debug=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];console.debug?console.debug.apply(null,e):console.log.apply(null,e)}},607:function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.grpc=void 0;var n,s=r(418),o=r(57),i=r(229),a=r(540),c=r(210),l=r(859),d=r(8),u=r(938),h=r(35),p=r(934);(n=t.grpc||(t.grpc={})).setDefaultTransport=o.setDefaultTransportFactory,n.CrossBrowserHttpTransport=l.CrossBrowserHttpTransport,n.FetchReadableStreamTransport=i.FetchReadableStreamTransport,n.XhrTransport=c.XhrTransport,n.WebsocketTransport=a.WebsocketTransport,n.Code=d.Code,n.Metadata=s.BrowserHeaders,n.client=function(e,t){return p.client(e,t)},n.invoke=u.invoke,n.unary=h.unary},938:function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.invoke=void 0;var n=r(934);t.invoke=function(e,t){if(e.requestStream)throw new Error(".invoke cannot be used with client-streaming methods. Use .client instead.");var r=n.client(e,{host:t.host,transport:t.transport,debug:t.debug});return t.onHeaders&&r.onHeaders(t.onHeaders),t.onMessage&&r.onMessage(t.onMessage),t.onEnd&&r.onEnd(t.onEnd),r.start(t.metadata),r.send(t.request),r.finishSend(),{close:function(){r.close()}}}},65:function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.Metadata=void 0;var n=r(418);Object.defineProperty(t,"Metadata",{enumerable:!0,get:function(){return n.BrowserHeaders}})},57:function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.makeDefaultTransport=t.setDefaultTransportFactory=void 0;var n=r(859),s=function(e){return n.CrossBrowserHttpTransport({withCredentials:!1})(e)};t.setDefaultTransportFactory=function(e){s=e},t.makeDefaultTransport=function(e){return s(e)}},229:function(e,t,r){var n=this&&this.__assign||function(){return(n=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var s in t=arguments[r])Object.prototype.hasOwnProperty.call(t,s)&&(e[s]=t[s]);return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.detectFetchSupport=t.FetchReadableStreamTransport=void 0;var s=r(65),o=r(346);t.FetchReadableStreamTransport=function(e){return function(t){return function(e,t){return e.debug&&o.debug("fetchRequest",e),new i(e,t)}(t,e)}};var i=function(){function e(e,t){this.cancelled=!1,this.controller=self.AbortController&&new AbortController,this.options=e,this.init=t}return e.prototype.pump=function(e,t){var r=this;if(this.reader=e,this.cancelled)return this.options.debug&&o.debug("Fetch.pump.cancel at first pump"),void this.reader.cancel().catch(function(e){r.options.debug&&o.debug("Fetch.pump.reader.cancel exception",e)});this.reader.read().then(function(e){if(e.done)return r.options.onEnd(),t;r.options.onChunk(e.value),r.pump(r.reader,t)}).catch(function(e){r.cancelled?r.options.debug&&o.debug("Fetch.catch - request cancelled"):(r.cancelled=!0,r.options.debug&&o.debug("Fetch.catch",e.message),r.options.onEnd(e))})},e.prototype.send=function(e){var t=this;fetch(this.options.url,n(n({},this.init),{headers:this.metadata.toHeaders(),method:"POST",body:e,signal:this.controller&&this.controller.signal})).then(function(e){if(t.options.debug&&o.debug("Fetch.response",e),t.options.onHeaders(new s.Metadata(e.headers),e.status),!e.body)return e;t.pump(e.body.getReader(),e)}).catch(function(e){t.cancelled?t.options.debug&&o.debug("Fetch.catch - request cancelled"):(t.cancelled=!0,t.options.debug&&o.debug("Fetch.catch",e.message),t.options.onEnd(e))})},e.prototype.sendMessage=function(e){this.send(e)},e.prototype.finishSend=function(){},e.prototype.start=function(e){this.metadata=e},e.prototype.cancel=function(){var e=this;this.cancelled?this.options.debug&&o.debug("Fetch.cancel already cancelled"):(this.cancelled=!0,this.controller?(this.options.debug&&o.debug("Fetch.cancel.controller.abort"),this.controller.abort()):this.options.debug&&o.debug("Fetch.cancel.missing abort controller"),this.reader?(this.options.debug&&o.debug("Fetch.cancel.reader.cancel"),this.reader.cancel().catch(function(t){e.options.debug&&o.debug("Fetch.cancel.reader.cancel exception",t)})):this.options.debug&&o.debug("Fetch.cancel before reader"))},e}();t.detectFetchSupport=function(){return"undefined"!=typeof Response&&Response.prototype.hasOwnProperty("body")&&"function"==typeof Headers}},859:function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.CrossBrowserHttpTransport=void 0;var n=r(229),s=r(210);t.CrossBrowserHttpTransport=function(e){return n.detectFetchSupport()?n.FetchReadableStreamTransport({credentials:e.withCredentials?"include":"same-origin"}):s.XhrTransport({withCredentials:e.withCredentials})}},210:function(e,t,r){var n,s=this&&this.__extends||(n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.stringToArrayBuffer=t.MozChunkedArrayBufferXHR=t.XHR=t.XhrTransport=void 0;var o=r(65),i=r(346),a=r(849);t.XhrTransport=function(e){return function(t){if(a.detectMozXHRSupport())return new l(t,e);if(a.detectXHROverrideMimeTypeSupport())return new c(t,e);throw new Error("This environment's XHR implementation cannot support binary transfer.")}};var c=function(){function e(e,t){this.options=e,this.init=t}return e.prototype.onProgressEvent=function(){this.options.debug&&i.debug("XHR.onProgressEvent.length: ",this.xhr.response.length);var e=this.xhr.response.substr(this.index);this.index=this.xhr.response.length;var t=u(e);this.options.onChunk(t)},e.prototype.onLoadEvent=function(){this.options.debug&&i.debug("XHR.onLoadEvent"),this.options.onEnd()},e.prototype.onStateChange=function(){this.options.debug&&i.debug("XHR.onStateChange",this.xhr.readyState),this.xhr.readyState===XMLHttpRequest.HEADERS_RECEIVED&&this.options.onHeaders(new o.Metadata(this.xhr.getAllResponseHeaders()),this.xhr.status)},e.prototype.sendMessage=function(e){this.xhr.send(e)},e.prototype.finishSend=function(){},e.prototype.start=function(e){var t=this;this.metadata=e;var r=new XMLHttpRequest;this.xhr=r,r.open("POST",this.options.url),this.configureXhr(),this.metadata.forEach(function(e,t){r.setRequestHeader(e,t.join(", "))}),r.withCredentials=Boolean(this.init.withCredentials),r.addEventListener("readystatechange",this.onStateChange.bind(this)),r.addEventListener("progress",this.onProgressEvent.bind(this)),r.addEventListener("loadend",this.onLoadEvent.bind(this)),r.addEventListener("error",function(e){t.options.debug&&i.debug("XHR.error",e),t.options.onEnd(e.error)})},e.prototype.configureXhr=function(){this.xhr.responseType="text",this.xhr.overrideMimeType("text/plain; charset=x-user-defined")},e.prototype.cancel=function(){this.options.debug&&i.debug("XHR.abort"),this.xhr.abort()},e}();t.XHR=c;var l=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return s(t,e),t.prototype.configureXhr=function(){this.options.debug&&i.debug("MozXHR.configureXhr: setting responseType to 'moz-chunked-arraybuffer'"),this.xhr.responseType="moz-chunked-arraybuffer"},t.prototype.onProgressEvent=function(){var e=this.xhr.response;this.options.debug&&i.debug("MozXHR.onProgressEvent: ",new Uint8Array(e)),this.options.onChunk(new Uint8Array(e))},t}(c);function d(e,t){var r=e.charCodeAt(t);if(r>=55296&&r<=56319){var n=e.charCodeAt(t+1);n>=56320&&n<=57343&&(r=65536+(r-55296<<10)+(n-56320))}return r}function u(e){for(var t=new Uint8Array(e.length),r=0,n=0;n<e.length;n++){var s=String.prototype.codePointAt?e.codePointAt(n):d(e,n);t[r++]=255&s}return t}t.MozChunkedArrayBufferXHR=l,t.stringToArrayBuffer=u},849:function(e,t){var r;function n(e){var t=function(){if(void 0!==r)return r;if(XMLHttpRequest){r=new XMLHttpRequest;try{r.open("GET","https://localhost")}catch(e){}}return r}();if(!t)return!1;try{return t.responseType=e,t.responseType===e}catch(e){}return!1}Object.defineProperty(t,"__esModule",{value:!0}),t.detectXHROverrideMimeTypeSupport=t.detectMozXHRSupport=t.xhrSupportsResponseType=void 0,t.xhrSupportsResponseType=n,t.detectMozXHRSupport=function(){return"undefined"!=typeof XMLHttpRequest&&n("moz-chunked-arraybuffer")},t.detectXHROverrideMimeTypeSupport=function(){return"undefined"!=typeof XMLHttpRequest&&XMLHttpRequest.prototype.hasOwnProperty("overrideMimeType")}},540:function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.WebsocketTransport=void 0;var n,s=r(346),o=r(617);!function(e){e[e.FINISH_SEND=1]="FINISH_SEND"}(n||(n={}));var i=new Uint8Array([1]);t.WebsocketTransport=function(){return function(e){return function(e){e.debug&&s.debug("websocketRequest",e);var t,r=function(e){if("https://"===e.substr(0,8))return"wss://"+e.substr(8);if("http://"===e.substr(0,7))return"ws://"+e.substr(7);throw new Error("Websocket transport constructed with non-https:// or http:// host.")}(e.url),a=[];function c(e){if(e===n.FINISH_SEND)t.send(i);else{var r=e,s=new Int8Array(r.byteLength+1);s.set(new Uint8Array([0])),s.set(r,1),t.send(s)}}return{sendMessage:function(e){t&&t.readyState!==t.CONNECTING?c(e):a.push(e)},finishSend:function(){t&&t.readyState!==t.CONNECTING?c(n.FINISH_SEND):a.push(n.FINISH_SEND)},start:function(n){(t=new WebSocket(r,["grpc-websockets"])).binaryType="arraybuffer",t.onopen=function(){var r;e.debug&&s.debug("websocketRequest.onopen"),t.send((r="",n.forEach(function(e,t){r+=e+": "+t.join(", ")+"\r\n"}),o.encodeASCII(r))),a.forEach(function(e){c(e)})},t.onclose=function(t){e.debug&&s.debug("websocketRequest.onclose",t),e.onEnd()},t.onerror=function(t){e.debug&&s.debug("websocketRequest.onerror",t)},t.onmessage=function(t){e.onChunk(new Uint8Array(t.data))}},cancel:function(){e.debug&&s.debug("websocket.abort"),t.close()}}}(e)}}},35:function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.unary=void 0;var n=r(65),s=r(934);t.unary=function(e,t){if(e.responseStream)throw new Error(".unary cannot be used with server-streaming methods. Use .invoke or .client instead.");if(e.requestStream)throw new Error(".unary cannot be used with client-streaming methods. Use .client instead.");var r=null,o=null,i=s.client(e,{host:t.host,transport:t.transport,debug:t.debug});return i.onHeaders(function(e){r=e}),i.onMessage(function(e){o=e}),i.onEnd(function(e,s,i){t.onEnd({status:e,statusMessage:s,headers:r||new n.Metadata,message:o,trailers:i})}),i.start(t.metadata),i.send(t.request),i.finishSend(),{close:function(){i.close()}}}},882:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.frameRequest=void 0,t.frameRequest=function(e){var t=e.serializeBinary(),r=new ArrayBuffer(t.byteLength+5);return new DataView(r,1,4).setUint32(0,t.length,!1),new Uint8Array(r,5).set(t),new Uint8Array(r)}}},n={},function e(t){if(n[t])return n[t].exports;var s=n[t]={exports:{}};return r[t].call(s.exports,s,s.exports,e),s.exports}(607))},Ot(Dt={exports:{}}),Dt.exports);const Bt=["timeout"];class Lt extends AbortController{constructor(e){super(),this.timeout=void 0,this.timeoutHandle=void 0,this.stop=()=>{this.timeoutHandle&&clearTimeout(this.timeoutHandle)},this.start=()=>(this.stop(),this.timeoutHandle=setTimeout(()=>this.abort(new r("Request timed out",L[L.CANCELLED])),this.timeout),this),this.timeout=e,this.timeout=e}}const xt=(e,t)=>{if(!t)return e;const r=new AbortController,n=()=>{r.signal.aborted||r.abort()};return e.addEventListener("abort",n),t.addEventListener("abort",n),r.signal};class Mt{constructor(e){this.timeout=void 0,this.timeout=e}start(e){const t=new Lt(this.timeout);return[t.start(),xt(t.signal,e.abort)]}interceptDuplex(e,t,r){const[n,s]=this.start(r),o=e(t,A({},r,{abort:s}));return o.headers.then(n.stop,n.stop),o}interceptServerStreaming(e,t,r,n){const[s,o]=this.start(n),i=e(t,r,A({},n,{abort:o}));return i.headers.then(s.stop,s.stop),i}interceptClientStreaming(e,t,r){const[n,s]=this.start(r),o=e(t,A({},r,{abort:s}));return o.headers.then(n.stop,n.stop),o}interceptUnary(e,t,r,n){let{timeout:s}=n;return e(t,r,A({},O(n,Bt),{timeout:null!=s?s:this.timeout}))}}const _t=["timeout","interceptors"],jt=e=>{const[t]=e.get("grpc-status")||[],[r]=e.get("grpc-message")||[];return t?{code:L[Number(t)],detail:r||""}:null};class Ht{constructor(e){let{timeout:t,interceptors:r=[]}=e,n=O(e,_t);this.defaultOptions={},this.host=void 0,this.host=(({httpUrl:e,ssl:t})=>{const r=/^https?:\/\//i.test(e)?e:`http://${e}`,n=new URL(r);return t&&(n.protocol="https:"),n.href.replace(/\/+$/,"")})(n),this.defaultOptions={interceptors:t?[new Mt(t),...r]:r}}clientStreaming(e,t){var o;const i=qt(e.I),a=new n,c=new n,l=new n,d=new n,u=Ft.grpc.client({methodName:e.name,requestStream:!0,responseStream:!1,requestType:i,responseType:qt(e.O),service:{serviceName:e.service.typeName}},{host:this.host,transport:Ft.grpc.WebsocketTransport()}),h=e=>{a.rejectPending(e),c.rejectPending(e),l.rejectPending(e),d.rejectPending(e)};return t.abort&&t.abort.addEventListener("abort",()=>{h(t.abort.reason||new r("Canceled by client",L[L.CANCELLED])),u.close()}),u.onHeaders(e=>{const t=jt(e);if(t&&t.code!==L[L.OK])return a.rejectPending(new r(t.detail,t.code));a.resolvePending(e.headersMap)}),u.onMessage(e=>{c.resolvePending(e.toObject())}),u.onEnd((e,t,n)=>{if(e!==Ft.grpc.Code.OK)return h(new r(t,L[e]));l.resolvePending({code:L[e],detail:t}),d.resolvePending(n.headersMap)}),u.start(new Ft.grpc.Metadata(t.meta)),new s(e,null!=(o=t.meta)?o:{},{send:async function(e){return u.send(new i(e))},complete:async function(){return u.finishSend()}},a.promise,c.promise,l.promise,d.promise)}duplex(e,t){var s;const a=qt(e.I),c=new n,d=new o,u=new n,h=new n,p=Ft.grpc.client({methodName:e.name,requestStream:!0,responseStream:!0,requestType:a,responseType:qt(e.O),service:{serviceName:e.service.typeName}},{host:this.host,transport:Ft.grpc.WebsocketTransport()}),g=e=>{c.rejectPending(e),u.rejectPending(e),h.rejectPending(e),d.closed||d.notifyError(e)};return t.abort&&t.abort.addEventListener("abort",()=>{g(t.abort.reason||new r("Canceled by client",L[L.CANCELLED])),p.close()}),p.onHeaders(e=>{const t=jt(e);if(t&&t.code!==L[L.OK])return c.rejectPending(new r(t.detail,t.code));c.resolvePending(e.headersMap)}),p.onMessage(e=>{d.notifyMessage(e.toObject())}),p.onEnd((e,t,n)=>{if(e!==Ft.grpc.Code.OK)return g(new r(t,L[e]));u.resolvePending({code:L[e],detail:t}),h.resolvePending(n.headersMap),d.closed||d.notifyComplete()}),p.start(new Ft.grpc.Metadata(t.meta)),new i(e,null!=(s=t.meta)?s:{},{send:async function(e){p.send(new a(e))},complete:async function(){u.state===l.PENDING&&p.finishSend()}},c.promise,d,u.promise,h.promise)}mergeOptions(e){return a(this.defaultOptions,e)}serverStreaming(){throw new Error("Not implemented")}unary(e,t,s){var o;const i=qt(e.I),a=new n,l=new n,d=new n,u=new n;return new Promise((n,o)=>{const a=Ft.grpc.unary({methodName:e.name,requestStream:!1,responseStream:!1,requestType:i,responseType:qt(e.O),service:{serviceName:e.service.typeName}},{host:this.host,transport:Ft.grpc.WebsocketTransport(),metadata:new Ft.grpc.Metadata(s.meta),request:new i(t),onEnd:n});s.abort&&s.abort.addEventListener("abort",()=>{var e;o((null==(e=s.abort)?void 0:e.reason)||new r("Canceled by client",L[L.CANCELLED])),a.close()})}).then(e=>{if(a.resolvePending(e.headers.headersMap),u.resolvePending(e.headers.headersMap),d.resolvePending({code:L[e.status],detail:e.statusMessage}),e.status!==Ft.grpc.Code.OK)throw new r(e.statusMessage,L[e.status]);e.message&&l.resolvePending(e.message.toObject())}).catch(t=>{t.methodName=e.name,t.serviceName=e.service.typeName,a.rejectPending(t),l.rejectPending(t),d.rejectPending(t),u.rejectPending(t)}),new c(e,null!=(o=s.meta)?o:{},t,a.promise,l.promise,d.promise,u.promise)}}const qt=e=>{var t;class r{constructor(t=e.create()){this.payload=void 0,this.payload=t}serializeBinary(){return e.toBinary(this.payload)}toObject(){return this.payload}}return t=r,r.deserializeBinary=r=>{const n=e.fromBinary(r);return new t(n)},r};class $t extends Ht{}class Wt{constructor(e,t={}){this.contentLength=void 0,this.content=void 0,this.offset=void 0,this.body=void 0,this.meta=void 0,this.offset=t.multipartOffset,this.body=ct(e)?e:lt(e),this.contentLength=it(e,t.size),this.meta=t,this.content=e}get isPart(){return void 0!==this.offset}get size(){if(!this.contentLength)throw new Error("The piece size can not be determined");return this.contentLength}static isPiece(e){return e instanceof Wt||"object"==typeof e&&"object"==typeof(null==e?void 0:e.meta)&&"boolean"==typeof e.isPart&&!!e.body}static isStaticPiece(e){return Wt.isPiece(e)&&e.content instanceof Uint8Array}static from(e){if(ct(e.content)&&e.content.locked)throw new Error("The content stream is locked and can not be reused");return new Wt(e.content,e.meta)}}class zt{constructor(e,t){this.partHashes=void 0,this.meta=void 0,this.parts=void 0,this.partHashes=e.map(e=>new se(e).contentHash),this.meta=t,this.parts=e}static isMultipartPiece(e){const t=e;return e instanceof zt||"object"==typeof t&&"object"==typeof(null==t?void 0:t.meta)&&"number"==typeof t.meta.partSize&&"number"==typeof t.meta.totalSize&&Array.isArray(t.parts)&&Array.isArray(t.partHashes)}}class Gt{constructor(e,t,r){this.cidObject=void 0,this.meta=void 0,this.body=void 0,this.cidObject=e instanceof se?e:new se(e),this.body=t,this.meta=r}get range(){var e;return null==(e=this.meta)?void 0:e.range}get hash(){return this.cidObject.contentHash}get cid(){return this.cidObject.toString()}async arrayBuffer(){return ut(this.body)}async text(){return ht(this.body)}async json(){return dt(this.body)}}class Vt{constructor(e,t,r=""){this.cid=void 0,this.size=void 0,this.name="",this.cid=e,this.size=t,this.name=r}}class Kt{constructor(e,t){this.key=void 0,this.value=void 0,this.key=e,this.value=t}}class Xt{constructor(e,t=[],r=[]){this.dataBuffer=void 0,this.links=void 0,this.tags=void 0,this.dataBuffer=T.from(e||[]),this.links=t,this.tags=r}get size(){return $e.toBinary(Yt(this)).byteLength}get data(){return this.dataBuffer}set data(e){this.dataBuffer=T.from(e)}static isDagNode(e){const t=e;return e instanceof Xt||"object"==typeof t&&(null==t?void 0:t.data)instanceof Uint8Array&&Array.isArray(t.links)&&Array.isArray(t.tags)}}class Jt extends Xt{constructor(e,t,r=[],n=[]){const s=r.map(e=>A({},e,{cid:new se(e.cid).toString()}));super(new Uint8Array(t),s,n),this.cidObject=void 0,this.cidObject=new se(e)}get cid(){return this.cidObject.toString()}}const Yt=e=>A({},e,{data:e.data,links:e.links.map(e=>A({},e,{cid:new se(e.cid).toBytes()}))});class Qt{constructor(e,t){this.cid=void 0,this.name=void 0,this.cid=e,this.name=t}static isCnsRecord(e){return e instanceof Qt||"object"==typeof e&&"string"==typeof(null==e?void 0:e.cid)&&"string"==typeof e.name}}class Zt extends Qt{constructor(e,t,r){super(new se(e).toString(),t),this.signature=void 0,this.signature=r}}const er=({name:e,cid:t})=>({name:e,cid:new se(t).toBytes()});class tr{constructor(e,t){var r;this.signer=void 0,this.config=void 0,this.nodeId=void 0,this.displayName=void 0,this.dagApi=void 0,this.fileApi=void 0,this.cnsApi=void 0,this.logger=void 0,this.rootTokenPromise=void 0,this.mode=void 0,this.signer=e,this.config=t;const n=ie.maybeToken(t.authToken),s=new $t(A({},t,{timeout:null!=(r=t.timeout)?r:3e4}));this.nodeId=t.nodeId||E(),this.mode=t.mode,this.logger=fe("StorageNode",t),this.rootTokenPromise=n&&Promise.resolve(n),this.displayName=t.httpUrl;const o={signer:e,logger:this.logger,authenticate:t.authenticate,enableAcks:t.enableAcks};this.cnsApi=new Me(s,o),this.dagApi=new Ze(s,o),this.fileApi=new Pt(s,o),this.logger.debug(t,"Storage node initialized"),!1!==t.logErrors&&me(this,this.logger,["storePiece","storeDagNode","readPiece","getDagNode","storeCnsRecord","getCnsRecord","resolveName"])}async getRootToken(){return this.rootTokenPromise||(this.rootTokenPromise=de(this.signer)),this.rootTokenPromise}async createAuthToken({accessToken:e}={}){const t=ie.maybeToken(e);if(null!=t&&t.isSigned)return t;const r=t||await this.getRootToken(),n=r.subject&&le(this.signer,r.subject);return ie.from(r).sign(n||this.signer)}async storePiece(e,t,r){let n;const s=await this.createAuthToken(r),o=(null==r?void 0:r.correlationId)||xe();if(zt.isMultipartPiece(t)&&(this.logger.info("Storing multipart piece into bucket %s",e),n=await this.fileApi.putMultipartPiece({bucketId:e,token:s,correlationId:o,partHashes:t.partHashes,partSize:t.meta.partSize,totalSize:t.meta.totalSize})),Wt.isPiece(t)&&(this.logger.info("Storing raw piece into bucket %s",e),n=await this.fileApi.putRawPiece({bucketId:e,token:s,correlationId:o,isMultipart:t.isPart,offset:t.offset,size:t.size},t.body)),!n)throw new Error("`piece` argument is neither Piece nor MultipartPiece");const i=new se(n).toString();return null!=r&&r.name&&await this.storeCnsRecord(e,new Qt(i,r.name),r),this.logger.info("Stored piece into bucket %s with CID %s",e,i),i}async storeDagNode(e,t,r){const n=await this.createAuthToken(r),s=(null==r?void 0:r.correlationId)||xe();this.logger.info("Storing DAG node into bucket %s",e);const o=await this.dagApi.putNode({bucketId:e,token:n,correlationId:s,node:Yt(t)}),i=new se(o).toString();return null!=r&&r.name&&await this.storeCnsRecord(e,new Qt(i,r.name),r),this.logger.info("Stored DAG Node into bucket %s with CID %s",e,i),i}async readPiece(e,t,r){const n=await this.createAuthToken(r),s=(null==r?void 0:r.correlationId)||xe();this.logger.info('Reading piece by CID or name "%s" from bucket %s',t,e);const o=await this.resolveName(e,t,r),i=await this.fileApi.getFile({bucketId:e,token:n,correlationId:s,cid:o.toBytes(),range:null==r?void 0:r.range}),a=new Gt(o,i,{range:null==r?void 0:r.range});return this.logger.info('Read piece by CID or name "%s" from bucket %s',t,e),a}async getDagNode(e,t,r){const n=await this.createAuthToken(r),s=(null==r?void 0:r.correlationId)||xe();this.logger.info('Getting DAG Node by CID or name "%s" from bucket %s',t,e);const o=await this.resolveName(e,t,r),i=await this.dagApi.getNode({bucketId:e,token:n,correlationId:s,cid:o.toBytes(),path:null==r?void 0:r.path}),a=i&&new Jt(o,new Uint8Array(i.data),i.links,i.tags);return this.logger.info('Got DAG Node by CID or name "%s" from bucket %s',t,e),a}async storeCnsRecord(e,t,r){const n=await this.createAuthToken(r),s=(null==r?void 0:r.correlationId)||xe();this.logger.info("Storing CNS record into bucket %s",e);const o=await this.cnsApi.putRecord({bucketId:e,token:n,correlationId:s,record:er(t)});return this.logger.info("Stored CNS record into bucket %s",e),o}async getCnsRecord(e,t,r){const n=await this.createAuthToken(r),{cacheControl:s,correlationId:o=xe()}=r||{};this.logger.info(`Getting CNS record by name "${t}" from bucket ${e}`);const i=await this.cnsApi.getRecord({bucketId:e,name:t,token:n,correlationId:o,cacheControl:s});return this.logger.info('Got CNS record by name "%s" from bucket %s',t,e),i&&new Zt(i.cid,i.name,i.signature)}async resolveName(e,t,r){if(se.isCid(t))return new se(t);this.logger.info('Resolving CNS name "%s" from bucket %s',t,e);const n=await this.getCnsRecord(e,t,r);if(!n)throw new Error(`Cannot resolve CNS name: "${t}"`);return this.logger.info('Resolved CNS name "%s" from bucket %s to "%s"',t,e,n.cid),new se(n.cid)}}var rr;!function(e){e.READ_DAG_NODE="read-dag-node",e.STORE_DAG_NODE="store-dag-node",e.READ_PIECE="read-piece",e.STORE_PIECE="store-piece",e.STORE_CNS_RECORD="store-cns-record",e.READ_CNS_RECORD="read-cns-record"}(rr||(rr={}));class nr{constructor(e){this.logger=void 0,this.logger=e}}class sr extends nr{async marshalNodes(e,t){return"https:"!==(null==(r=globalThis.location)?void 0:r.protocol)?t:t.filter(e=>e.ssl);var r}}const or={[rr.READ_DAG_NODE]:{[f.Full]:1,[f.Cache]:1,[f.Storage]:2},[rr.STORE_DAG_NODE]:{[f.Full]:1,[f.Storage]:2,[f.Cache]:void 0},[rr.READ_PIECE]:{[f.Full]:1,[f.Cache]:1,[f.Storage]:2},[rr.STORE_PIECE]:{[f.Full]:1,[f.Storage]:2,[f.Cache]:void 0},[rr.READ_CNS_RECORD]:{[f.Full]:1,[f.Cache]:1,[f.Storage]:2},[rr.STORE_CNS_RECORD]:{[f.Full]:1,[f.Storage]:2,[f.Cache]:void 0}};class ir extends sr{async marshalNodes(e,t){const r=await super.marshalNodes(e,t),n=or[e];return r.filter(({mode:e})=>void 0!==n[e]).sort((e,t)=>{var r,s,o,i;return(null!=(r=null!=(s=e.priority)?s:n[e.mode])?r:0)-(null!=(o=null!=(i=t.priority)?i:n[t.mode])?o:0)})}selectNode(e,t){return t[0]}}class ar extends ir{constructor(...e){super(...e),this.nodesMap=new Map}getPingedNodes(e){return Array.from(this.nodesMap.values()).filter(({isDone:t})=>e?t.state===e:t.state!==l.REJECTED).map(({node:e})=>e)}async ping(e){const t=Date.now(),r=new URL("/info",e.node.httpUrl);try{const e=await N(r,{cache:"no-cache",signal:AbortSignal.timeout(1e3)});if(!e.ok)throw new Error(`HTTP ${e.status} ${e.statusText}`)}catch(t){throw this.logger.debug({err:t},"Node ping %s failed with error %s",e.node.httpUrl,t),t}return e.latency=Date.now()-t,this.logger.info("Node ping completed %s with latency %d ms",e.node.httpUrl,e.latency),e}enqueuePing(e){const t=this.nodesMap.get(e.httpUrl);if(t)return t;const r=new n,s={node:e,isDone:r};return this.nodesMap.set(e.httpUrl,s),this.ping(s).then(()=>r.resolve(!0)).catch(e=>r.reject(e)),r.promise}async marshalNodes(e,t){const r=(e=>{for(let t=e.length-1;t>0;t--){const r=Math.floor(Math.random()*(t+1));[e[t],e[r]]=[e[r],e[t]]}return e})([...t]),n=await super.marshalNodes(e,this.getPingedNodes()),s=await super.marshalNodes(e,r),o=s.filter(e=>!this.nodesMap.has(e.httpUrl)),i=o.slice(0,Math.max(0,10-n.length)),a=o.slice(0,2),c=[...n,...i].map(e=>this.enqueuePing(e));return await Promise.allSettled(c),setTimeout(()=>a.forEach(e=>this.enqueuePing(e)),100),s.sort((e,t)=>{var r,n;const s=null==(r=this.nodesMap.get(e.httpUrl))?void 0:r.latency,o=null==(n=this.nodesMap.get(t.httpUrl))?void 0:n.latency;return(s?Math.ceil(s/100):Infinity)-(o?Math.ceil(o/100):Infinity)})}}class cr extends ar{constructor(e,{blockchain:t}){super(e),this.blockchain=void 0,this.bucketCache=new Map,this.clusterNodes=new Map,this.mapNodeProps=e=>{const{grpcPort:t,host:r,httpPort:n,ssl:s,domain:o}=e.props,i=o||r;return{ssl:s,httpUrl:s?`https://${i}`:`http://${i}:${n}`,grpcUrl:`grpc://${r}:${t}`,mode:e.props.mode}},this.blockchain=t}async isReady(){return await this.blockchain.isReady(),!0}async getNodes(e){const{clusterId:t}=await this.getBucket(e),r=await this.getClusterNodes(t);if(this.logger.debug({nodes:r},"Using nodes from blockchain"),!r.length)throw new Error(`No nodes found in the cluster: ${t}`);return r}async getClusterNodes(e){if(this.clusterNodes.has(e))return this.clusterNodes.get(e);const t=(await this.blockchain.ddcNodes.listStorageNodes()).filter(t=>t.clusterId===e).map(this.mapNodeProps);return this.clusterNodes.set(e,t),t}async getBucket(e){if(this.bucketCache.has(e))return this.bucketCache.get(e);const t=await this.blockchain.ddcCustomers.getBucket(e);if(!t)throw new Error(`Failed to get bucket ${e} on blockchain`);return this.logger.debug({bucket:t},"Got bucket from blockchain"),this.bucketCache.set(e,t),t}}class lr extends ar{constructor(e,{nodes:t}){super(e),this.nodes=void 0,this.nodes=t}async getNodes(e){return this.nodes}async isReady(){return!0}}const dr=["signer"];class ur{constructor(e){let{signer:t}=e,r=O(e,dr);this.strategy=void 0,this.signer=void 0,this.logger=void 0,this.sdkTokenPromise=void 0,this.logger=fe("Router",r),this.signer=t,"nodes"in r?(this.strategy=new lr(this.logger,r),this.logger.debug({strategy:"static"},"Router created")):(this.strategy=new cr(this.logger,r),this.logger.debug({strategy:"blockchain"},"Router created"))}getSdkToken(){return this.sdkTokenPromise=Promise.all([this.sdkTokenPromise,this.signer.isReady()]).then(([e])=>e&&((e,t)=>{var r;return this.signer.address===(null==(r=t.signature)?void 0:r.signer)})(0,e)?e:de(this.signer)),this.sdkTokenPromise}async getNode(e,t,r={},n=[]){this.logger.info('Getting node for operation "%s" in bucket %s',e,t);const s=this.getSdkToken();await this.strategy.isReady();const o=(await this.strategy.getNodes(t)).filter(e=>!n.includes((e=>e.nodeId||e.grpcUrl)(e))),i=await this.strategy.marshalNodes(e,o),a=this.strategy.selectNode(e,i);if(!a)throw new Error("No nodes available to handle the operation");const c=new tr(this.signer,A({},a,{logger:this.logger,authToken:await s,nodeId:a.nodeId||a.grpcUrl},r));return this.logger.info('Selected node for operation "%s" in bucket %s: %s',e,t,c.displayName),this.logger.debug({bucketId:t,node:a},"Selected node"),c}}class hr extends r{constructor(...e){super(...e),this.correlationId=void 0,this.nodeId=void 0}static fromRpcError(e){const t=new hr(e.message,e.code,e.meta);return t.methodName=e.methodName,t.serviceName=e.serviceName,t}}const pr=["router"],gr=["attempts"],fr=e=>A({},e,{correlationId:e.correlationId||xe()});class yr{constructor(e){let{router:t}=e,r=O(e,pr);if(this.nodeId="BalancedNode",this.displayName="BalancedNode",this.router=void 0,this.logger=void 0,this.retryOptions={minTimeout:50,factor:2,retries:q},this.router=t,this.logger=fe("BalancedNode",r),"number"==typeof r.retries)this.retryOptions.retries=r.retries;else if(r.retries){const e=r.retries,{attempts:t=q}=e,n=O(e,gr);this.retryOptions=A({},this.retryOptions,n,{retries:t})}!1!==r.logErrors&&me(this,this.logger,["storePiece","storeDagNode","readPiece","getDagNode","storeCnsRecord","getCnsRecord","resolveName"])}async withRetry(e,t,{correlationId:n},s){var o=this;let i,a;const c=[];return R(async function(l,d){let u;try{u=await o.router.getNode(t,e,{logErrors:!1},c.map(e=>e.nodeId)),c.unshift(u)}catch(r){u=c.pop()||u,u&&o.logger.info('Reusing previous node for operation "%s" in bucket %s: %s',t,e,u.displayName),r instanceof Error&&(a=r)}var h;if(!u)throw null!=(h=null!=i?i:a)?h:new Error("No nodes available to handle the operation");try{return await s(u,l,d)}catch(e){const t=e instanceof r?hr.fromRpcError(e):void 0;if(t&&(t.nodeId=u.nodeId,t.correlationId=n,H.map(e=>L[e]).includes(t.code)))throw i=t,t;l(t||e)}},A({},this.retryOptions,{onRetry:(e,t)=>{var r,n;null==(r=(n=this.retryOptions).onRetry)||r.call(n,e,t),this.logger.warn({err:e,attempt:t},"Retrying operation")}}))}async storePiece(e,t,r={}){const n=fr(r);return this.withRetry(e,rr.STORE_PIECE,n,(r,s,o)=>r.storePiece(e,Wt.isPiece(t)&&o>0?Wt.from(t):t,n))}async readPiece(e,t,r={}){const n=fr(r);return this.withRetry(e,rr.READ_PIECE,n,r=>r.readPiece(e,t,n))}async storeDagNode(e,t,r={}){const n=fr(r);return this.withRetry(e,rr.STORE_DAG_NODE,n,r=>r.storeDagNode(e,t,n))}async getDagNode(e,t,r={}){const n=fr(r);return this.withRetry(e,rr.READ_DAG_NODE,n,r=>r.getDagNode(e,t,n))}async storeCnsRecord(e,t,r={}){const n=fr(r);return this.withRetry(e,rr.STORE_CNS_RECORD,n,r=>r.storeCnsRecord(e,t,n))}async getCnsRecord(e,t,r={}){const n=fr(r);return this.withRetry(e,rr.READ_CNS_RECORD,n,r=>r.getCnsRecord(e,t,n))}async resolveName(e,t,r={}){const n=fr(r);return this.withRetry(e,rr.READ_CNS_RECORD,n,r=>r.resolveName(e,t,n))}}const mr={blockchain:"wss://rpc.mainnet.cere.network/ws"},br={blockchain:"wss://rpc.testnet.cere.network/ws"},wr={blockchain:"wss://archive.devnet.cere.network/ws"},kr=br,vr={blockchain:"wss://archive.devnet.cere.network/ws",nodes:[{mode:f.Full,grpcUrl:"grpc://38.242.236.247:9090",httpUrl:"https://storage-1.devnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://38.242.236.247:9091",httpUrl:"https://storage-2.devnet.cere.network"},{mode:f.Full,grpcUrl:"grpc://158.220.87.61:9090",httpUrl:"https://storage-3.devnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://158.220.87.61:9091",httpUrl:"https://storage-4.devnet.cere.network"},{mode:f.Full,grpcUrl:"grpc://89.117.79.111:9090",httpUrl:"https://storage-5.devnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://89.117.79.111:9091",httpUrl:"https://storage-6.devnet.cere.network"},{mode:f.Full,grpcUrl:"grpc://154.53.57.124:9090",httpUrl:"https://storage-7.devnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://154.53.57.124:9091",httpUrl:"https://storage-8.devnet.cere.network"}]},Er={blockchain:"wss://rpc.testnet.cere.network/ws",nodes:[{mode:f.Full,grpcUrl:"grpc://128.140.103.37:9090",httpUrl:"https://storage-1.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://162.55.218.0:9090",httpUrl:"https://storage-2.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://94.130.27.127:9090",httpUrl:"https://storage-3.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://157.90.226.137:9090",httpUrl:"https://storage-4.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://116.203.211.74:9090",httpUrl:"https://storage-5.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://116.203.188.159:9090",httpUrl:"https://storage-6.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://66.135.3.185:9090",httpUrl:"https://storage-7.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://207.246.92.234:9090",httpUrl:"https://storage-8.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://116.203.153.145:9090",httpUrl:"https://storage-9.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://94.130.183.14:9090",httpUrl:"https://storage-10.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://78.47.189.200:9090",httpUrl:"https://storage-11.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://116.203.83.55:9090",httpUrl:"https://storage-12.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://95.217.155.6:9090",httpUrl:"https://storage-13.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://65.108.154.151:9090",httpUrl:"https://storage-14.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://37.27.18.247:9090",httpUrl:"https://storage-15.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://65.109.138.28:9090",httpUrl:"https://storage-16.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://162.212.158.22:9090",httpUrl:"https://storage-17.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://162.212.154.25:9090",httpUrl:"https://storage-18.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://162.212.154.242:9090",httpUrl:"https://storage-19.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://162.212.154.168:9090",httpUrl:"https://storage-20.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://162.212.157.36:9090",httpUrl:"https://storage-21.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://162.212.157.4:9090",httpUrl:"https://storage-22.testnet.cere.network",ssl:!1},{mode:f.Full,grpcUrl:"grpc://162.212.154.45:9090",httpUrl:"https://storage-23.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://162.212.157.254:9090",httpUrl:"https://storage-24.testnet.cere.network",ssl:!0},{mode:f.Storage,grpcUrl:"grpc://38.242.148.54:9090",httpUrl:"https://storage-25.testnet.cere.network",ssl:!0},{mode:f.Storage,grpcUrl:"grpc://38.242.148.67:9090",httpUrl:"https://storage-26.testnet.cere.network",ssl:!0},{mode:f.Storage,grpcUrl:"grpc://38.242.148.78:9090",httpUrl:"https://storage-27.testnet.cere.network",ssl:!0},{mode:f.Storage,grpcUrl:"grpc://154.12.245.135:9090",httpUrl:"https://storage-28.testnet.cere.network",ssl:!1},{mode:f.Storage,grpcUrl:"grpc://154.12.245.139:9090",httpUrl:"https://storage-29.testnet.cere.network",ssl:!0},{mode:f.Storage,grpcUrl:"grpc://154.12.245.141:9090",httpUrl:"https://storage-30.testnet.cere.network",ssl:!1},{mode:f.Storage,grpcUrl:"grpc://31.220.96.197:9090",httpUrl:"https://storage-31.testnet.cere.network",ssl:!0},{mode:f.Storage,grpcUrl:"grpc://31.220.96.198:9090",httpUrl:"https://storage-32.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://37.27.26.9:9090",httpUrl:"https://storage-33.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://37.27.15.104:9090",httpUrl:"https://storage-34.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://65.108.244.154:9090",httpUrl:"https://storage-35.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://65.21.111.73:9090",httpUrl:"https://storage-36.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://135.181.80.135:9090",httpUrl:"https://storage-37.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://65.109.174.181:9090",httpUrl:"https://storage-38.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://65.109.227.87:9090",httpUrl:"https://storage-39.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://65.108.211.60:9090",httpUrl:"https://storage-40.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://78.47.122.10:9090",httpUrl:"https://storage-41.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://128.140.97.160:9090",httpUrl:"https://storage-42.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://49.13.23.245:9090",httpUrl:"https://storage-43.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://167.235.231.47:9090",httpUrl:"https://storage-44.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://65.21.54.218:9090",httpUrl:"https://storage-45.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://37.27.15.137:9090",httpUrl:"https://storage-46.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://95.216.139.48:9090",httpUrl:"https://storage-47.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://95.217.167.158:9090",httpUrl:"https://storage-48.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://149.248.2.7:9090",httpUrl:"https://storage-49.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://140.82.50.92:9090",httpUrl:"https://storage-50.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://149.28.111.44:9090",httpUrl:"https://storage-51.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://66.135.30.145:9090",httpUrl:"https://storage-52.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://45.63.65.67:9090",httpUrl:"https://storage-53.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://137.220.57.81:9090",httpUrl:"https://storage-54.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://207.148.2.17:9090",httpUrl:"https://storage-55.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://149.28.242.196:9090",httpUrl:"https://storage-56.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://64.176.183.175:9090",httpUrl:"https://storage-57.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://45.76.131.46:9090",httpUrl:"https://storage-58.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://108.61.198.218:9090",httpUrl:"https://storage-59.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://80.240.22.212:9090",httpUrl:"https://storage-60.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://107.191.63.179:9090",httpUrl:"https://storage-61.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://65.20.100.39:9090",httpUrl:"https://storage-62.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://65.20.112.89:9090",httpUrl:"https://storage-63.testnet.cere.network",ssl:!0},{mode:f.Full,grpcUrl:"grpc://64.176.67.225:9090",httpUrl:"https://storage-64.testnet.cere.network",ssl:!0}]};export{Se as ActivityAcknowledgment,Ie as ActivityRequest,ie as AuthToken,V as AuthTokenOperation,yr as BalancedNode,se as Cid,Me as CnsApi,Qt as CnsRecord,Zt as CnsRecordResponse,kr as DEFAULT_PRESET,wr as DEVNET,vr as DEVNET_STATIC,Ze as DagApi,Xt as DagNode,Jt as DagNodeResponse,Pt as FileApi,At as GrpcTransport,x as KB,Vt as Link,mr as MAINNET,j as MAX_PIECE_SIZE,M as MB,_ as MIN_PIECE_SIZE,zt as MultipartPiece,hr as NodeError,Wt as Piece,Gt as PieceResponse,ur as Router,rr as RouterOperation,tr as StorageNode,br as TESTNET,Er as TESTNET_STATIC,Kt as Tag,Ht as WebsocketTransport,me as bindErrorLogger,lt as createContentStream,xe as createCorrelationId,fe as createLogger,ct as isContentStream,pt as streamConsumers,st as withChunkSize};
//# sourceMappingURL=browser.js.map
