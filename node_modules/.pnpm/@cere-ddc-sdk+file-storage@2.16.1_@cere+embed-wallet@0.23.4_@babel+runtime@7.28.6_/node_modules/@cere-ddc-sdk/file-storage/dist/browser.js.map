{"version":3,"file":"browser.js","sources":["../src/File.ts","../src/constants.web.ts","../src/FileStorage.ts"],"sourcesContent":["import { Content, ContentStream, PieceResponse, createContentStream, isContentStream } from '@cere-ddc-sdk/ddc';\n\nexport type FileContent = Content;\n\ntype StreamMeta = {\n  size: number;\n};\n\ntype StaticContentMeta = {\n  size?: number;\n};\n\n/**\n * Represents a file with content and metadata.\n *\n * @group Files\n */\nexport class File {\n  /**\n   * The content of the file as a stream.\n   */\n  readonly body: ContentStream;\n\n  /**\n   * The size of the file in bytes.\n   */\n  readonly size: number;\n\n  /**\n   * The metadata for the file.\n   */\n  readonly meta: StreamMeta | StaticContentMeta;\n\n  constructor(content: FileContent, meta: StreamMeta);\n  constructor(content: Uint8Array, meta?: StaticContentMeta);\n  constructor(content: FileContent, meta: StreamMeta | StaticContentMeta = {}) {\n    this.body = isContentStream(content) ? content : createContentStream(content);\n    this.size = content instanceof Uint8Array ? content.byteLength : meta.size!;\n    this.meta = meta;\n  }\n\n  /**\n   * Checks if a given object is an instance of the `File` class.\n   *\n   * @param object - The object to check.\n   *\n   * @returns True if the object is a `File` instance, false otherwise.\n   */\n  static isFile(object: unknown): object is File {\n    const maybeFile = object as File | null;\n\n    if (object instanceof File) {\n      return true;\n    }\n\n    return typeof maybeFile === 'object' && typeof maybeFile?.size === 'number' && !!maybeFile.body;\n  }\n}\n\n/**\n * Represents a response from a file read operation.\n *\n * @group Files\n * @extends PieceResponse\n */\nexport class FileResponse extends PieceResponse {}\n","import { MB, MAX_PIECE_SIZE, MIN_PIECE_SIZE } from '@cere-ddc-sdk/ddc';\n\nexport { MAX_PIECE_SIZE as MAX_BUFFER_SIZE, MIN_PIECE_SIZE as MIN_BUFFER_SIZE };\n\nexport const DEFAULT_BUFFER_SIZE = 16 * MB;\n","import { Blockchain, BucketId } from '@cere-ddc-sdk/blockchain';\nimport {\n  PieceReadOptions,\n  Piece,\n  MultipartPiece,\n  Router,\n  PieceStoreOptions,\n  Signer,\n  UriSigner,\n  RouterConfig,\n  ConfigPreset,\n  DEFAULT_PRESET,\n  Logger,\n  createLogger,\n  LoggerOptions,\n  bindErrorLogger,\n  NodeInterface,\n  BalancedNode,\n  withChunkSize,\n  streamConsumers,\n  BalancedNodeConfig,\n} from '@cere-ddc-sdk/ddc';\n\nimport { File, FileResponse } from './File';\nimport { DEFAULT_BUFFER_SIZE, MAX_BUFFER_SIZE, MIN_BUFFER_SIZE } from './constants';\n\ntype Config = LoggerOptions & Pick<BalancedNodeConfig, 'retries'>;\n\nexport type FileStorageConfig = Config &\n  Omit<ConfigPreset, 'blockchain'> & {\n    blockchain: Blockchain | ConfigPreset['blockchain'];\n  };\n\nexport type FileReadOptions = PieceReadOptions;\nexport type FileStoreOptions = PieceStoreOptions & {\n  maxBufferSize?: number;\n};\n\ntype LargeFileStoreOptions = FileStoreOptions & {\n  partSize: number;\n};\n\n/**\n * Represents a storage system for files.\n *\n * It provides methods to read and store files in the DDC.\n *\n * @group Files\n */\nexport class FileStorage {\n  private ddcNode: NodeInterface;\n  private logger: Logger;\n  private blockchain?: Blockchain;\n\n  constructor(config: RouterConfig & Config);\n  constructor(router: Router, config: Config);\n  constructor(configOrRouter: (RouterConfig & Config) | Router, config?: Config) {\n    let finalConfig: Config | undefined;\n\n    if (configOrRouter instanceof Router) {\n      finalConfig = config;\n\n      this.logger = createLogger('FileStorage', config);\n      this.ddcNode = new BalancedNode({ ...config, router: configOrRouter, logger: this.logger });\n\n      this.logger.debug(config, 'FileStorage created');\n    } else {\n      finalConfig = configOrRouter;\n\n      this.logger = createLogger('FileStorage', configOrRouter);\n      this.blockchain = 'blockchain' in configOrRouter ? configOrRouter.blockchain : undefined;\n      this.ddcNode = new BalancedNode({\n        logger: this.logger,\n        retries: configOrRouter.retries,\n        router: new Router({ ...configOrRouter, logger: this.logger }),\n      });\n\n      this.logger.debug(configOrRouter, 'FileStorage created');\n    }\n\n    if (finalConfig?.logErrors === false) {\n      bindErrorLogger(this, this.logger, ['store', 'read']);\n    }\n  }\n\n  /**\n   * Creates a new instance of the `FileStorage` class asynchronously.\n   *\n   * @param uriOrSigner - A Signer instance or a [substrate URI](https://polkadot.js.org/docs/keyring/start/suri).\n   * @param config - Configuration options for the `FileStorage`. Defaults to TESTNET.\n   *\n   * @returns A promise that resolves to a new `FileStorage` instance.\n   *\n   * * @example\n   *\n   * ```typescript\n   * import { FileStorage, TESTNET } from '@cere-ddc-sdk/file-storage';\n   *\n   * const fileStorage = await FileStorage.create('//Alice', TESTNET);\n   * ```\n   */\n  static async create(uriOrSigner: Signer | string, config: FileStorageConfig = DEFAULT_PRESET) {\n    const signer = typeof uriOrSigner === 'string' ? new UriSigner(uriOrSigner) : uriOrSigner;\n    const blockchain =\n      typeof config.blockchain === 'string'\n        ? await Blockchain.connect({ wsEndpoint: config.blockchain })\n        : config.blockchain;\n\n    return new FileStorage({ ...config, blockchain, signer });\n  }\n\n  async disconnect() {\n    await this.blockchain?.disconnect();\n  }\n\n  private async storeLarge(bucketId: BucketId, file: File, { partSize, ...options }: LargeFileStoreOptions) {\n    const parts: string[] = [];\n    const partsStream = file.body.pipeThrough<Uint8Array>(withChunkSize(partSize));\n\n    let offset = 0;\n    for await (const part of partsStream) {\n      const piece = new Piece(part, { multipartOffset: offset });\n      const cid = await this.ddcNode.storePiece(bucketId, piece, {\n        accessToken: options?.accessToken,\n      });\n\n      offset += part.byteLength;\n      parts.push(cid);\n    }\n\n    return this.ddcNode.storePiece(bucketId, new MultipartPiece(parts, { totalSize: file.size, partSize }), options);\n  }\n\n  private async storeSmall(bucketId: BucketId, file: File, options?: FileStoreOptions) {\n    const content = new Uint8Array(await streamConsumers.arrayBuffer(file.body));\n\n    return this.ddcNode.storePiece(bucketId, new Piece(content), options);\n  }\n\n  /**\n   * Stores a file in the DDC. Large files are stored as a collection of pieces.\n   *\n   * @param bucketId - The ID of the bucket where the file will be stored.\n   * @param file - The file to store.\n   * @param options - The options for storing the file.\n   *\n   * @returns A promise that resolves to the CID of the stored file.\n   *\n   * @example\n   *\n   * ```typescript\n   * const bucketId = 1n;\n   * const fileContent = ...;\n   * const file: File = new File(fileContent, { size: 1000 });\n   * const fileCid = await fileStorage.store(bucketId, file);\n   *\n   * console.log(fileCid);\n   * ```\n   */\n  async store(bucketId: BucketId, file: File, options: FileStoreOptions = {}) {\n    this.logger.info('Storing file into bucket %s', bucketId);\n    this.logger.debug({ bucketId, file, options }, 'Store file');\n\n    const partSize = options?.maxBufferSize || DEFAULT_BUFFER_SIZE;\n\n    if (partSize > MAX_BUFFER_SIZE || partSize < MIN_BUFFER_SIZE) {\n      throw new Error(`Max buffer size must be between ${MIN_BUFFER_SIZE} and ${MAX_BUFFER_SIZE} bytes`);\n    }\n\n    const cid =\n      file.size > partSize\n        ? await this.storeLarge(bucketId, file, { ...options, partSize })\n        : await this.storeSmall(bucketId, file, options);\n\n    this.logger.info('File stored with CID %s', cid);\n\n    return cid;\n  }\n\n  /**\n   * Reads a file from the file storage.\n   *\n   * @param bucketId - The ID of the bucket where the file is stored.\n   * @param cidOrName - The CID or CNS name of the file to read.\n   * @param options - The options for reading the file.\n   *\n   * @returns A promise that resolves to a `FileResponse` instance.\n   *\n   * @example\n   *\n   * ```typescript\n   * const bucketId = 1n;\n   * const fileCid = 'CID';\n   * const file = await fileStorage.read(bucketId, fileCid);\n   * const content = await file.text();\n   *\n   * console.log(content);\n   * ```\n   */\n  async read(bucketId: BucketId, cidOrName: string, options?: FileReadOptions) {\n    this.logger.info('Reading file from bucket %s by \"%s\"', bucketId, cidOrName);\n    const piece = await this.ddcNode.readPiece(bucketId, cidOrName, options);\n    this.logger.info('File response created with CID %s', piece.cid);\n\n    return new FileResponse(piece.cid, piece.body, options);\n  }\n}\n"],"names":["File","constructor","content","meta","this","body","size","isContentStream","createContentStream","Uint8Array","byteLength","isFile","object","maybeFile","FileResponse","PieceResponse","DEFAULT_BUFFER_SIZE","MB","FileStorage","configOrRouter","config","_finalConfig","finalConfig","ddcNode","logger","blockchain","Router","createLogger","BalancedNode","_extends","router","debug","undefined","retries","logErrors","bindErrorLogger","create","uriOrSigner","DEFAULT_PRESET","signer","UriSigner","Blockchain","connect","wsEndpoint","disconnect","_this$blockchain","storeLarge","bucketId","file","_ref","partSize","options","_objectWithoutPropertiesLoose","_excluded","parts","partsStream","pipeThrough","withChunkSize","offset","_iteratorError","_iteratorAbruptCompletion","_didIteratorError","_step","_iterator","_asyncIterator","next","done","part","value","piece","Piece","multipartOffset","cid","storePiece","accessToken","push","err","return","MultipartPiece","totalSize","storeSmall","streamConsumers","arrayBuffer","store","info","maxBufferSize","MAX_BUFFER_SIZE","MIN_BUFFER_SIZE","Error","read","cidOrName","readPiece"],"mappings":"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"}