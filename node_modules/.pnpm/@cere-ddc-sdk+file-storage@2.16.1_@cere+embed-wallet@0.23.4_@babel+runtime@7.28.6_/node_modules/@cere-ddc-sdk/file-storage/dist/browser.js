import{isContentStream as e,createContentStream as t,PieceResponse as r,MB as i,Router as n,createLogger as o,BalancedNode as s,bindErrorLogger as a,UriSigner as c,DEFAULT_PRESET as l,withChunkSize as d,Piece as u,MultipartPiece as h,streamConsumers as g,MAX_PIECE_SIZE as f,MIN_PIECE_SIZE as y}from"@cere-ddc-sdk/ddc";export{CereWalletSigner,DEVNET,JsonSigner,KeyringSigner,MAINNET,MAX_PIECE_SIZE as MAX_BUFFER_SIZE,MIN_PIECE_SIZE as MIN_BUFFER_SIZE,TESTNET,UriSigner,createCorrelationId}from"@cere-ddc-sdk/ddc";import{Blockchain as b}from"@cere-ddc-sdk/blockchain";class p{constructor(r,i={}){this.body=void 0,this.size=void 0,this.meta=void 0,this.body=e(r)?r:t(r),this.size=r instanceof Uint8Array?r.byteLength:i.size,this.meta=i}static isFile(e){return e instanceof p||"object"==typeof e&&"number"==typeof(null==e?void 0:e.size)&&!!e.body}}class w extends r{}function v(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then(function(e){return{value:e,done:t}})}return v=function(e){this.s=e,this.n=e.next},v.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var r=this.s.return;return void 0===r?Promise.resolve({value:e,done:!0}):t(r.apply(this.s,arguments))},throw:function(e){var r=this.s.return;return void 0===r?Promise.reject(e):t(r.apply(this.s,arguments))}},new v(e)}function S(){return S=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var i in r)({}).hasOwnProperty.call(r,i)&&(e[i]=r[i])}return e},S.apply(null,arguments)}const m=16*i,E=["partSize"];class k{constructor(e,t){var r;let i;this.ddcNode=void 0,this.logger=void 0,this.blockchain=void 0,e instanceof n?(i=t,this.logger=o("FileStorage",t),this.ddcNode=new s(S({},t,{router:e,logger:this.logger})),this.logger.debug(t,"FileStorage created")):(i=e,this.logger=o("FileStorage",e),this.blockchain="blockchain"in e?e.blockchain:void 0,this.ddcNode=new s({logger:this.logger,retries:e.retries,router:new n(S({},e,{logger:this.logger}))}),this.logger.debug(e,"FileStorage created")),!1===(null==(r=i)?void 0:r.logErrors)&&a(this,this.logger,["store","read"])}static async create(e,t=l){const r="string"==typeof e?new c(e):e,i="string"==typeof t.blockchain?await b.connect({wsEndpoint:t.blockchain}):t.blockchain;return new k(S({},t,{blockchain:i,signer:r}))}async disconnect(){var e;await(null==(e=this.blockchain)?void 0:e.disconnect())}async storeLarge(e,t,r){let{partSize:i}=r,n=function(e,t){if(null==e)return{};var r={};for(var i in e)if({}.hasOwnProperty.call(e,i)){if(-1!==t.indexOf(i))continue;r[i]=e[i]}return r}(r,E);const o=[],s=t.body.pipeThrough(d(i));let a=0;var c,l=!1,g=!1;try{for(var f,y=function(e){var t,r,i,n=2;for("undefined"!=typeof Symbol&&(r=Symbol.asyncIterator,i=Symbol.iterator);n--;){if(r&&null!=(t=e[r]))return t.call(e);if(i&&null!=(t=e[i]))return new v(t.call(e));r="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}(s);l=!(f=await y.next()).done;l=!1){const t=f.value;{const r=new u(t,{multipartOffset:a}),i=await this.ddcNode.storePiece(e,r,{accessToken:null==n?void 0:n.accessToken});a+=t.byteLength,o.push(i)}}}catch(e){g=!0,c=e}finally{try{l&&null!=y.return&&await y.return()}finally{if(g)throw c}}return this.ddcNode.storePiece(e,new h(o,{totalSize:t.size,partSize:i}),n)}async storeSmall(e,t,r){const i=new Uint8Array(await g.arrayBuffer(t.body));return this.ddcNode.storePiece(e,new u(i),r)}async store(e,t,r={}){this.logger.info("Storing file into bucket %s",e),this.logger.debug({bucketId:e,file:t,options:r},"Store file");const i=(null==r?void 0:r.maxBufferSize)||m;if(i>f||i<y)throw new Error(`Max buffer size must be between ${y} and ${f} bytes`);const n=t.size>i?await this.storeLarge(e,t,S({},r,{partSize:i})):await this.storeSmall(e,t,r);return this.logger.info("File stored with CID %s",n),n}async read(e,t,r){this.logger.info('Reading file from bucket %s by "%s"',e,t);const i=await this.ddcNode.readPiece(e,t,r);return this.logger.info("File response created with CID %s",i.cid),new w(i.cid,i.body,r)}}export{m as DEFAULT_BUFFER_SIZE,p as File,w as FileResponse,k as FileStorage};
//# sourceMappingURL=browser.js.map
