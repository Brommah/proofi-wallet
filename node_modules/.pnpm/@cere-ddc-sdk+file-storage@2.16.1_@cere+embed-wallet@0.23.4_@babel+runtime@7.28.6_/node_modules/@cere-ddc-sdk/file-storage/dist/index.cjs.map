{"version":3,"file":"index.cjs","sources":["../src/File.ts","../src/constants.ts","../src/FileStorage.ts"],"sourcesContent":["import { Content, ContentStream, PieceResponse, createContentStream, isContentStream } from '@cere-ddc-sdk/ddc';\n\nexport type FileContent = Content;\n\ntype StreamMeta = {\n  size: number;\n};\n\ntype StaticContentMeta = {\n  size?: number;\n};\n\n/**\n * Represents a file with content and metadata.\n *\n * @group Files\n */\nexport class File {\n  /**\n   * The content of the file as a stream.\n   */\n  readonly body: ContentStream;\n\n  /**\n   * The size of the file in bytes.\n   */\n  readonly size: number;\n\n  /**\n   * The metadata for the file.\n   */\n  readonly meta: StreamMeta | StaticContentMeta;\n\n  constructor(content: FileContent, meta: StreamMeta);\n  constructor(content: Uint8Array, meta?: StaticContentMeta);\n  constructor(content: FileContent, meta: StreamMeta | StaticContentMeta = {}) {\n    this.body = isContentStream(content) ? content : createContentStream(content);\n    this.size = content instanceof Uint8Array ? content.byteLength : meta.size!;\n    this.meta = meta;\n  }\n\n  /**\n   * Checks if a given object is an instance of the `File` class.\n   *\n   * @param object - The object to check.\n   *\n   * @returns True if the object is a `File` instance, false otherwise.\n   */\n  static isFile(object: unknown): object is File {\n    const maybeFile = object as File | null;\n\n    if (object instanceof File) {\n      return true;\n    }\n\n    return typeof maybeFile === 'object' && typeof maybeFile?.size === 'number' && !!maybeFile.body;\n  }\n}\n\n/**\n * Represents a response from a file read operation.\n *\n * @group Files\n * @extends PieceResponse\n */\nexport class FileResponse extends PieceResponse {}\n","import { MAX_PIECE_SIZE, MIN_PIECE_SIZE } from '@cere-ddc-sdk/ddc';\n\nexport { MAX_PIECE_SIZE as MAX_BUFFER_SIZE, MIN_PIECE_SIZE as MIN_BUFFER_SIZE };\n\nexport const DEFAULT_BUFFER_SIZE = MAX_PIECE_SIZE;\n","import { Blockchain, BucketId } from '@cere-ddc-sdk/blockchain';\nimport {\n  PieceReadOptions,\n  Piece,\n  MultipartPiece,\n  Router,\n  PieceStoreOptions,\n  Signer,\n  UriSigner,\n  RouterConfig,\n  ConfigPreset,\n  DEFAULT_PRESET,\n  Logger,\n  createLogger,\n  LoggerOptions,\n  bindErrorLogger,\n  NodeInterface,\n  BalancedNode,\n  withChunkSize,\n  streamConsumers,\n  BalancedNodeConfig,\n} from '@cere-ddc-sdk/ddc';\n\nimport { File, FileResponse } from './File';\nimport { DEFAULT_BUFFER_SIZE, MAX_BUFFER_SIZE, MIN_BUFFER_SIZE } from './constants';\n\ntype Config = LoggerOptions & Pick<BalancedNodeConfig, 'retries'>;\n\nexport type FileStorageConfig = Config &\n  Omit<ConfigPreset, 'blockchain'> & {\n    blockchain: Blockchain | ConfigPreset['blockchain'];\n  };\n\nexport type FileReadOptions = PieceReadOptions;\nexport type FileStoreOptions = PieceStoreOptions & {\n  maxBufferSize?: number;\n};\n\ntype LargeFileStoreOptions = FileStoreOptions & {\n  partSize: number;\n};\n\n/**\n * Represents a storage system for files.\n *\n * It provides methods to read and store files in the DDC.\n *\n * @group Files\n */\nexport class FileStorage {\n  private ddcNode: NodeInterface;\n  private logger: Logger;\n  private blockchain?: Blockchain;\n\n  constructor(config: RouterConfig & Config);\n  constructor(router: Router, config: Config);\n  constructor(configOrRouter: (RouterConfig & Config) | Router, config?: Config) {\n    let finalConfig: Config | undefined;\n\n    if (configOrRouter instanceof Router) {\n      finalConfig = config;\n\n      this.logger = createLogger('FileStorage', config);\n      this.ddcNode = new BalancedNode({ ...config, router: configOrRouter, logger: this.logger });\n\n      this.logger.debug(config, 'FileStorage created');\n    } else {\n      finalConfig = configOrRouter;\n\n      this.logger = createLogger('FileStorage', configOrRouter);\n      this.blockchain = 'blockchain' in configOrRouter ? configOrRouter.blockchain : undefined;\n      this.ddcNode = new BalancedNode({\n        logger: this.logger,\n        retries: configOrRouter.retries,\n        router: new Router({ ...configOrRouter, logger: this.logger }),\n      });\n\n      this.logger.debug(configOrRouter, 'FileStorage created');\n    }\n\n    if (finalConfig?.logErrors === false) {\n      bindErrorLogger(this, this.logger, ['store', 'read']);\n    }\n  }\n\n  /**\n   * Creates a new instance of the `FileStorage` class asynchronously.\n   *\n   * @param uriOrSigner - A Signer instance or a [substrate URI](https://polkadot.js.org/docs/keyring/start/suri).\n   * @param config - Configuration options for the `FileStorage`. Defaults to TESTNET.\n   *\n   * @returns A promise that resolves to a new `FileStorage` instance.\n   *\n   * * @example\n   *\n   * ```typescript\n   * import { FileStorage, TESTNET } from '@cere-ddc-sdk/file-storage';\n   *\n   * const fileStorage = await FileStorage.create('//Alice', TESTNET);\n   * ```\n   */\n  static async create(uriOrSigner: Signer | string, config: FileStorageConfig = DEFAULT_PRESET) {\n    const signer = typeof uriOrSigner === 'string' ? new UriSigner(uriOrSigner) : uriOrSigner;\n    const blockchain =\n      typeof config.blockchain === 'string'\n        ? await Blockchain.connect({ wsEndpoint: config.blockchain })\n        : config.blockchain;\n\n    return new FileStorage({ ...config, blockchain, signer });\n  }\n\n  async disconnect() {\n    await this.blockchain?.disconnect();\n  }\n\n  private async storeLarge(bucketId: BucketId, file: File, { partSize, ...options }: LargeFileStoreOptions) {\n    const parts: string[] = [];\n    const partsStream = file.body.pipeThrough<Uint8Array>(withChunkSize(partSize));\n\n    let offset = 0;\n    for await (const part of partsStream) {\n      const piece = new Piece(part, { multipartOffset: offset });\n      const cid = await this.ddcNode.storePiece(bucketId, piece, {\n        accessToken: options?.accessToken,\n      });\n\n      offset += part.byteLength;\n      parts.push(cid);\n    }\n\n    return this.ddcNode.storePiece(bucketId, new MultipartPiece(parts, { totalSize: file.size, partSize }), options);\n  }\n\n  private async storeSmall(bucketId: BucketId, file: File, options?: FileStoreOptions) {\n    const content = new Uint8Array(await streamConsumers.arrayBuffer(file.body));\n\n    return this.ddcNode.storePiece(bucketId, new Piece(content), options);\n  }\n\n  /**\n   * Stores a file in the DDC. Large files are stored as a collection of pieces.\n   *\n   * @param bucketId - The ID of the bucket where the file will be stored.\n   * @param file - The file to store.\n   * @param options - The options for storing the file.\n   *\n   * @returns A promise that resolves to the CID of the stored file.\n   *\n   * @example\n   *\n   * ```typescript\n   * const bucketId = 1n;\n   * const fileContent = ...;\n   * const file: File = new File(fileContent, { size: 1000 });\n   * const fileCid = await fileStorage.store(bucketId, file);\n   *\n   * console.log(fileCid);\n   * ```\n   */\n  async store(bucketId: BucketId, file: File, options: FileStoreOptions = {}) {\n    this.logger.info('Storing file into bucket %s', bucketId);\n    this.logger.debug({ bucketId, file, options }, 'Store file');\n\n    const partSize = options?.maxBufferSize || DEFAULT_BUFFER_SIZE;\n\n    if (partSize > MAX_BUFFER_SIZE || partSize < MIN_BUFFER_SIZE) {\n      throw new Error(`Max buffer size must be between ${MIN_BUFFER_SIZE} and ${MAX_BUFFER_SIZE} bytes`);\n    }\n\n    const cid =\n      file.size > partSize\n        ? await this.storeLarge(bucketId, file, { ...options, partSize })\n        : await this.storeSmall(bucketId, file, options);\n\n    this.logger.info('File stored with CID %s', cid);\n\n    return cid;\n  }\n\n  /**\n   * Reads a file from the file storage.\n   *\n   * @param bucketId - The ID of the bucket where the file is stored.\n   * @param cidOrName - The CID or CNS name of the file to read.\n   * @param options - The options for reading the file.\n   *\n   * @returns A promise that resolves to a `FileResponse` instance.\n   *\n   * @example\n   *\n   * ```typescript\n   * const bucketId = 1n;\n   * const fileCid = 'CID';\n   * const file = await fileStorage.read(bucketId, fileCid);\n   * const content = await file.text();\n   *\n   * console.log(content);\n   * ```\n   */\n  async read(bucketId: BucketId, cidOrName: string, options?: FileReadOptions) {\n    this.logger.info('Reading file from bucket %s by \"%s\"', bucketId, cidOrName);\n    const piece = await this.ddcNode.readPiece(bucketId, cidOrName, options);\n    this.logger.info('File response created with CID %s', piece.cid);\n\n    return new FileResponse(piece.cid, piece.body, options);\n  }\n}\n"],"names":["File","constructor","content","meta","body","size","isContentStream","createContentStream","Uint8Array","byteLength","isFile","object","maybeFile","FileResponse","PieceResponse","DEFAULT_BUFFER_SIZE","MAX_PIECE_SIZE","FileStorage","configOrRouter","config","_finalConfig","ddcNode","logger","blockchain","finalConfig","Router","createLogger","BalancedNode","router","debug","undefined","retries","logErrors","bindErrorLogger","create","uriOrSigner","DEFAULT_PRESET","signer","UriSigner","Blockchain","connect","wsEndpoint","disconnect","_this$blockchain","storeLarge","bucketId","file","partSize","options","parts","partsStream","pipeThrough","withChunkSize","offset","part","piece","Piece","multipartOffset","cid","storePiece","accessToken","push","MultipartPiece","totalSize","storeSmall","streamConsumers","arrayBuffer","store","info","maxBufferSize","MAX_BUFFER_SIZE","MIN_BUFFER_SIZE","Error","read","cidOrName","readPiece"],"mappings":"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"}