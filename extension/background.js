var r={ADDRESS:"proofi_address",EMAIL:"proofi_email",TOKEN:"proofi_token",CONNECTED:"proofi_connected"},h="https://proofi-api-production.up.railway.app";function i(){chrome.windows.create({url:chrome.runtime.getURL("popup.html"),type:"popup",width:400,height:600,focused:!0})}chrome.runtime.onMessage.addListener((a,l,o)=>{if(a.type==="GET_WALLET_STATE")return chrome.storage.local.get(Object.values(r),t=>{o({address:t[r.ADDRESS]||null,email:t[r.EMAIL]||null,token:t[r.TOKEN]||null,connected:t[r.CONNECTED]||!1})}),!0;if(a.type==="OPEN_LOGIN_POPUP"||a.type==="OPEN_SIGN_POPUP")return chrome.action?.openPopup?chrome.action.openPopup().then(()=>{o({ok:!0,method:"popup"})}).catch(t=>{console.warn("[Proofi] openPopup() failed, falling back to window:",t.message),i(),o({ok:!0,method:"window"})}):(i(),o({ok:!0,method:"window"})),!0;if(a.type==="API_REQUEST"){let{path:t,method:u,body:n,authHeaders:p}=a,d={"Content-Type":"application/json",...p||{}};return fetch(`${h}${t}`,{method:u||"GET",headers:d,body:n?JSON.stringify(n):void 0}).then(async e=>{let c=await e.json();e.ok?o({data:c,status:e.status}):o({error:c.error||`API error: ${e.status}`,status:e.status})}).catch(e=>{o({error:e.message,status:0})}),!0}if(a.type==="AGENT_CONNECT"){let{agentId:t,name:u,scopes:n,origin:p}=a.payload||a;return chrome.storage.local.set({proofi_pending_agent:{agentId:t,name:u,scopes:n||[],origin:p||l.origin,requestedAt:Date.now()}},()=>{chrome.windows.create({url:chrome.runtime.getURL("popup.html?view=agent-approve"),type:"popup",width:400,height:600,focused:!0}),o({ok:!0,pending:!0})}),!0}if(a.type==="APPROVE_AGENT"){let{agentId:t,name:u,scopes:n,expiresIn:p}=a.payload||a,d={agentId:t,name:u,scopes:n||[],createdAt:Date.now(),expiresAt:Date.now()+(p||86400000),active:!0};return chrome.storage.local.get({proofi_agents:[]},e=>{let c=e.proofi_agents.filter(s=>s.agentId!==t);c.push(d),chrome.storage.local.set({proofi_agents:c,proofi_pending_agent:null},()=>{o({ok:!0,session:d})})}),!0}if(a.type==="REVOKE_AGENT"){let{agentId:t}=a.payload||a;return chrome.storage.local.get({proofi_agents:[]},u=>{let n=u.proofi_agents.filter(p=>p.agentId!==t);chrome.storage.local.set({proofi_agents:n},()=>{o({ok:!0,remaining:n.length})})}),!0}if(a.type==="GET_AGENTS")return chrome.storage.local.get({proofi_agents:[]},t=>{let u=t.proofi_agents.map(n=>({...n,active:n.active&&n.expiresAt>Date.now()}));o({agents:u})}),!0;if(a.type==="AGENT_AUTH_REQUEST"){let{agentId:t}=a.payload||a;return chrome.storage.local.get({proofi_agents:[]},u=>{let n=u.proofi_agents.find(p=>p.agentId===t&&p.active&&p.expiresAt>Date.now());if(!n)return o({error:"No active session for this agent",code:"NO_SESSION"});chrome.storage.local.get([r.ADDRESS,r.TOKEN],p=>{if(!p[r.ADDRESS]||!p[r.TOKEN])return o({error:"Wallet not connected",code:"NO_WALLET"});o({ok:!0,address:p[r.ADDRESS],token:p[r.TOKEN],scopes:n.scopes,expiresAt:n.expiresAt})})}),!0}if(a.type==="AGENT_PROOF_REQUEST"){let{agentId:t,fields:u}=a.payload||a;return chrome.storage.local.get({proofi_agents:[]},n=>{let p=n.proofi_agents.find(d=>d.agentId===t&&d.active&&d.expiresAt>Date.now());if(!p)return o({error:"No active session for this agent",code:"NO_SESSION"});let e=u.filter(d=>p.scopes.includes(d));if(e.length===0)return o({error:"No permitted fields in request",code:"SCOPE_DENIED"});let c={};chrome.storage.local.get(e.map(d=>`proofi_${d}`),d=>{for(let s of e)c[s]=d[`proofi_${s}`]||null;o({ok:!0,proof:c,disclosed:Object.keys(c).filter(s=>c[s]!==null)})})}),!0}});

// --- Agent external message listener (web pages â†’ extension) ---
chrome.runtime.onMessageExternal.addListener((a,l,o)=>{let allowed=["AGENT_CONNECT","AGENT_AUTH_REQUEST","AGENT_PROOF_REQUEST"];if(!allowed.includes(a.type)){o({error:"Unknown message type",code:"INVALID_TYPE"});return}chrome.runtime.sendMessage(a,o);return!0});
