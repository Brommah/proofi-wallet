var p={ADDRESS:"proofi_address",EMAIL:"proofi_email",TOKEN:"proofi_token",CONNECTED:"proofi_connected"},h="https://proofi-api-production.up.railway.app";function u(){chrome.windows.create({url:chrome.runtime.getURL("popup.html"),type:"popup",width:400,height:600,focused:!0})}chrome.runtime.onMessage.addListener((t,l,r)=>{if(t.type==="GET_WALLET_STATE")return chrome.storage.local.get(Object.values(p),o=>{r({address:o[p.ADDRESS]||null,email:o[p.EMAIL]||null,token:o[p.TOKEN]||null,connected:o[p.CONNECTED]||!1})}),!0;if(t.type==="OPEN_LOGIN_POPUP"||t.type==="OPEN_SIGN_POPUP")return chrome.action?.openPopup?chrome.action.openPopup().then(()=>{r({ok:!0,method:"popup"})}).catch(o=>{console.warn("[Proofi] openPopup() failed, falling back to window:",o.message),u(),r({ok:!0,method:"window"})}):(u(),r({ok:!0,method:"window"})),!0;if(t.type==="API_REQUEST"){let{path:o,method:e,body:a,authHeaders:i}=t,n={"Content-Type":"application/json",...i||{}};return fetch(`${h}${o}`,{method:e||"GET",headers:n,body:a?JSON.stringify(a):void 0}).then(async c=>{let d=await c.json();c.ok?r({data:d,status:c.status}):r({error:d.error||`API error: ${c.status}`,status:c.status})}).catch(c=>{r({error:c.message,status:0})}),!0}if(t.type==="HEALTH_DATA_TO_DDC"){let{encryptedData:o,cid:e}=t.payload||t;return chrome.storage.local.get([p.TOKEN,p.ADDRESS],async a=>{let i={"Content-Type":"application/json",Authorization:a[p.TOKEN]?`Bearer ${a[p.TOKEN]}`:void 0};try{let n=await fetch(`${h}/ddc/memo`,{method:"POST",headers:i,body:JSON.stringify({type:"encrypted-health-data",content:o,metadata:{predictedCid:e,encryptionAlgorithm:o.algorithm||"AES-256-GCM",uploadedAt:new Date().toISOString()}})});if(!n.ok){let d=await n.json();r({error:d.error||`Upload failed: ${n.status}`});return}let c=await n.json();r({ok:!0,cid:c.cid||e,bucket:c.bucket||"1229",cdnUrl:c.cdnUrl})}catch(n){r({error:n.message})}}),!0}if(t.type==="AGENT_CONNECT"){let{agentId:o,name:e,scopes:a,dataTypes:i,origin:n}=t.payload||t;return chrome.storage.local.set({proofi_pending_agent:{agentId:o||`agent-${Date.now()}`,name:e||"Unknown Agent",scopes:a||i||[],origin:n||l.origin||l.url,requestedAt:Date.now()}},()=>{chrome.windows.create({url:chrome.runtime.getURL("popup.html?view=agent-approve"),type:"popup",width:400,height:600,focused:!0}),r({ok:!0,pending:!0})}),!0}if(t.type==="APPROVE_AGENT"){let{agentId:o,name:e,scopes:a,expiresIn:i}=t.payload||t,n={agentId:o,name:e,scopes:a||[],createdAt:Date.now(),expiresAt:Date.now()+(i||864e5),active:!0};return chrome.storage.local.get({proofi_agents:[]},c=>{let d=c.proofi_agents.filter(_=>_.agentId!==o);d.push(n),chrome.storage.local.set({proofi_agents:d,proofi_pending_agent:null},()=>{r({ok:!0,session:n})})}),!0}if(t.type==="REVOKE_AGENT"){let{agentId:o}=t.payload||t;return chrome.storage.local.get({proofi_agents:[]},e=>{let a=e.proofi_agents.filter(i=>i.agentId!==o);chrome.storage.local.set({proofi_agents:a},()=>{r({ok:!0,remaining:a.length})})}),!0}if(t.type==="GET_AGENTS")return chrome.storage.local.get({proofi_agents:[]},o=>{let e=o.proofi_agents.map(a=>({...a,active:a.active&&a.expiresAt>Date.now()}));r({agents:e})}),!0;if(t.type==="AGENT_AUTH_REQUEST"){let{agentId:o}=t.payload||t;return chrome.storage.local.get({proofi_agents:[],proofi_health_cid:null,proofi_health_bucket:null},e=>{let a=e.proofi_agents.find(i=>i.agentId===o&&i.active&&i.expiresAt>Date.now());if(!a){r({error:"No active session for this agent",code:"NO_SESSION"});return}chrome.storage.local.get([p.ADDRESS,p.TOKEN,"proofi_health_dek"],i=>{if(!i[p.ADDRESS]){r({error:"Wallet not connected",code:"NO_WALLET"});return}r({ok:!0,address:i[p.ADDRESS],scopes:a.scopes,expiresAt:a.expiresAt,healthDataCID:e.proofi_health_cid,bucketId:e.proofi_health_bucket||"1229"})})}),!0}if(t.type==="GET_HEALTH_DATA_ACCESS"){let{agentId:o}=t.payload||t;return chrome.storage.local.get({proofi_agents:[],proofi_health_cid:null,proofi_health_bucket:null,proofi_health_dek:null},e=>{let a=e.proofi_agents.find(i=>i.agentId===o&&i.active&&i.expiresAt>Date.now());if(!a){r({error:"Access denied",code:"NO_SESSION"});return}if(!e.proofi_health_cid){r({error:"No health data available",code:"NO_DATA"});return}r({ok:!0,cid:e.proofi_health_cid,bucket:e.proofi_health_bucket||"1229",scopes:a.scopes,cdnUrl:`https://cdn.ddc-dragon.com/${e.proofi_health_bucket||"1229"}/${e.proofi_health_cid}`,wrappedDEK:e.proofi_health_dek})}),!0}});chrome.runtime.onMessageExternal.addListener((t,l,r)=>{if(!["AGENT_CONNECT","AGENT_AUTH_REQUEST","GET_HEALTH_DATA_ACCESS","GET_WALLET_STATE"].includes(t.type)){r({error:"Unknown message type",code:"INVALID_TYPE"});return}return t.origin=l.origin||l.url,chrome.runtime.sendMessage(t,r),!0});
